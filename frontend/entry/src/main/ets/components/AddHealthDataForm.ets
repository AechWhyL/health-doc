import { Binding, promptAction, UIUtils } from '@kit.ArkUI';
import { httpRequest } from '../common/api/HttpUtil';
import { RequestEnum } from '../common/api/httpEnum';
import { picker, fileIo as fs } from '@kit.CoreFileKit';
import { FormData } from '@ohos/axios';
import { JSON } from '@kit.ArkTS';

interface ApiResponse<T = Object> {
  code: number;
  message: string;
  data?: T;
}

interface HealthDataRequest {
  elder_id: number;
  measured_at: string;
  sbp: number;
  dbp: number;
  fpg: number;
  ppg_2h: number;
  weight: number;
  source: string;
  remark?: string;
}

interface HealthDataResponse {
  id: number;
  elder_id: number;
  measured_at: string;
  sbp: number;
  dbp: number;
  fpg: number;
  ppg_2h: number;
  weight: number;
}

interface SmartRecognitionResponse {
  sbp?: number;
  dbp?: number;
  fpg?: number;
  ppg_2h?: number;
  weight?: number;
}

@Component
export struct AddHealthDataForm {
  @Prop elderId: number = 0;
  @Prop elderName: string = '';
  @State sbp: string = '';
  @State dbp: string = '';
  @State fpg: string = '';
  @State ppg2h: string = '';
  @State weight: string = '';
  @State remark: string = '';
  @State isSubmitting: boolean = false;
  onSuccess: () => void = () => {};
  onCancel: () => void = () => {};

  private validateForm(): boolean {
    if (!this.sbp || isNaN(parseFloat(this.sbp))) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ”¶ç¼©å‹' });
      return false;
    }
    if (!this.dbp || isNaN(parseFloat(this.dbp))) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„èˆ’å¼ å‹' });
      return false;
    }
    if (!this.fpg || isNaN(parseFloat(this.fpg))) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç©ºè…¹è¡€ç³–' });
      return false;
    }
    if (!this.ppg2h || isNaN(parseFloat(this.ppg2h))) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é¤åè¡€ç³–' });
      return false;
    }
    if (!this.weight || isNaN(parseFloat(this.weight))) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„ä½“é‡' });
      return false;
    }
    return true;
  }

  @State isRecognizing: boolean = false;

  private async handleSmartRecognition() {
    try {
      const photoPicker = new picker.PhotoViewPicker();
      const result = await photoPicker.select({
        MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 1
      });

      if (!result.photoUris || result.photoUris.length === 0) {
        return;
      }

      this.isRecognizing = true;
      const uri = result.photoUris[0];
      
      // è¯»å–æ–‡ä»¶
      const file = fs.openSync(uri, fs.OpenMode.READ_ONLY);
      const stat = fs.statSync(file.fd);
      const buffer = new ArrayBuffer(stat.size);
      fs.readSync(file.fd, buffer);
      fs.closeSync(file);

      // æ„å»º FormData
      const formData = new FormData();
      formData.append('file', buffer, { filename: 'upload.jpg', type: 'image/jpeg' });

      promptAction.showToast({ message: 'æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...' });

      const response = await httpRequest<ApiResponse<SmartRecognitionResponse>, FormData>({
        url: '/api/v1/elder-health/daily-health/smart-recognition',
        method: RequestEnum.POST,
        params: formData,
        contentType: 'multipart/form-data'
      });

      if (response.code === 200 && response.data) {
        const data = response.data;
        let msg = 'è¯†åˆ«æˆåŠŸ';
        console.log("[ai health data recognize] è¯†åˆ«æˆåŠŸï¼š" + JSON.stringify(data))
        
        if (data.sbp) this.sbp = String(data.sbp);
        if (data.dbp) this.dbp = String(data.dbp);
        if (data.fpg) this.fpg = String(data.fpg);
        if (data.ppg_2h) this.ppg2h = String(data.ppg_2h);
        if (data.weight) this.weight = String(data.weight);
        
        promptAction.showToast({ message: msg });
      } else {
        promptAction.showToast({ message: response.message || 'è¯†åˆ«å¤±è´¥' });
      }
    } catch (error) {
      console.error('æ™ºèƒ½è¯†åˆ«å¤±è´¥:', error);
      promptAction.showToast({ message: 'è¯†åˆ«å‡ºé”™ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isRecognizing = false;
    }
  }

  private async submitForm(): Promise<void> {
    if (!this.validateForm()) return;

    this.isSubmitting = true;
    try {
      const now = new Date().toISOString();
      const data: HealthDataRequest = {
        elder_id: this.elderId,
        measured_at: now,
        sbp: parseFloat(this.sbp),
        dbp: parseFloat(this.dbp),
        fpg: parseFloat(this.fpg),
        ppg_2h: parseFloat(this.ppg2h),
        weight: parseFloat(this.weight),
        source: 'MANUAL',
        remark: this.remark || undefined
      };

      const response = await httpRequest<ApiResponse<HealthDataResponse>, HealthDataRequest>({
        url: '/api/v1/elder-health/daily-health',
        method: RequestEnum.POST,
        params: data,
      });

      if (response.code === 200 || response.code === 201) {
        promptAction.showToast({ message: 'å¥åº·æ•°æ®æ·»åŠ æˆåŠŸ' });
        this.clearForm();
        this.onSuccess();
      } else {
        promptAction.showToast({ message: response.message || 'æ·»åŠ å¤±è´¥' });
      }
    } catch (error) {
      console.error('æ·»åŠ å¥åº·æ•°æ®å¤±è´¥:', error);
      promptAction.showToast({ message: 'æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isSubmitting = false;
    }
  }

  private clearForm(): void {
    this.sbp = '';
    this.dbp = '';
    this.fpg = '';
    this.ppg2h = '';
    this.weight = '';
    this.remark = '';
  }

  @Builder
  private SectionTitle(icon: string, title: string) {
    Row() {
      Text(icon).fontSize(18)
      Text(title)
        .fontSize(15)
        .fontWeight(FontWeight.Medium)
        .fontColor('#1e293b')
        .margin({ left: 8 })
    }
    .width('100%')
    .margin({ top: 20, bottom: 12 })
  }

  @Builder
  private InputField(label: string, placeholder: string, value: Binding<string>, unit: string, onChange: (v: string) => void) {
    Row() {
      Text(label)
        .fontSize(14)
        .fontColor('#64748b')
        .width(80)
      TextInput({ text: value.value, placeholder: placeholder })
        .height(44)
        .fontSize(15)
        .backgroundColor('#f8fafc')
        .borderRadius(10)
        .layoutWeight(1)
        .type(InputType.NUMBER_DECIMAL)
        .onChange(onChange)
      Text(unit)
        .fontSize(13)
        .fontColor('#94a3b8')
        .width(50)
        .textAlign(TextAlign.End)
    }
    .width('100%')
    .margin({ bottom: 12 })
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('âœ•')
          .fontSize(20)
          .fontColor('#64748b')
          .onClick(() => { this.onCancel(); })
        Text('æ·»åŠ å¥åº·æ•°æ®')
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1e293b')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        Text('').width(20)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#e5e7eb' })

      Scroll() {
        Column() {
          // è€äººä¿¡æ¯
          Row() {
            Text('ğŸ‘´').fontSize(24)
            Column() {
              Text('æ•°æ®å½’å±').fontSize(12).fontColor('#64748b')
              Text(this.elderName || `è€äººID: ${this.elderId}`)
                .fontSize(15)
                .fontWeight(FontWeight.Medium)
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ left: 12 })
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#f8fafc')
          .borderRadius(12)

          // æ™ºèƒ½è¯†åˆ«å…¥å£
          Row() {
            Button() {
              Row() {
                Text(this.isRecognizing ? 'â³' : 'ğŸ“¸').fontSize(16).fontColor('#ffffff').margin({ right: 6 })
                Text(this.isRecognizing ? 'è¯†åˆ«ä¸­...' : 'æ‹ç…§/ä¸Šä¼  æ™ºèƒ½è¯†åˆ«å¥åº·æ•°æ®')
                  .fontSize(14).fontColor('#ffffff')
              }
            }
            .type(ButtonType.Normal)
            .borderRadius(8)
            .backgroundColor('#10b981') // Green color for distinction
            .width('100%')
            .height(44)
            .onClick(() => {
              if (!this.isRecognizing) {
                this.handleSmartRecognition();
              }
            })
          }
          .width('100%')
          .margin({ top: 16 })

          // è¡€å‹
          this.SectionTitle('ğŸ’“', 'è¡€å‹')
          this.InputField('æ”¶ç¼©å‹', 'å¦‚ 120', UIUtils.makeBinding(()=>this.sbp), 'mmHg', (v: string) => { this.sbp = v; })
          this.InputField('èˆ’å¼ å‹', 'å¦‚ 80', UIUtils.makeBinding(()=>this.dbp), 'mmHg', (v: string) => { this.dbp = v; })

          // è¡€ç³–
          this.SectionTitle('ğŸ©¸', 'è¡€ç³–')
          this.InputField('ç©ºè…¹è¡€ç³–', 'å¦‚ 5.6', UIUtils.makeBinding(()=>this.fpg), 'mmol/L', (v: string) => { this.fpg = v; })
          this.InputField('é¤åè¡€ç³–', 'å¦‚ 7.8', UIUtils.makeBinding(()=>this.ppg2h), 'mmol/L', (v: string) => { this.ppg2h = v; })

          // ä½“é‡
          this.SectionTitle('âš–ï¸', 'ä½“é‡')
          this.InputField('ä½“é‡', 'å¦‚ 65.5', UIUtils.makeBinding(()=>this.weight), 'kg', (v: string) => { this.weight = v; })

          // å¤‡æ³¨
          this.SectionTitle('ğŸ“', 'å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰')
          TextArea({ text: this.remark, placeholder: 'å¯å¡«å†™ç‰¹æ®Šæƒ…å†µè¯´æ˜...' })
            .height(80)
            .fontSize(14)
            .backgroundColor('#f8fafc')
            .borderRadius(10)
            .onChange((v: string) => { this.remark = v; })

          // æäº¤æŒ‰é’®
          Button(this.isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤æ•°æ®')
            .type(ButtonType.Capsule)
            .backgroundColor('#2563eb')
            .width('100%')
            .height(48)
            .margin({ top: 30, bottom: 30 })
            .enabled(!this.isSubmitting)
            .onClick(() => { this.submitForm(); })
        }
        .width('100%')
        .padding({ left: 20, right: 20 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#ffffff')
  }
}
