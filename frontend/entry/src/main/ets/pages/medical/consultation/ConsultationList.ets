import { ConsultationService } from '../../../common/api/ConsultationService';
import { ConsultationQuestion } from '../../../models/ConsultationModels';
import { SectionHeader } from '../../../components/common/SectionHeader';
import { EmptyState } from '../../../components/common/EmptyState';

@Component
export struct ConsultationList {
  @Consume('navPathStack') navPathStack: NavPathStack;
  @State questions: ConsultationQuestion[] = [];
  @State isLoading: boolean = false;

  aboutToAppear() {
    this.fetchQuestions();
  }

  async fetchQuestions() {
    this.isLoading = true;
    try {
      const response = await ConsultationService.getQuestionList({});
      if (response.code === 200) {
        this.questions = response.data.items;
      }
    } catch (error) {
      console.error('Failed to fetch questions:', error);
    } finally {
      this.isLoading = false;
    }
  }

  private getCreatorTypeText(creatorType: string): string {
    switch (creatorType) {
      case 'ELDER':
        return 'è€äºº';
      case 'FAMILY':
        return 'å®¶å±ž';
      case 'STAFF':
        return 'åŒ»æŠ¤';
      default:
        return '';
    }
  }

  @Builder
  private buildQuestionCard(item: ConsultationQuestion) {
    Column() {
      Row() {
        // å·¦ä¾§å›¾æ ‡
        Text('ðŸ’¬')
          .fontSize(28)
          .margin({ right: 14 })

        // ä¸­é—´å†…å®¹
        Column() {
          Row() {
            Text(item.title)
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor('#1e293b')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)
          }

          Row({ space: 8 }) {
            // åˆ›å»ºè€…ä¿¡æ¯

            Text(`æ¥è‡ª${this.getCreatorTypeText(item.creator_type)}`)
              .fontSize(12)
              .fontColor('#64748b')
            Divider().vertical(true).height(20)
            Text(`${item.creator_summary?.name || "åŒ¿å"}`)
              .fontSize(12)
              .fontColor('#64748b')


            // ä¼˜å…ˆçº§
            if (item.priority === 'URGENT') {
              Text('ç´§æ€¥')
                .fontSize(11)
                .fontColor('#dc2626')
                .padding({
                  left: 6,
                  right: 6,
                  top: 2,
                  bottom: 2
                })
                .backgroundColor('#fef2f2')
                .borderRadius(4)
            }
          }
          .margin({ top: 6 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // å³ä¾§æ“ä½œæŒ‰é’® - ç»Ÿä¸€ä¸º"å›žå¤"
        Text('å›žå¤')
          .fontSize(12)
          .fontColor('#2563eb')
          .backgroundColor('#eff6ff')
          .padding({
            left: 10,
            right: 10,
            top: 6,
            bottom: 6
          })
          .borderRadius(14)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(14)
    .shadow({ radius: 4, color: '#0f172a0a', offsetY: 1 })
    .margin({ bottom: 12 })
    .onClick(() => {
      this.navPathStack.pushPath({
        name: 'Medical_ConsultationTab_ChatPage',
        param: item as Object
      });
    })
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      SectionHeader({
        title: 'å’¨è¯¢åˆ—è¡¨',
        subtitle: `å…± ${this.questions.length} æ¡å’¨è¯¢`
      })

      // å†…å®¹åŒº
      if (this.isLoading && this.questions.length === 0) {
        Column() {
          LoadingProgress().width(32).height(32).color('#2563eb')
          Text('åŠ è½½ä¸­...')
            .fontSize(13)
            .fontColor('#64748b')
            .margin({ top: 8 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else if (this.questions.length === 0) {
        EmptyState({
          icon: 'ðŸ’¬',
          title: 'æš‚æ— å’¨è¯¢',
          subtitle: 'å½“å‰æ²¡æœ‰å¾…å¤„ç†çš„å’¨è¯¢é—®é¢˜'
        })
      } else {
        Scroll() {
          Column() {
            ForEach(this.questions, (item: ConsultationQuestion) => {
              this.buildQuestionCard(item)
            }, (item: ConsultationQuestion) => item.id.toString())
          }
          .constraintSize({
            minHeight:"100%"
          })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .padding(16)
    .backgroundColor('#f8fafc')
  }
}
