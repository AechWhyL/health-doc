import { promptAction } from '@kit.ArkUI';
import { httpRequest } from '../../../common/api/HttpUtil';
import { RequestEnum } from '../../../common/api/httpEnum';
import { SectionHeader } from '../../../components/common/SectionHeader';
import { StatCard } from '../../../components/common/StatCard';
import { EmptyState } from '../../../components/common/EmptyState';
import { CardContainer } from '../../../components/common/CardContainer';

interface ApiResponse<T = Object> {
  code: number;
  message: string;
  data?: T;
  timestamp: number;
}

interface ElderResponse {
  id: number;
  name: string;
  gender: number;
  birth_date: string;
  phone: string;
  address: string | null;
  emergency_contact: string;
  height: number | null;
  weight: number | null;
  blood_type: string | null;
  age: number;
  created_at: string;
  updated_at: string;
}

interface UserElderRelationItem {
  relation_id: number;
  elder_id: number;
  relation_name: string | null;
  remark: string | null;
  elder: ElderResponse;
}

interface MyEldersQueryParams {
  page: number;
  pageSize: number;
  elder_name?: string;
}

interface MyEldersListData {
  items: UserElderRelationItem[];
  total: number;
}

interface AddMyElderRequest {
  elder_id: number;
  relation_name?: string;
  remark?: string;
}

interface ElderListQueryParams {
  phone?: string;
  page: number;
  pageSize: number;
  name?: string;
}

interface ElderListPageData {
  items: ElderResponse[];
  total: number;
  pages: number;
  current: number;
  size: number;
}

interface HealthJudgment {
  bp_level?: string;
  fpg_level?: string;
}

interface HealthMeasurement {
  id: number;
  sbp?: number;
  dbp?: number;
  fpg?: number;
  judgment?: HealthJudgment;
}

interface HealthMeasurementListData {
  records: HealthMeasurement[];
  total: number;
}

interface HealthDataQueryParams {
  elder_id: number;
  page: number;
  pageSize: number;
  include_judgment: boolean;
}

// æ–°APIè¿”å›çš„å¥åº·æ‘˜è¦
interface HealthSummary {
  latest_bp?: string;
  latest_fpg?: string;
  bp_level?: string;
  fpg_level?: string;
}

// æ–°APIè¿”å›çš„è€äººå…³ç³»é¡¹ï¼ˆåŒ…å«å¥åº·æ‘˜è¦ï¼‰
interface UserElderWithHealthItem extends UserElderRelationItem {
  health_summary?: HealthSummary;
}

// æ–°APIè¿”å›æ•°æ®ç»“æ„
interface EldersWithHealthListData {
  records: UserElderWithHealthItem[];
  total: number;
  abnormal_count: number;
}

// æ‰©å±•çš„è€äººå…³ç³»ï¼ŒåŒ…å«å¥åº·æ‘˜è¦
interface ElderWithHealth {
  relation: UserElderRelationItem;
  latestBp?: string;
  latestFpg?: string;
  bpStatus?: string;
  fpgStatus?: string;
}

interface buildElderCardParams {
  item:ElderWithHealth
}

@Builder
export function DocTabBuilder(){
  DocTab()
}

@Component
export struct DocTab {
  @State private eldersWithHealth: ElderWithHealth[] = []
  @State private isLoadingElders: boolean = false
  @State private elderError: string = ''
  @State private searchKeyword: string = ''
  @State private isSearchingByPhone: boolean = false
  @State private phoneSearchResult: ElderResponse | null = null
  @State private isAddingRelation: boolean = false
  @State private showAddPanel: boolean = false
  @State private abnormalCount: number = 0
  @Consume('navPathStack') navPathStack: NavPathStack;

  aboutToAppear(): void {
    this.loadElders(true)
  }

  private async loadElders(reset: boolean = false): Promise<void> {
    if (this.isLoadingElders) {
      return
    }

    this.isLoadingElders = true
    if (reset) {
      this.eldersWithHealth = []
    }

    try {
      const params: MyEldersQueryParams = {
        page: 1,
        pageSize: 50
      }

      // ä½¿ç”¨æ–°çš„åˆå¹¶æ¥å£ï¼Œä¸€æ¬¡æ€§è·å–è€äººåˆ—è¡¨å’Œå¥åº·æ•°æ®
      const response = await httpRequest<ApiResponse<EldersWithHealthListData>, MyEldersQueryParams>({
        url: '/api/v1/users/me/elders-with-health',
        method: RequestEnum.GET,
        token: 'auth',
        params
      })

      if (response.code !== 200 || !response.data) {
        const msg = response.message || 'è·å–å…³è”è€äººå¤±è´¥'
        this.elderError = msg
        return
      }

      const listData = response.data
      const elders = listData && listData.records ? listData.records : []

      // ç›´æ¥ä»å“åº”ä¸­è§£æå¥åº·æ•°æ®ï¼Œæ— éœ€é¢å¤–è¯·æ±‚
      this.eldersWithHealth = elders.map((e: UserElderWithHealthItem) => {
        const item: ElderWithHealth = {
          relation: e,
          latestBp: e.health_summary?.latest_bp,
          latestFpg: e.health_summary?.latest_fpg,
          bpStatus: e.health_summary?.bp_level,
          fpgStatus: e.health_summary?.fpg_level
        }
        return item
      })
      this.abnormalCount = listData.abnormal_count || 0
      this.elderError = ''
    } catch (error) {
      this.elderError = 'ç½‘ç»œå¼‚å¸¸'
    } finally {
      this.isLoadingElders = false
    }
  }



  private isElderLinked(elderId: number): boolean {
    return this.eldersWithHealth.some((item: ElderWithHealth) => item.relation.elder_id === elderId)
  }

  private async searchElderByPhone(): Promise<void> {
    if (this.isSearchingByPhone) {
      return
    }
    const value = this.searchKeyword.trim()
    if (value === '') {
      return
    }
    if (!/^\d{11}$/.test(value)) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥11ä½æ‰‹æœºå·æœç´¢è€äºº' })
      return
    }

    this.isSearchingByPhone = true
    this.phoneSearchResult = null

    try {
      let params: ElderListQueryParams = {
        page: 1,
        pageSize: 1,
        phone: value
      }

      const response = await httpRequest<ApiResponse<ElderListPageData>, ElderListQueryParams>({
        url: '/api/v1/elder-health/elder/list',
        method: RequestEnum.GET,
        token: 'auth',
        params
      })

      if (response.code !== 200 || !response.data) {
        promptAction.showToast({ message: 'æœªæ‰¾åˆ°è¯¥æ‰‹æœºå·å¯¹åº”çš„è€äºº' })
        return
      }

      const pageData = response.data
      const records = pageData && pageData.items ? pageData.items : []
      if (records.length === 0) {
        promptAction.showToast({ message: 'æœªæ‰¾åˆ°è¯¥æ‰‹æœºå·å¯¹åº”çš„è€äºº' })
        return
      }

      this.phoneSearchResult = records[0]
      this.showAddPanel = true
    } catch (error) {
      promptAction.showToast({ message: 'æœç´¢å¤±è´¥' })
    } finally {
      this.isSearchingByPhone = false
    }
  }

  private async addElderRelation(): Promise<void> {
    if (this.isAddingRelation || !this.phoneSearchResult) {
      return
    }
    if (this.isElderLinked(this.phoneSearchResult.id)) {
      promptAction.showToast({ message: 'è¯¥è€äººå·²å…³è”' })
      return
    }

    this.isAddingRelation = true

    try {
      const body: AddMyElderRequest = {
        elder_id: this.phoneSearchResult.id
      }

      const response = await httpRequest<ApiResponse<null>, AddMyElderRequest>({
        url: '/api/v1/users/me/elders',
        method: RequestEnum.POST,
        token: 'auth',
        params: body
      })

      if (response.code !== 200) {
        promptAction.showToast({ message: response.message || 'å…³è”å¤±è´¥' })
        return
      }

      promptAction.showToast({ message: 'å…³è”æˆåŠŸ' })
      this.showAddPanel = false
      this.phoneSearchResult = null
      this.loadElders(true)
    } catch (error) {
      promptAction.showToast({ message: 'ç½‘ç»œå¼‚å¸¸' })
    } finally {
      this.isAddingRelation = false
    }
  }

  private openElderArchiveDetail(elder: ElderResponse): void {
    this.navPathStack.pushPath({
      name: 'Medical_DocTab_ElderArchive',
      param: elder
    })
  }

  private getGenderEmoji(gender: number): string {
    return gender === 1 ? 'ğŸ‘´' : 'ğŸ‘µ'
  }

  private getStatusColor(status?: string): string {
    switch (status) {
      case 'NORMAL': return '#16a34a'
      case 'MILD': return '#ca8a04'
      case 'MODERATE': return '#ea580c'
      case 'SEVERE': return '#dc2626'
      default: return '#64748b'
    }
  }

  private getStatusBgColor(status?: string): string {
    switch (status) {
      case 'NORMAL': return '#f0fdf4'
      case 'MILD': return '#fefce8'
      case 'MODERATE': return '#fff7ed'
      case 'SEVERE': return '#fef2f2'
      default: return '#f1f5f9'
    }
  }

  @Builder
  private buildSearchBar() {
    Row() {
      Row() {
        Text('ğŸ”')
          .fontSize(16)
          .margin({ right: 8 })
        TextInput({ text: this.searchKeyword, placeholder: 'æœç´¢å§“åæˆ–æ‰‹æœºå·...' })
          .height(40)
          .fontSize(14)
          .backgroundColor(Color.Transparent)
          .layoutWeight(1)
          .onChange((value: string) => {
            this.searchKeyword = value
          })
          .onSubmit(() => {
            this.searchElderByPhone()
          })
      }
      .layoutWeight(1)
      .padding({ left: 12, right: 12 })
      .backgroundColor('#f1f5f9')
      .borderRadius(20)

      Button(this.isSearchingByPhone ? '...' : 'æœç´¢')
        .type(ButtonType.Capsule)
        .height(40)
        .width(64)
        .fontSize(14)
        .backgroundColor('#2563eb')
        .margin({ left: 10 })
        .onClick(() => {
          this.searchElderByPhone()
        })
    }
    .width('100%')
    .padding({ bottom: 12 })
  }

  @Builder
  private buildStatsBar() {
    Row({ space: 12 }) {
      StatCard({
        value: this.eldersWithHealth.length.toString(),
        label: 'å…³è”è€äºº',
        icon: 'ğŸ‘¥',
        color: '#2563eb',
        bgColor: '#eff6ff'
      })

      StatCard({
        value: this.abnormalCount.toString(),
        label: 'å¼‚å¸¸æŒ‡æ ‡',
        icon: 'âš ï¸',
        color: this.abnormalCount > 0 ? '#dc2626' : '#16a34a',
        bgColor: this.abnormalCount > 0 ? '#fef2f2' : '#f0fdf4'
      })
    }
    .width('100%')
    .margin({ bottom: 16 })
  }

  @Builder
  private buildAddPanel() {
    if (this.showAddPanel) {
      CardContainer({ title: 'æ·»åŠ è€äºº' }) {
        Column() {
          if (this.phoneSearchResult) {
            Row() {
              Text(this.getGenderEmoji(this.phoneSearchResult.gender))
                .fontSize(32)
                .margin({ right: 12 })
              Column() {
                Text(this.phoneSearchResult.name)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                Text(`${this.phoneSearchResult.age}å² Â· ${this.phoneSearchResult.phone}`)
                  .fontSize(13)
                  .fontColor('#64748b')
                  .margin({ top: 2 })
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
            }
            .width('100%')
            .margin({ bottom: 12 })

            if (this.isElderLinked(this.phoneSearchResult.id)) {
              Text('âœ“ å·²å…³è”')
                .fontSize(14)
                .fontColor('#16a34a')
            } else {
              Button(this.isAddingRelation ? 'æ·»åŠ ä¸­...' : 'ç¡®è®¤æ·»åŠ ')
                .type(ButtonType.Capsule)
                .width('100%')
                .height(40)
                .backgroundColor('#2563eb')
                .onClick(() => {
                  this.addElderRelation()
                })
            }
          } else {
            Text('è¯·åœ¨ä¸Šæ–¹æœç´¢æ è¾“å…¥è€äººæ‰‹æœºå·æœç´¢')
              .fontSize(13)
              .fontColor('#9ca3af')
          }
        }
      }
    }
  }

  @Builder
  private buildElderCard(params: buildElderCardParams) {
    Column() {
      Row() {
        Text(this.getGenderEmoji(params.item.relation.elder.gender))
          .fontSize(36)
          .margin({ right: 14 })

        Column() {
          Row() {
            Text(params.item.relation.elder.name)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1e293b')
            Text(`${params.item.relation.elder.age}å²`)
              .fontSize(13)
              .fontColor('#64748b')
              .margin({ left: 8 })
          }

          Text(params.item.relation.relation_name || 'å…³è”è€äºº')
            .fontSize(12)
            .fontColor('#94a3b8')
            .margin({ top: 4 })

          // å¥åº·æ‘˜è¦
          Row({ space: 8 }) {
            Row() {
              Text(`è¡€å‹: ${params.item.latestBp || '--'}`)
                .fontSize(11)
                .fontColor(this.getStatusColor(params.item.bpStatus))
            }
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .backgroundColor(this.getStatusBgColor(params.item.bpStatus))
            .borderRadius(4)

            Row() {
              Text(`è¡€ç³–: ${params.item.latestFpg || '--'}`)
                .fontSize(11)
                .fontColor(this.getStatusColor(params.item.fpgStatus))
            }
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .backgroundColor(this.getStatusBgColor(params.item.fpgStatus))
            .borderRadius(4)
          }
          .margin({ top: 8 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Text('â€º')
          .fontSize(24)
          .fontColor('#cbd5e1')
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(14)
    .shadow({ radius: 4, color: '#0f172a0a', offsetY: 1 })
    .margin({ bottom: 12 })
    .onClick(() => {
      this.openElderArchiveDetail(params.item.relation.elder)
    })
  }

  build() {
    Column() {
      // æœç´¢æ 
      this.buildSearchBar()

      // ç»Ÿè®¡æ 
      this.buildStatsBar()

      // æ·»åŠ é¢æ¿
      this.buildAddPanel()

      // è€äººåˆ—è¡¨
      SectionHeader({
        title: 'å·²å…³è”çš„è€äºº',
        subtitle: `å…± ${this.eldersWithHealth.length} ä½`
      })

      if (this.isLoadingElders && this.eldersWithHealth.length === 0) {
        Column() {
          LoadingProgress().width(32).height(32).color('#2563eb')
          Text('åŠ è½½ä¸­...')
            .fontSize(13)
            .fontColor('#64748b')
            .margin({ top: 8 })
        }
        .width('100%')
        .padding(40)
        .alignItems(HorizontalAlign.Center)
      } else if (this.elderError) {
        EmptyState({
          icon: 'âŒ',
          title: 'åŠ è½½å¤±è´¥',
          subtitle: this.elderError,
          actionText: 'é‡è¯•',
          onAction: () => {
            this.loadElders(true)
          }
        })
      } else if (this.eldersWithHealth.length === 0) {
        EmptyState({
          icon: 'ğŸ‘¥',
          title: 'æš‚æ— å…³è”è€äºº',
          subtitle: 'é€šè¿‡æ‰‹æœºå·æœç´¢æ·»åŠ è€äºº',
          actionText: ''
        })
      } else {
        Scroll() {
          Column() {
            ForEach(this.eldersWithHealth, (item: ElderWithHealth) => {
              // this.buildElderCard({item})
              Column() {
                Row() {
                  Text(this.getGenderEmoji(item.relation.elder.gender))
                    .fontSize(36)
                    .margin({ right: 14 })

                  Column() {
                    Row() {
                      Text(item.relation.elder.name)
                        .fontSize(16)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#1e293b')
                      Text(`${item.relation.elder.age}å²`)
                        .fontSize(13)
                        .fontColor('#64748b')
                        .margin({ left: 8 })
                    }

                    Text(item.relation.relation_name || 'å…³è”è€äºº')
                      .fontSize(12)
                      .fontColor('#94a3b8')
                      .margin({ top: 4 })

                    // å¥åº·æ‘˜è¦
                    Row({ space: 8 }) {
                      Row() {
                        Text(`è¡€å‹: ${item.latestBp || '--'}`)
                          .fontSize(11)
                          .fontColor(this.getStatusColor(item.bpStatus))
                      }
                      .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                      .backgroundColor(this.getStatusBgColor(item.bpStatus))
                      .borderRadius(4)

                      Row() {
                        Text(`è¡€ç³–: ${item.latestFpg || '--'}`)
                          .fontSize(11)
                          .fontColor(this.getStatusColor(item.fpgStatus))
                      }
                      .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                      .backgroundColor(this.getStatusBgColor(item.fpgStatus))
                      .borderRadius(4)
                    }
                    .margin({ top: 8 })
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)

                  Text('â€º')
                    .fontSize(24)
                    .fontColor('#cbd5e1')
                }
                .width('100%')
              }
              .width('100%')
              .padding(16)
              .backgroundColor(Color.White)
              .borderRadius(14)
              .shadow({ radius: 4, color: '#0f172a0a', offsetY: 1 })
              .margin({ bottom: 12 })
              .onClick(() => {
                this.openElderArchiveDetail(item.relation.elder)
              })
            }, (item: ElderWithHealth) => item.relation.relation_id.toString())
          }
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .padding(16)
    .backgroundColor('#f8fafc')
  }
}
