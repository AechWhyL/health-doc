import { DocTab } from './doc/DocTab';
import { ConsultationList } from './consultation/ConsultationList';
import { InterventionIndex } from './intervention/InterventionIndex'
import { DataTab } from './data/DataTab';
import { MineTab } from './mine/MineTab';
import { GlobalSocketManager } from '../../components/GlobalSocketManager';
import { SocketService } from '../../common/api/SocketService';
import { NotificationService, ConsultationReplyNotification, TaskCheckinNotification, TaskReminderNotification } from '../../services/NotificationService';
import { UserWithRoleResponse } from '../Login';

type CareTabKey = 'elder' | 'data' | 'plan' | 'consult' | 'mine'

@Entry
@Component
struct MedicalIndex {
  @Provide('navPathStack') navPathStack: NavPathStack = new NavPathStack();
  @State private currentTab: CareTabKey = 'elder'

  private switchTab(tab: CareTabKey): void {
    this.currentTab = tab
  }

  /**
   * WebSocket åˆå§‹åŒ–å®Œæˆåçš„å¤„ç†
   */
  private onSocketInitialized = (): void => {
    console.log('[MedicalIndex] WebSocket initialized, registering listeners');
    const socketService = SocketService.getInstance();
    
    // 1. è¯·æ±‚é€šçŸ¥æƒé™
    NotificationService.requestPermission();

    // 2. æ³¨å†Œå’¨è¯¢å›å¤é€šçŸ¥ç›‘å¬
    socketService.on<ConsultationReplyNotification>('notification:consultation_reply', (data) => {
      console.log('[MedicalIndex] Received consultation reply:', data);
      NotificationService.showConsultationReplyNotification(new ConsultationReplyNotification(data));
    });

    // 3. æ³¨å†Œä»»åŠ¡ç­¾åˆ°é€šçŸ¥ç›‘å¬ (åŒ»æŠ¤ç«¯å…³æ³¨)
    socketService.on<TaskCheckinNotification>('notification:task_checkin', (data) => {
      console.log('[MedicalIndex] Received task checkin:', data);
      NotificationService.showTaskCheckinNotification(new TaskCheckinNotification(data));
    });

    // 4. ç»‘å®šç”¨æˆ·
    const user:UserWithRoleResponse|undefined = AppStorage.get<UserWithRoleResponse>('currentUser');
    if (user) {
      socketService.bindUser(user.id);
    }
  }

  @Builder
  private buildElderTab() {
    DocTab()
  }

  @Builder
  private buildDataTab() {
    DataTab()
  }

  @Builder
  private buildPlanTab() {
    InterventionIndex()
  }

  @Builder
  private buildConsultTab() {
    ConsultationList()
  }

  @Builder
  private buildMineTab() {
     MineTab()
  }

  @Builder
  private buildBottomNavItem(tab: CareTabKey, icon: string, label: string) {
    Column() {
      Text(icon)
        .fontSize(22)
        .fontColor(this.currentTab === tab ? '#2563eb' : '#9ca3af')
      Text(label)
        .fontSize(10)
        .fontColor(this.currentTab === tab ? '#2563eb' : '#6b7280')
        .margin({ top: 2 })
    }
    .layoutWeight(1)
    .alignItems(HorizontalAlign.Center)
    .padding({ top: 4, bottom: 6 })
    .onClick(() => {
      this.switchTab(tab)
    })
  }

  @Builder
  private buildNavigationMenus() {
    Row() {
    }
  }

  build() {
    Stack() {
      // å…¨å±€ WebSocket ç®¡ç†å™¨ (éšè—è§†å›¾ï¼Œç”Ÿå‘½å‘¨æœŸéšæ­¤é¦–é¡µ)
      GlobalSocketManager({
        onInitialized: this.onSocketInitialized
      })

      Column() {
        Navigation(this.navPathStack) {
          Column() {
            if (this.currentTab === 'elder') {
              this.buildElderTab()
            } else if (this.currentTab === 'data') {
              this.buildDataTab()
            } else if (this.currentTab === 'plan') {
              this.buildPlanTab()
            } else if (this.currentTab === 'consult') {
              this.buildConsultTab()
            } else if (this.currentTab === 'mine') {
              this.buildMineTab()
            }
          }
          .layoutWeight(1)
          .backgroundColor('#f8fafc')

          Row() {
            this.buildBottomNavItem('elder', 'ğŸ“‹', 'æ¡£æ¡ˆ')
            this.buildBottomNavItem('data', 'ğŸ“Š', 'æ•°æ®')
            this.buildBottomNavItem('plan', 'ğŸ’Š', 'å¹²é¢„')
            this.buildBottomNavItem('consult', 'ğŸ’¬', 'å’¨è¯¢')
            this.buildBottomNavItem('mine', 'ğŸ‘¤', 'æˆ‘çš„')
          }
          .width('100%')
          .border({
            width: { top: 1 },
            color: '#e5e7eb'
          })
          .backgroundColor(Color.White)
          .padding({
            left: 14,
            right: 14,
            top: 8,
            bottom: 16
          })
        }
        .width("100%")
        .titleMode(NavigationTitleMode.Mini)
        .hideTitleBar(true)
        .hideBackButton(true)
        .mode(NavigationMode.Stack)
        .menus(this.buildNavigationMenus)
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }
}
