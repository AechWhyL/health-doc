import { promptAction } from '@kit.ArkUI';
import { InterventionService } from '../../../common/api/InterventionService';
import { ApiResponse } from '../../../models/DTO/types';
import {
  MyEldersListData,
  UserElderRelationItem,
  PlanTaskInstanceResponse,
  InterventionPlanResponse,
  TodayTaskStatsResponse,
  ElderTaskStats
} from '../../../models/DTO/intervention';
import { SectionHeader } from '../../../components/common/SectionHeader';
import { StatCard } from '../../../components/common/StatCard';
import { EmptyState } from '../../../components/common/EmptyState';
import { CardContainer } from '../../../components/common/CardContainer';
import { PlanFormRouteParams } from './InterventionPlanForm';

interface PlanStats {
  active: number;
  pending: number;
  total: number;
}

@Component
export struct InterventionIndex {
  @State private elders: UserElderRelationItem[] = []
  @State private isLoadingElders: boolean = false
  @State private todayStats: TodayTaskStatsResponse | null = null
  @State private isLoadingStats: boolean = false
  @State private planStats: PlanStats = { active: 0, pending: 0, total: 0 }
  @Consume('navPathStack') navPathStack: NavPathStack;

  aboutToAppear(): void {
    this.loadElders()
  }

  private async loadElders(): Promise<void> {
    this.isLoadingElders = true
    try {
      const response = await InterventionService.getMyElders(1, 100)
      if (response.code === 200 && response.data) {
        this.elders = response.data.items || []
        // åŠ è½½ä»Šæ—¥ä»»åŠ¡ç»Ÿè®¡å’Œè®¡åˆ’ç»Ÿè®¡
        this.loadTodayStats()
        this.loadPlanStats()
      }
    } catch (error) {
      console.error('Failed to load elders')
    } finally {
      this.isLoadingElders = false
    }
  }

  private async loadTodayStats(): Promise<void> {
    if (this.elders.length === 0) {
      return
    }
    this.isLoadingStats = true
    try {
      const response = await InterventionService.getTodayTaskStats()
      if (response.code === 200 && response.data) {
        this.todayStats = response.data
      }
    } catch (error) {
      console.error('Failed to load today stats', error)
    } finally {
      this.isLoadingStats = false
    }
  }

  private async loadPlanStats(): Promise<void> {
    let active = 0
    let pending = 0
    let total = 0

    try {
      // è¿™é‡Œçš„ç»Ÿè®¡é€»è¾‘è¿˜æ˜¯ä¿ç•™åŽŸæ ·ï¼Œæˆ–è€…åŽç«¯ä¹Ÿèƒ½æä¾›æ›´å¥½
      // æš‚æ—¶ä¿ç•™å‰ç«¯å¾ªçŽ¯ç»Ÿè®¡ï¼Œå› ä¸ºåªæ˜¯ plan åˆ—è¡¨ï¼Œä¸åƒ task é‚£æ · N*M
      for (const elder of this.elders) {
        const elderUserId = elder.elder_user_id ?? elder.elder_id;
        const response = await InterventionService.getPlansByElderUserId(elderUserId, {
          page: 1,
          pageSize: 100
        })
        if (response.code === 200 && response.data) {
          for (const plan of response.data.records) {
            total++
            if (plan.status === 'ACTIVE') {
              active++
            }
          }
        }
      }
      this.planStats = { active, pending, total }
    } catch (error) {
      console.error('Failed to load plan stats')
    }
  }

  private openElderPlanList(elder: UserElderRelationItem): void {
    this.navPathStack.pushPathByName(
      'Medical_Intervention_ElderPlanList',
      elder
    )
  }

  private goToCreatePlan(): void {
    if (this.elders.length === 0) {
      promptAction.showToast({ message: 'è¯·å…ˆæ·»åŠ è€äºº' })
      return
    }
    // é»˜è®¤ä¸ºç¬¬ä¸€ä¸ªè€äººåˆ›å»º
    // FIX: Use elder_user_id (user account ID) instead of elder_id (elder_basic_info.id)
    const elderUserId = this.elders[0].elder_user_id ?? this.elders[0].elder_id
    const param: PlanFormRouteParams = { elderUserId: elderUserId }
    this.navPathStack.pushPath({
      name: 'Medical_Intervention_PlanForm',
      param: param as Object
    })
  }

  @Builder
  private buildTodayTasksPanel() {
    CardContainer({ title: 'ä»Šæ—¥å¾…åŠž' }) {
      Column() {
        if (this.isLoadingStats) {
          Row() {
            LoadingProgress().width(20).height(20).color('#2563eb')
            Text('ç»Ÿè®¡ä¸­...')
              .fontSize(12)
              .fontColor('#64748b')
              .margin({ left: 8 })
          }
          .padding(12)
        } else if (this.todayStats) {
          Row() {
            Column() {
              Text(this.todayStats.completed_tasks.toString())
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#16a34a')
              Text('å·²å®Œæˆ')
                .fontSize(12)
                .fontColor('#64748b')
                .margin({ top: 4 })
            }
            .alignItems(HorizontalAlign.Center)
            .layoutWeight(1)

            Divider().vertical(true).height(30).color('#e2e8f0')

            Column() {
              Text(this.todayStats.total_tasks.toString())
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#1e293b')
              Text('ä»Šæ—¥ä»»åŠ¡æ€»æ•°')
                .fontSize(12)
                .fontColor('#64748b')
                .margin({ top: 4 })
            }
            .alignItems(HorizontalAlign.Center)
            .layoutWeight(1)
          }
          .padding({ top: 12, bottom: 12 })
          
          if (this.todayStats.total_tasks > 0) {
              Progress({ value: this.todayStats.completed_tasks, total: this.todayStats.total_tasks, type: ProgressType.Linear })
              .color('#16a34a')
              .backgroundColor('#f1f5f9')
              .height(6)
              .margin({ top: 12 })
              .width('100%')
          }
        } else {
           Text('æš‚æ— ä»»åŠ¡ç»Ÿè®¡')
            .fontSize(14)
            .fontColor('#64748b')
            .padding(12)
        }
      }
    }
  }

  @Builder
  private buildStatsBar() {
    Row({ space: 12 }) {
      StatCard({
        value: this.planStats.active.toString(),
        label: 'æ‰§è¡Œä¸­',
        color: '#16a34a',
        bgColor: '#f0fdf4'
      })

      StatCard({
        value: this.planStats.pending.toString(),
        label: 'å¾…å¼€å§‹',
        color: '#ca8a04',
        bgColor: '#fefce8'
      })


    }
    .width('100%')
    .margin({ bottom: 16 })
  }

  private getElderStats(elderId: number): ElderTaskStats | undefined {
    return this.todayStats?.elder_stats.find(s => s.elder_id === elderId)
  }

  @Builder
  private buildElderCard(item: UserElderRelationItem) {

    CardContainer() {
      Row() {
        Text(item.elder.gender === 1 ? 'ðŸ‘´' : 'ðŸ‘µ')
          .fontSize(32)
          .margin({ right: 12 })

        Column() {
          Text(item.elder.name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1e293b')
          Text(`${item.elder.age}å²`)
            .fontSize(12)
            .fontColor('#64748b')
            .margin({ top: 2 })
            
          if (this.getElderStats(item.elder_id)) {
             Row() {
               Text(`ä»Šæ—¥ä»»åŠ¡: ${this.getElderStats(item.elder_id)!.completed_tasks}/${this.getElderStats(item.elder_id)!.total_tasks}`)
                .fontSize(12)
                .fontColor(this.getElderStats(item.elder_id)!.completed_tasks === this.getElderStats(item.elder_id)!.total_tasks && this.getElderStats(item.elder_id)!.total_tasks > 0 ? '#16a34a' : '#64748b')
                .backgroundColor(this.getElderStats(item.elder_id)!.completed_tasks === this.getElderStats(item.elder_id)!.total_tasks && this.getElderStats(item.elder_id)!.total_tasks > 0 ? '#f0fdf4' : '#f8fafc')
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .borderRadius(4)
                .margin({ top: 6 })
             }
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Text('ç®¡ç†è®¡åˆ’ â†’')
          .fontSize(13)
          .fontColor('#2563eb')
      }
      .width('100%')
      .onClick(() => {
        this.openElderPlanList(item)
      })
    }
  }

  build() {
    Column() {
      if (this.isLoadingElders && this.elders.length === 0) {
        Column() {
          LoadingProgress().width(32).height(32).color('#2563eb')
          Text('åŠ è½½ä¸­...')
            .fontSize(13)
            .fontColor('#64748b')
            .margin({ top: 8 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else if (this.elders.length === 0) {
        EmptyState({
          icon: 'ðŸ“‹',
          title: 'æš‚æ— å…³è”è€äºº',
          subtitle: 'è¯·å…ˆåœ¨æ¡£æ¡ˆé¡µé¢æ·»åŠ è€äººåŽå†åˆ›å»ºå¹²é¢„è®¡åˆ’'
        })
      } else {
        Scroll() {
          Column() {
            // ä»Šæ—¥å¾…åŠž
            this.buildTodayTasksPanel()

            // // ç»Ÿè®¡æ 
            // this.buildStatsBar()

            // è€äººåˆ—è¡¨
            SectionHeader({ title: 'è€äººå¹²é¢„' })
            ForEach(this.elders, (item: UserElderRelationItem) => {
              this.buildElderCard(item)
            }, (item: UserElderRelationItem) => item.relation_id.toString())
          }
          .constraintSize({
            minHeight:"100%"
          })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .padding(16)
    .backgroundColor('#f8fafc')
  }
}
