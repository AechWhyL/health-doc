import { httpRequest } from '../../../common/api/HttpUtil';
import { RequestEnum } from '../../../common/api/httpEnum';
import { SectionHeader } from '../../../components/common/SectionHeader';
import { StatCard } from '../../../components/common/StatCard';
import { EmptyState } from '../../../components/common/EmptyState';
import { CardContainer } from '../../../components/common/CardContainer';

interface ApiResponse<T = Object> {
  code: number;
  message: string;
  data?: T;
  timestamp: number;
}

interface ElderResponse {
  id: number;
  name: string;
  gender: number;
  age: number;
  phone: string;
}

interface UserElderRelationItem {
  relation_id: number;
  elder_id: number;
  relation_name: string | null;
  elder: ElderResponse;
}

interface MyEldersListData {
  items: UserElderRelationItem[];
  total: number;
}

interface HealthJudgment {
  bp_level?: string;
  fpg_level?: string;
  ppg_level?: string;
}

interface HealthMeasurement {
  id: number;
  elder_id: number;
  measured_at: string;
  sbp?: number;
  dbp?: number;
  fpg?: number;
  ppg_2h?: number;
  weight?: number;
  steps?: number;
  source: string;
  judgment?: HealthJudgment;
}

interface HealthMeasurementListData {
  records: HealthMeasurement[];
  total: number;
}

interface MyEldersQueryParams {
  page: number;
  pageSize: number;
}

interface HealthDataQueryParams {
  elder_id: number;
  page: number;
  pageSize: number;
  include_judgment: boolean;
}

@Component
export struct DataTab {
  @State private elders: UserElderRelationItem[] = []
  @State private selectedElder: UserElderRelationItem | null = null
  @State private isLoadingElders: boolean = false
  @State private measurements: HealthMeasurement[] = []
  @State private isLoadingData: boolean = false
  @State private latestMeasurement: HealthMeasurement | null = null

  aboutToAppear(): void {
    this.loadElders()
  }

  private async loadElders(): Promise<void> {
    this.isLoadingElders = true
    try {
      const params: MyEldersQueryParams = { page: 1, pageSize: 50 }
      const response = await httpRequest<ApiResponse<MyEldersListData>, MyEldersQueryParams>({
        url: '/api/v1/users/me/elders',
        method: RequestEnum.GET,
        token: 'auth',
        params: params
      })

      if (response.code === 200 && response.data) {
        this.elders = response.data.items || []
        if (this.elders.length > 0) {
          this.selectedElder = this.elders[0]
          this.loadHealthData()
        }
      }
    } catch (error) {
      console.error('Failed to load elders')
    } finally {
      this.isLoadingElders = false
    }
  }

  private async loadHealthData(): Promise<void> {
    if (!this.selectedElder) {
      return
    }
    this.isLoadingData = true
    try {
      const params: HealthDataQueryParams = {
        elder_id: this.selectedElder.elder_id,
        page: 1,
        pageSize: 10,
        include_judgment: true
      }
      const response = await httpRequest<ApiResponse<HealthMeasurementListData>, HealthDataQueryParams>({
        url: '/api/v1/elder-health/daily-health/list',
        method: RequestEnum.GET,
        token: 'auth',
        params: params
      })

      if (response.code === 200 && response.data) {
        this.measurements = response.data.records || []
        this.latestMeasurement = this.measurements.length > 0 ? this.measurements[0] : null
      }
    } catch (error) {
      console.error('Failed to load health data')
    } finally {
      this.isLoadingData = false
    }
  }

  private selectElder(elder: UserElderRelationItem): void {
    this.selectedElder = elder
    this.loadHealthData()
  }

  private getBpStatusText(level?: string): string {
    switch (level) {
      case 'NORMAL': return 'æ­£å¸¸'
      case 'MILD': return 'åé«˜'
      case 'MODERATE': return 'ä¸­åº¦'
      case 'SEVERE': return 'ä¸¥é‡'
      default: return '--'
    }
  }

  private getBpStatusColor(level?: string): string {
    switch (level) {
      case 'NORMAL': return '#16a34a'
      case 'MILD': return '#ca8a04'
      case 'MODERATE': return '#ea580c'
      case 'SEVERE': return '#dc2626'
      default: return '#64748b'
    }
  }

  private formatDateTime(dateStr: string): string {
    const date = new Date(dateStr)
    const now = new Date()
    const isToday = date.toDateString() === now.toDateString()
    const yesterday = new Date(now)
    yesterday.setDate(yesterday.getDate() - 1)
    const isYesterday = date.toDateString() === yesterday.toDateString()

    const time = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`

    if (isToday) {
      return `ä»Šæ—¥ ${time}`
    } else if (isYesterday) {
      return `æ˜¨æ—¥ ${time}`
    } else {
      return `${date.getMonth() + 1}/${date.getDate()} ${time}`
    }
  }

  @Builder
  private buildElderSelector() {
    Row() {
      Text(this.selectedElder ? `ðŸ‘¤ ${this.selectedElder.elder.name}` : 'é€‰æ‹©è€äºº')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#1e293b')
        .layoutWeight(1)

      Text('â–¼')
        .fontSize(12)
        .fontColor('#9ca3af')
    }
    .width('100%')
    .padding(14)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 4, color: '#0f172a0a', offsetY: 1 })
    .margin({ bottom: 16 })
    .bindMenu(this.elders.map((elder: UserElderRelationItem) => {
      const item: MenuElement = {
        value: elder.elder.name,
        action: () => {
          this.selectElder(elder)
        }
      }
      return item
    }))
  }

  @Builder
  private buildHealthOverview() {
    if (this.latestMeasurement) {
      Row({ space: 12 }) {
        // è¡€åŽ‹
        Column() {
          Text('è¡€åŽ‹')
            .fontSize(12)
            .fontColor('#64748b')
          if (this.latestMeasurement.sbp && this.latestMeasurement.dbp) {
            Text(`${this.latestMeasurement.sbp}/${this.latestMeasurement.dbp}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1e293b')
              .margin({ top: 4 })
            Text(this.getBpStatusText(this.latestMeasurement.judgment?.bp_level))
              .fontSize(11)
              .fontColor(this.getBpStatusColor(this.latestMeasurement.judgment?.bp_level))
              .margin({ top: 2 })
          } else {
            Text('--')
              .fontSize(20)
              .fontColor('#9ca3af')
              .margin({ top: 4 })
          }
        }
        .padding(14)
        .backgroundColor('#f8fafc')
        .borderRadius(12)
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)

        // è¡€ç³–
        Column() {
          Text('è¡€ç³–')
            .fontSize(12)
            .fontColor('#64748b')
          if (this.latestMeasurement.fpg !== undefined && this.latestMeasurement.fpg !== null) {
            Text(`${Number(this.latestMeasurement.fpg).toFixed(1)}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1e293b')
              .margin({ top: 4 })
            Text(this.getBpStatusText(this.latestMeasurement.judgment?.fpg_level))
              .fontSize(11)
              .fontColor(this.getBpStatusColor(this.latestMeasurement.judgment?.fpg_level))
              .margin({ top: 2 })
          } else {
            Text('--')
              .fontSize(20)
              .fontColor('#9ca3af')
              .margin({ top: 4 })
          }
        }
        .padding(14)
        .backgroundColor('#f8fafc')
        .borderRadius(12)
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)

        // ä½“é‡
        Column() {
          Text('ä½“é‡')
            .fontSize(12)
            .fontColor('#64748b')
          if (this.latestMeasurement.weight) {
            Text(`${this.latestMeasurement.weight}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1e293b')
              .margin({ top: 4 })
            Text('kg')
              .fontSize(11)
              .fontColor('#64748b')
              .margin({ top: 2 })
          } else {
            Text('--')
              .fontSize(20)
              .fontColor('#9ca3af')
              .margin({ top: 4 })
          }
        }
        .padding(14)
        .backgroundColor('#f8fafc')
        .borderRadius(12)
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: 16 })
    }
  }

  @Builder
  private buildMeasurementItem(m: HealthMeasurement) {
    Row() {
      Column() {
        Text(this.formatDateTime(m.measured_at))
          .fontSize(13)
          .fontColor('#64748b')

        Row({ space: 12 }) {
          if (m.sbp && m.dbp) {
            Row() {
              Text(`è¡€åŽ‹ ${m.sbp}/${m.dbp}`)
                .fontSize(14)
                .fontColor('#1e293b')
              if (m.judgment?.bp_level && m.judgment.bp_level !== 'NORMAL') {
                Text('âš ï¸')
                  .fontSize(12)
                  .margin({ left: 4 })
              }
            }
          }
          if (m.fpg) {
            Row() {
              Text(`è¡€ç³– ${Number(m.fpg).toFixed(1)}`)
                .fontSize(14)
                .fontColor('#1e293b')
              if (m.judgment?.fpg_level && m.judgment.fpg_level !== 'NORMAL') {
                Text('âš ï¸')
                  .fontSize(12)
                  .margin({ left: 4 })
              }
            }
          }
        }
        .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Text(this.getBpStatusText(m.judgment?.bp_level || m.judgment?.fpg_level))
        .fontSize(12)
        .fontColor(this.getBpStatusColor(m.judgment?.bp_level || m.judgment?.fpg_level))
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .backgroundColor(m.judgment?.bp_level === 'NORMAL' && m.judgment?.fpg_level === 'NORMAL' ? '#ecfdf5' : '#fef2f2')
        .borderRadius(12)
    }
    .width('100%')
    .padding(12)
    .margin({ bottom: 8 })
    .backgroundColor(Color.White)
    .borderRadius(10)
  }

  build() {
    Column() {
      if (this.isLoadingElders) {
        Column() {
          LoadingProgress().width(32).height(32).color('#2563eb')
          Text('åŠ è½½ä¸­...')
            .fontSize(13)
            .fontColor('#64748b')
            .margin({ top: 8 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else if (this.elders.length === 0) {
        EmptyState({
          icon: 'ðŸ‘¥',
          title: 'æš‚æ— å…³è”è€äºº',
          subtitle: 'è¯·å…ˆåœ¨æ¡£æ¡ˆé¡µé¢æ·»åŠ è€äºº'
        })
      } else {
        // è€äººé€‰æ‹©å™¨
        this.buildElderSelector()

        // å¥åº·æ¦‚è§ˆ
        SectionHeader({ title: 'å¥åº·æ¦‚è§ˆ' })
        if (this.isLoadingData) {
          LoadingProgress().width(24).height(24).color('#2563eb').margin({ bottom: 16 })
        } else if (this.latestMeasurement) {
          this.buildHealthOverview()
        } else {
          Text('æš‚æ— å¥åº·æ•°æ®')
            .fontSize(13)
            .fontColor('#9ca3af')
            .margin({ bottom: 16 })
        }

        // æœ€è¿‘æµ‹é‡
        SectionHeader({ title: 'æœ€è¿‘æµ‹é‡' })
        if (this.measurements.length === 0) {
          EmptyState({
            icon: 'ðŸ“Š',
            title: 'æš‚æ— æµ‹é‡è®°å½•',
            subtitle: 'ç­‰å¾…è€äººä¸Šä¼ å¥åº·æ•°æ®'
          })
        } else {
          Scroll() {
            Column() {
              ForEach(this.measurements, (m: HealthMeasurement) => {
                this.buildMeasurementItem(m)
              }, (m: HealthMeasurement) => m.id.toString())
            }
          }
          .layoutWeight(1)
          .scrollBar(BarState.Off)
        }
      }
    }
    .width('100%')
    .height('100%')
    .padding(16)
    .backgroundColor('#f8fafc')
  }
}
