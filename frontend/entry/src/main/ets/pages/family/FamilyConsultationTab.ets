import { promptAction } from '@kit.ArkUI';
import { httpRequest } from '../../common/api/HttpUtil';
import { RequestEnum } from '../../common/api/httpEnum';

interface ApiResponse<T = Object> {
  code: number;
  message: string;
  data?: T;
  timestamp: number;
}

interface PaginationResponse<T> {
  items: T[];
  total: number;
}

interface ConsultationQuestion {
  id: number;
  title: string;
  description: string;
  status: string;
  priority: string;
  created_at: string;
}

interface CreateQuestionRequest {
  title: string;
  description: string;
  creator_type: string;
  creator_id?: number;
  target_staff_id: number;
  priority: string;
}

interface ConsultationParams {
  page?: number;
  pageSize?: number;
  status?: string;
}

interface MedicalStaffInfo {
  id: number;
  user_id: number;
  gender: number;
  role_type: string;
  job_title: string | null;
  good_at_tags: string | null;
  real_name: string | null;
  username: string;
  phone: string | null;
}

interface MedicalStaffListData {
  items: MedicalStaffInfo[];
  total: number;
}

interface SearchStaffParams {
  page: number;
  pageSize: number;
  goodAtTags?: string;
  phone?: string;
}

@Component
export struct FamilyConsultationTab {
  @Consume('navPathStack') navPathStack: NavPathStack;
  @State questions: ConsultationQuestion[] = [];
  @State isLoading: boolean = false;
  @State currentTab: number = 0;
  // å…¨å±åˆ›å»ºå’¨è¯¢çŠ¶æ€
  @State showCreatePage: boolean = false;
  @State createStep: number = 1; // 1=é€‰æ‹©åŒ»æŠ¤, 2=å¡«å†™è¡¨å•
  @State staffList: MedicalStaffInfo[] = [];
  @State isLoadingStaff: boolean = false;
  @State selectedStaff: MedicalStaffInfo | null = null;
  @State searchKeyword: string = '';
  @State searchPhone: string = '';
  @State questionTitle: string = '';
  @State questionContent: string = '';
  @State isSubmitting: boolean = false;

  private tabs: string[] = ['å…¨éƒ¨', 'å¾…å¤„ç†', 'å¤„ç†ä¸­', 'å·²å®Œæˆ'];

  aboutToAppear(): void {
    this.fetchQuestions();
  }

  private async fetchQuestions(): Promise<void> {
    this.isLoading = true;
    try {
      const params: ConsultationParams = { page: 1, pageSize: 50 };
      if (this.currentTab === 1) params.status = 'PENDING';
      else if (this.currentTab === 2) params.status = 'IN_PROGRESS';
      else if (this.currentTab === 3) params.status = 'COMPLETED';

      const response = await httpRequest<ApiResponse<PaginationResponse<ConsultationQuestion>>, ConsultationParams>({
        url: '/api/v1/consultation/questions',
        method: RequestEnum.GET,
        params: params
      });

      if (response.code === 200 && response.data) {
        this.questions = response.data.items || [];
      }
    } catch (error) {
      console.error('è·å–å’¨è¯¢åˆ—è¡¨å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  private async loadMedicalStaff(): Promise<void> {
    this.isLoadingStaff = true;
    try {
      const params: SearchStaffParams = { page: 1, pageSize: 50 };
      if (this.searchKeyword.trim()) params.goodAtTags = this.searchKeyword.trim();
      if (this.searchPhone.trim()) params.phone = this.searchPhone.trim();

      const response = await httpRequest<ApiResponse<MedicalStaffListData>, SearchStaffParams>({
        url: '/api/v1/users/online-medical-staff',
        method: RequestEnum.GET,
        params: params
      });

      if (response.code === 200 && response.data) {
        const data = response.data as Object;
        if (Array.isArray((data as MedicalStaffListData).items)) {
          this.staffList = (data as MedicalStaffListData).items;
        } else if (Array.isArray((data as Record<string, MedicalStaffInfo[]>)['records'])) {
          this.staffList = (data as Record<string, MedicalStaffInfo[]>)['records'];
        }
      }
    } catch (error) {
      console.error('è·å–åŒ»æŠ¤äººå‘˜åˆ—è¡¨å¤±è´¥:', error);
    } finally {
      this.isLoadingStaff = false;
    }
  }

  private async submitQuestion(): Promise<void> {
    if (!this.selectedStaff) {
      promptAction.showToast({ message: 'è¯·é€‰æ‹©å’¨è¯¢å¯¹è±¡' });
      return;
    }
    if (!this.questionTitle.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æ ‡é¢˜' });
      return;
    }
    if (!this.questionContent.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å†…å®¹' });
      return;
    }

    this.isSubmitting = true;
    try {
      const data: CreateQuestionRequest = {
        title: this.questionTitle.trim(),
        description: this.questionContent.trim(),
        creator_type: 'FAMILY',
        target_staff_id: this.selectedStaff.user_id,
        priority: 'NORMAL'
      };

      const response = await httpRequest<ApiResponse<ConsultationQuestion>, CreateQuestionRequest>({
        url: '/api/v1/consultation/questions',
        method: RequestEnum.POST,
        params: data
      });

      if (response.code === 200 || response.code === 201) {
        promptAction.showToast({ message: 'å’¨è¯¢å·²æäº¤' });
        this.closeCreatePage();
        this.fetchQuestions();
      } else {
        promptAction.showToast({ message: response.message || 'æäº¤å¤±è´¥' });
      }
    } catch (error) {
      console.error('åˆ›å»ºå’¨è¯¢å¤±è´¥:', error);
      promptAction.showToast({ message: 'æäº¤å¤±è´¥' });
    } finally {
      this.isSubmitting = false;
    }
  }

  private openCreatePage(): void {
    this.showCreatePage = true;
    this.createStep = 1;
    this.staffList = [];
    this.selectedStaff = null;
    this.searchKeyword = '';
    this.searchPhone = '';
    this.questionTitle = '';
    this.questionContent = '';
    this.loadMedicalStaff();
  }

  private closeCreatePage(): void {
    this.showCreatePage = false;
    this.createStep = 1;
  }

  private getRoleTypeText(roleType: string): string {
    switch (roleType) {
      case 'doctor': return 'åŒ»ç”Ÿ';
      case 'nurse': return 'æŠ¤å£«';
      case 'therapist': return 'æ²»ç–—å¸ˆ';
      default: return 'åŒ»æŠ¤';
    }
  }

  private getStatusText(status: string): string {
    switch (status) {
      case 'PENDING': return 'å¾…å¤„ç†';
      case 'IN_PROGRESS': return 'å¤„ç†ä¸­';
      case 'COMPLETED': return 'å·²å®Œæˆ';
      default: return status;
    }
  }

  private getStatusColor(status: string): string {
    switch (status) {
      case 'PENDING': return '#f59e0b';
      case 'IN_PROGRESS': return '#3b82f6';
      case 'COMPLETED': return '#10b981';
      default: return '#6b7280';
    }
  }

  @Builder
  QuestionItem(item: ConsultationQuestion) {
    Row() {
      Column() {
        Row() {
          Text(item.title)
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1e293b')
            .layoutWeight(1)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          Text(this.getStatusText(item.status))
            .fontSize(11)
            .fontColor(this.getStatusColor(item.status))
            .backgroundColor(this.getStatusColor(item.status) + '1a')
            .padding({ left: 8, right: 8, top: 3, bottom: 3 })
            .borderRadius(10)
        }
        .width('100%')

        Text(item.description || 'æ— æè¿°')
          .fontSize(13)
          .fontColor('#64748b')
          .margin({ top: 6 })
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(item.created_at?.substring(0, 10) || '')
          .fontSize(11)
          .fontColor('#9ca3af')
          .margin({ top: 6 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 10 })
    .onClick(() => {
      this.navPathStack.pushPath({ name: 'Family_ConsultationChat', param: item });
    })
  }

  @Builder
  StaffCard(staff: MedicalStaffInfo) {
    Row() {
      Column() {
        Text(staff.gender === 0 ? 'ğŸ‘¨â€âš•ï¸' : 'ğŸ‘©â€âš•ï¸').fontSize(26)
      }
      .width(50)
      .height(50)
      .borderRadius(25)
      .backgroundColor('#f1f5f9')
      .justifyContent(FlexAlign.Center)

      Column() {
        Row() {
          Text(staff.real_name || staff.username)
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1e293b')
          Text(this.getRoleTypeText(staff.role_type))
            .fontSize(10)
            .fontColor('#2563eb')
            .backgroundColor('#eff6ff')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(6)
            .margin({ left: 8 })
        }
        if (staff.job_title) {
          Text(staff.job_title).fontSize(12).fontColor('#64748b').margin({ top: 3 })
        }
        if (staff.good_at_tags) {
          Text('æ“…é•¿: ' + staff.good_at_tags).fontSize(11).fontColor('#94a3b8').margin({ top: 2 }).maxLines(1)
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })

      Button('é€‰æ‹©')
        .type(ButtonType.Capsule)
        .backgroundColor('#2563eb')
        .fontSize(12)
        .height(32)
        .onClick(() => {
          this.selectedStaff = staff;
          this.createStep = 2;
        })
    }
    .width('100%')
    .padding(14)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 10 })
  }

  @Builder
  CreatePageContent() {
    Column() {
      // é¡¶éƒ¨æ 
      Row() {
        Text(this.createStep === 1 ? 'âœ•' : 'â†')
          .fontSize(20)
          .fontColor('#374151')
          .onClick(() => {
            if (this.createStep === 2) {
              this.createStep = 1;
            } else {
              this.closeCreatePage();
            }
          })

        Text(this.createStep === 1 ? 'é€‰æ‹©å’¨è¯¢å¯¹è±¡' : 'å¡«å†™å’¨è¯¢å†…å®¹')
          .fontSize(17)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1e293b')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Text('').width(20)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#e5e7eb' })

      if (this.createStep === 1) {
        // æœç´¢æ 
        Column() {
          TextInput({ text: this.searchKeyword, placeholder: 'æœç´¢æ“…é•¿é¢†åŸŸ...' })
            .height(40)
            .fontSize(14)
            .backgroundColor('#f1f5f9')
            .borderRadius(10)
            .onChange((v: string) => { this.searchKeyword = v; })
            .onSubmit(() => { this.loadMedicalStaff(); })

          Row() {
            TextInput({ text: this.searchPhone, placeholder: 'æ‰‹æœºå·æœç´¢...' })
              .height(40)
              .fontSize(14)
              .backgroundColor('#f1f5f9')
              .borderRadius(10)
              .layoutWeight(1)
              .onChange((v: string) => { this.searchPhone = v; })
              .onSubmit(() => { this.loadMedicalStaff(); })

            Button('æœç´¢')
              .type(ButtonType.Capsule)
              .backgroundColor('#2563eb')
              .height(40)
              .width(70)
              .margin({ left: 10 })
              .onClick(() => { this.loadMedicalStaff(); })
          }
          .width('100%')
          .margin({ top: 10 })
        }
        .width('100%')
        .padding(16)
        .backgroundColor(Color.White)

        // åŒ»æŠ¤åˆ—è¡¨
        if (this.isLoadingStaff) {
          Column() {
            LoadingProgress().width(36).height(36)
            Text('åŠ è½½ä¸­...').fontSize(13).fontColor('#64748b').margin({ top: 10 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        } else if (this.staffList.length === 0) {
          Column() {
            Text('ğŸ‘¨â€âš•ï¸').fontSize(48)
            Text('æš‚æ— å¯ç”¨åŒ»æŠ¤äººå‘˜').fontSize(15).fontColor('#64748b').margin({ top: 12 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        } else {
          Scroll() {
            Column() {
              ForEach(this.staffList, (staff: MedicalStaffInfo) => {
                this.StaffCard(staff)
              }, (staff: MedicalStaffInfo) => staff.id.toString())
            }
            .width('100%')
            .padding(16)
          }
          .layoutWeight(1)
          .scrollBar(BarState.Off)
        }
      } else {
        // å¡«å†™è¡¨å•
        Scroll() {
          Column() {
            // å·²é€‰åŒ»æŠ¤
            Row() {
              Text(this.selectedStaff?.gender === 0 ? 'ğŸ‘¨â€âš•ï¸' : 'ğŸ‘©â€âš•ï¸').fontSize(22)
              Column() {
                Text('å’¨è¯¢å¯¹è±¡').fontSize(11).fontColor('#64748b')
                Text(this.selectedStaff?.real_name || this.selectedStaff?.username || '')
                  .fontSize(15)
                  .fontWeight(FontWeight.Medium)
                  .margin({ top: 2 })
              }
              .alignItems(HorizontalAlign.Start)
              .margin({ left: 10 })
              .layoutWeight(1)

              Text('æ›´æ¢').fontSize(13).fontColor('#2563eb').onClick(() => { this.createStep = 1; })
            }
            .width('100%')
            .padding(14)
            .backgroundColor('#f8fafc')
            .borderRadius(10)
            .margin({ bottom: 20 })

            Text('å’¨è¯¢æ ‡é¢˜').fontSize(14).fontColor('#374151').alignSelf(ItemAlign.Start)
            TextInput({ text: this.questionTitle, placeholder: 'ç®€è¦æè¿°æ‚¨çš„é—®é¢˜' })
              .height(46)
              .fontSize(14)
              .backgroundColor('#f8fafc')
              .borderRadius(10)
              .margin({ top: 6, bottom: 18 })
              .onChange((v: string) => { this.questionTitle = v; })

            Text('è¯¦ç»†æè¿°').fontSize(14).fontColor('#374151').alignSelf(ItemAlign.Start)
            TextArea({ text: this.questionContent, placeholder: 'è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜...' })
              .height(140)
              .fontSize(14)
              .backgroundColor('#f8fafc')
              .borderRadius(10)
              .margin({ top: 6, bottom: 24 })
              .onChange((v: string) => { this.questionContent = v; })

            Button(this.isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤å’¨è¯¢')
              .type(ButtonType.Capsule)
              .backgroundColor('#2563eb')
              .width('100%')
              .height(48)
              .enabled(!this.isSubmitting)
              .onClick(() => { this.submitQuestion(); })
          }
          .width('100%')
          .padding(20)
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f1f5f9')
  }

  build() {
    Stack() {
      // ä¸»å†…å®¹
      Column() {
        // æ ‡é¢˜æ 
        Row() {
          Column() {
            Text('å’¨è¯¢æœåŠ¡').fontSize(22).fontWeight(FontWeight.Bold).fontColor('#1e293b')
            Text('å‘åŒ»æŠ¤äººå‘˜å’¨è¯¢å¥åº·é—®é¢˜').fontSize(13).fontColor('#64748b').margin({ top: 4 })
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

          Button('+ æ–°å»ºå’¨è¯¢')
            .type(ButtonType.Capsule)
            .backgroundColor('#2563eb')
            .fontSize(13)
            .height(36)
            .onClick(() => { this.openCreatePage(); })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 12 })

        // Tab
        Row() {
          ForEach(this.tabs, (item: string, index: number) => {
            Text(item)
              .fontSize(14)
              .fontColor(this.currentTab === index ? '#ffffff' : '#64748b')
              .backgroundColor(this.currentTab === index ? '#1e293b' : '#f1f5f9')
              .padding({ left: 16, right: 16, top: 8, bottom: 8 })
              .borderRadius(18)
              .margin({ right: 8 })
              .onClick(() => {
                this.currentTab = index;
                this.fetchQuestions();
              })
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 12 })

        // åˆ—è¡¨
        if (this.isLoading) {
          Column() {
            LoadingProgress().width(36).height(36)
            Text('åŠ è½½ä¸­...').fontSize(13).fontColor('#64748b').margin({ top: 10 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        } else if (this.questions.length === 0) {
          Column() {
            Text('ğŸ’¬').fontSize(48)
            Text('æš‚æ— å’¨è¯¢è®°å½•').fontSize(15).fontColor('#64748b').margin({ top: 16 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        } else {
          List() {
            ForEach(this.questions, (item: ConsultationQuestion) => {
              ListItem() { this.QuestionItem(item) }
            }, (item: ConsultationQuestion) => item.id.toString())
          }
          .width('100%')
          .layoutWeight(1)
          .padding({ left: 16, right: 16, top: 8 })
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f8fafc')

      // å…¨å±åˆ›å»ºå’¨è¯¢é¡µé¢
      if (this.showCreatePage) {
        this.CreatePageContent()
      }
    }
    .width('100%')
    .height('100%')
  }
}
