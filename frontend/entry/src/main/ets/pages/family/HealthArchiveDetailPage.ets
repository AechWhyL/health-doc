import { AttachmentPreviewParams } from './AttachmentPreviewPage';

type HealthRecordType = 'MEDICAL_HISTORY' | 'CHECK_REPORT' | 'MEDICATION' | 'ALLERGY';

interface HealthRecordAttachment {
  type: 'IMAGE' | 'FILE';
  url: string;
  name?: string;
}

interface MedicalHistoryContent {
  disease_name: string;
  diagnosed_at: string;
  status: 'ONGOING' | 'REMISSION' | 'CURED';
  notes?: string;
  attachments?: HealthRecordAttachment[];
}

interface CheckReportContent {
  check_date: string;
  hospital_name: string;
  check_item: string;
  result_summary: 'NORMAL' | 'MILD_ABNORMAL' | 'SIGNIFICANT_ABNORMAL';
  notes?: string;
  attachments?: HealthRecordAttachment[];
}

interface MedicationContent {
  drug_name: string[];
  dosage: string;
  frequency: string;
  route: string;
  start_date: string;
  end_date?: string;
  notes?: string;
  prescribing_doctor?: string;
  hospital_name?: string;
  attachments?: HealthRecordAttachment[];
}

interface AllergyContent {
  allergy_item: string;
  reaction_symptoms: string[];
  first_occurrence_date: string;
  last_occurrence_date?: string;
  notes?: string;
  attachments?: HealthRecordAttachment[];
}

type HealthRecordContent = MedicalHistoryContent | CheckReportContent | MedicationContent | AllergyContent;

interface HealthArchiveRecord {
  id: number;
  elder_id: number;
  record_type: HealthRecordType;
  record_title: string;
  record_date: string;
  content_structured: HealthRecordContent;
  created_at?: string;
  updated_at?: string;
}

@Component
export struct HealthArchiveDetailPage {
  @Consume('navPathStack') navPathStack: NavPathStack;
  @State record: HealthArchiveRecord | null = null;

  aboutToAppear(): void {
    const params = this.navPathStack.getParamByName('Family_HealthArchiveDetail') as Object[];
    if (params && params.length > 0) {
      this.record = params[0] as HealthArchiveRecord;
    }
  }

  private getRecordTypeName(type: HealthRecordType): string {
    switch (type) {
      case 'MEDICAL_HISTORY': return 'ç—…å²';
      case 'CHECK_REPORT': return 'æ£€æŸ¥æŠ¥å‘Š';
      case 'MEDICATION': return 'ç”¨è¯è®°å½•';
      case 'ALLERGY': return 'è¿‡æ•ä¿¡æ¯';
      default: return 'å¥åº·æ¡£æ¡ˆ';
    }
  }

  private getRecordTypeIcon(type: HealthRecordType): string {
    switch (type) {
      case 'MEDICAL_HISTORY': return 'ğŸ¥';
      case 'CHECK_REPORT': return 'ğŸ”¬';
      case 'MEDICATION': return 'ğŸ’Š';
      case 'ALLERGY': return 'âš ï¸';
      default: return 'ğŸ“‹';
    }
  }

  private getStatusText(status: string): string {
    switch (status) {
      case 'ONGOING': return 'è¿›è¡Œä¸­';
      case 'REMISSION': return 'ç¼“è§£';
      case 'CURED': return 'æ²»æ„ˆ';
      case 'NORMAL': return 'æ­£å¸¸';
      case 'MILD_ABNORMAL': return 'è½»åº¦å¼‚å¸¸';
      case 'SIGNIFICANT_ABNORMAL': return 'é‡åº¦å¼‚å¸¸';
      default: return status;
    }
  }

  private getStatusColor(status: string): string {
    switch (status) {
      case 'ONGOING':
      case 'MILD_ABNORMAL':
        return '#f59e0b';
      case 'REMISSION':
      case 'NORMAL':
      case 'CURED':
        return '#16a34a';
      case 'SIGNIFICANT_ABNORMAL':
        return '#dc2626';
      default:
        return '#64748b';
    }
  }

  private formatDate(dateStr: string): string {
    const d = new Date(dateStr);
    return d.getFullYear() + '-' +
      String(d.getMonth() + 1).padStart(2, '0') + '-' +
      String(d.getDate()).padStart(2, '0');
  }

  private openAttachment(attachment: HealthRecordAttachment): void {
    this.navPathStack.pushPath({
      name: 'Family_AttachmentPreview',
      param: {
        url: attachment.url,
        name: attachment.name || 'é™„ä»¶é¢„è§ˆ'
      } as AttachmentPreviewParams
    });
  }

  @Builder
  private InfoRow(label: string, value: string, valueColor?: string) {
    Row() {
      Text(label)
        .fontSize(14)
        .fontColor('#64748b')
        .width(90)
      Text(value)
        .fontSize(14)
        .fontColor(valueColor || '#1e293b')
        .layoutWeight(1)
    }
    .width('100%')
    .padding({ top: 10, bottom: 10 })
  }

  @Builder
  private StatusBadge(status: string) {
    Text(this.getStatusText(status))
      .fontSize(12)
      .fontColor(this.getStatusColor(status))
      .backgroundColor(this.getStatusColor(status) + '20')
      .padding({ left: 10, right: 10, top: 4, bottom: 4 })
      .borderRadius(12)
  }

  @Builder
  private SectionTitle(title: string) {
    Text(title)
      .fontSize(15)
      .fontWeight(FontWeight.Medium)
      .fontColor('#374151')
      .margin({ top: 20, bottom: 12 })
  }

  @Builder
  private AttachmentList(attachments: HealthRecordAttachment[]) {
    if (attachments && attachments.length > 0) {
      this.SectionTitle('é™„ä»¶')
      ForEach(attachments, (attachment: HealthRecordAttachment) => {
        Row() {
          Text(attachment.type === 'IMAGE' ? 'ğŸ–¼ï¸' : 'ğŸ“„')
            .fontSize(20)
          Text(attachment.name || 'é™„ä»¶')
            .fontSize(14)
            .fontColor('#1e293b')
            .layoutWeight(1)
            .margin({ left: 10 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          Text('æŸ¥çœ‹ â†’')
            .fontSize(13)
            .fontColor('#2563eb')
        }
        .width('100%')
        .padding(14)
        .backgroundColor('#f8fafc')
        .borderRadius(10)
        .margin({ bottom: 8 })
        .onClick(() => {
          this.openAttachment(attachment);
        })
      }, (item: HealthRecordAttachment, index: number) => index.toString())
    }
  }

  @Builder
  private MedicalHistoryDetail(content: MedicalHistoryContent) {
    Column() {
      this.InfoRow('ç–¾ç—…åç§°', content.disease_name)
      this.InfoRow('ç¡®è¯Šæ—¥æœŸ', this.formatDate(content.diagnosed_at))
      Row() {
        Text('çŠ¶æ€')
          .fontSize(14)
          .fontColor('#64748b')
          .width(90)
        this.StatusBadge(content.status)
      }
      .width('100%')
      .padding({ top: 10, bottom: 10 })

      if (content.notes) {
        this.InfoRow('å¤‡æ³¨', content.notes)
      }
      if (content.attachments) {
        this.AttachmentList(content.attachments)
      }
    }
  }

  @Builder
  private CheckReportDetail(content: CheckReportContent) {
    Column() {
      this.InfoRow('æ£€æŸ¥æ—¥æœŸ', this.formatDate(content.check_date))
      this.InfoRow('æ£€æŸ¥åŒ»é™¢', content.hospital_name)
      this.InfoRow('æ£€æŸ¥é¡¹ç›®', content.check_item)
      Row() {
        Text('ç»“è®º')
          .fontSize(14)
          .fontColor('#64748b')
          .width(90)
        this.StatusBadge(content.result_summary)
      }
      .width('100%')
      .padding({ top: 10, bottom: 10 })

      if (content.notes) {
        this.InfoRow('å¤‡æ³¨', content.notes)
      }
      if (content.attachments) {
        this.AttachmentList(content.attachments)
      }
    }
  }

  @Builder
  private MedicationDetail(content: MedicationContent) {
    Column() {
      this.InfoRow('è¯å“åç§°', content.drug_name.join('ã€'))
      this.InfoRow('å‰‚é‡', content.dosage)
      this.InfoRow('é¢‘æ¬¡', content.frequency)
      this.InfoRow('ç»™è¯é€”å¾„', content.route)
      this.InfoRow('å¼€å§‹æ—¥æœŸ', this.formatDate(content.start_date))
      if (content.end_date) {
        this.InfoRow('ç»“æŸæ—¥æœŸ', this.formatDate(content.end_date))
      }
      if (content.prescribing_doctor) {
        this.InfoRow('å¼€è¯åŒ»ç”Ÿ', content.prescribing_doctor)
      }
      if (content.hospital_name) {
        this.InfoRow('å¼€è¯åŒ»é™¢', content.hospital_name)
      }
      if (content.notes) {
        this.InfoRow('å¤‡æ³¨', content.notes)
      }
      if (content.attachments) {
        this.AttachmentList(content.attachments)
      }
    }
  }

  @Builder
  private AllergyDetail(content: AllergyContent) {
    Column() {
      this.InfoRow('è¿‡æ•æº', content.allergy_item)
      this.InfoRow('ååº”ç—‡çŠ¶', content.reaction_symptoms.join('ã€'))
      this.InfoRow('é¦–æ¬¡å‘ç”Ÿ', this.formatDate(content.first_occurrence_date))
      if (content.last_occurrence_date) {
        this.InfoRow('æœ€è¿‘å‘ç”Ÿ', this.formatDate(content.last_occurrence_date))
      }
      if (content.notes) {
        this.InfoRow('å¤‡æ³¨', content.notes)
      }
      if (content.attachments) {
        this.AttachmentList(content.attachments)
      }
    }
  }

  @Builder
  private ContentDetail() {
    if (this.record) {
      if (this.record.record_type === 'MEDICAL_HISTORY') {
        this.MedicalHistoryDetail(this.record.content_structured as MedicalHistoryContent)
      } else if (this.record.record_type === 'CHECK_REPORT') {
        this.CheckReportDetail(this.record.content_structured as CheckReportContent)
      } else if (this.record.record_type === 'MEDICATION') {
        this.MedicationDetail(this.record.content_structured as MedicationContent)
      } else if (this.record.record_type === 'ALLERGY') {
        this.AllergyDetail(this.record.content_structured as AllergyContent)
      }
    }
  }

  build() {
    NavDestination() {
      if (this.record) {
        Scroll() {
          Column() {
            // æ ‡é¢˜å¡ç‰‡
            Column() {
              Row() {
                Column() {
                  Text(this.getRecordTypeIcon(this.record.record_type))
                    .fontSize(28)
                }
                .width(56)
                .height(56)
                .borderRadius(28)
                .backgroundColor('#f1f5f9')
                .justifyContent(FlexAlign.Center)

                Column() {
                  Text(this.getRecordTypeName(this.record.record_type))
                    .fontSize(12)
                    .fontColor('#2563eb')
                    .backgroundColor('#eff6ff')
                    .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                    .borderRadius(8)
                  Text(this.record.record_title)
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#1e293b')
                    .margin({ top: 6 })
                  Text('è®°å½•æ—¥æœŸï¼š' + this.formatDate(this.record.record_date))
                    .fontSize(13)
                    .fontColor('#64748b')
                    .margin({ top: 4 })
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)
                .margin({ left: 14 })
              }
              .width('100%')
            }
            .width('100%')
            .padding(20)
            .backgroundColor(Color.White)
            .borderRadius(16)
            .shadow({ radius: 6, color: '#0f172a0a', offsetY: 2 })

            // è¯¦ç»†å†…å®¹å¡ç‰‡
            Column() {
              this.SectionTitle('è¯¦ç»†ä¿¡æ¯')
              this.ContentDetail()
            }
            .width('100%')
            .padding(20)
            .backgroundColor(Color.White)
            .borderRadius(16)
            .shadow({ radius: 6, color: '#0f172a0a', offsetY: 2 })
            .margin({ top: 16 })
          }
          .padding({ left: 16, right: 16, top: 16, bottom: 30 })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#f1f5f9')
        .scrollBar(BarState.Off)
      } else {
        Column() {
          Text('ğŸ“‹')
            .fontSize(48)
          Text('æ— æ³•åŠ è½½æ¡£æ¡ˆè¯¦æƒ…')
            .fontSize(16)
            .fontColor('#64748b')
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#f1f5f9')
      }
    }
    .title('æ¡£æ¡ˆè¯¦æƒ…')
    .backgroundColor('#f1f5f9')
  }
}

@Builder
export function HealthArchiveDetailPageBuilder() {
  HealthArchiveDetailPage()
}
