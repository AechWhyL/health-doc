import {
  ElderBasicInfo
} from '../../models/HealthArchiveModels';
import dayjs from 'dayjs';

@Builder
export function FamilyElderArchiveBuilder() {
  FamilyElderArchive()
}

@ComponentV2
export struct FamilyElderArchive {
  @Local private elder: ElderBasicInfo | null = null;
  
  navPathStack: NavPathStack = new NavPathStack();

  private formatBirthDate(dateStr: string): string {
    if (!dateStr) return 'æœªå¡«å†™';
    return dayjs(dateStr).format('YYYYå¹´MæœˆDæ—¥');
  }

  private getGenderEmoji(gender: number): string {
    return gender === 1 ? 'ðŸ‘´' : 'ðŸ‘µ';
  }

  private getGenderText(gender: number): string {
    return gender === 1 ? 'ç”·' : 'å¥³';
  }

  private openHealthRecordListPage(): void {
    if (!this.elder) return;

    this.navPathStack.pushPath({
      name: 'Family_HealthRecordList',
      param: this.elder
    });
  }

  @Builder
  private InfoRow(icon: string, label: string, value: string) {
    Row() {
      Text(icon + ' ' + label)
        .fontSize(13)
        .fontColor('#64748b')
        .width(120)
      Text(value)
        .fontSize(14)
        .fontColor('#1e293b')
        .layoutWeight(1)
    }
    .width('100%')
    .padding({ top: 10, bottom: 10 })
  }

  @Builder
  buildElderInfoCard() {
    if (this.elder) {
      Column() {
        // Header with avatar and basic info
        Row() {
          Column() {
            Text(this.getGenderEmoji(this.elder.gender))
              .fontSize(40)
          }
          .width(72)
          .height(72)
          .borderRadius(36)
          .backgroundColor('#f1f5f9')
          .justifyContent(FlexAlign.Center)

          Column() {
            Text(this.elder.name)
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1e293b')
            Text(this.getGenderText(this.elder.gender) + ' Â· ' + this.elder.age + 'å²')
              .fontSize(14)
              .fontColor('#64748b')
              .margin({ top: 4 })
          }
          .alignItems(HorizontalAlign.Start)
          .margin({ left: 16 })
        }
        .width('100%')

        // Detailed info
        Column() {
          this.InfoRow('ðŸ“±', 'ç”µè¯', this.elder.phone)
          this.InfoRow('ðŸŽ‚', 'å‡ºç”Ÿæ—¥æœŸ', this.formatBirthDate(this.elder.birth_date))
          this.InfoRow('ðŸ“', 'åœ°å€', this.elder.address || 'æœªå¡«å†™')
          this.InfoRow('ðŸ†˜', 'ç´§æ€¥è”ç³»äºº', this.elder.emergency_contact || 'æœªå¡«å†™')
          if (this.elder.blood_type) {
            this.InfoRow('ðŸ©¸', 'è¡€åž‹', this.elder.blood_type)
          }
          if (this.elder.height) {
            this.InfoRow('ðŸ“', 'èº«é«˜', this.elder.height + ' cm')
          }
          if (this.elder.weight) {
            this.InfoRow('âš–ï¸', 'ä½“é‡', this.elder.weight + ' kg')
          }
        }
        .margin({ top: 20 })
        .padding(16)
        .backgroundColor('#f8fafc')
        .borderRadius(12)
        .width('100%')
      }
      .width('100%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .shadow({ radius: 8, color: '#0f172a10', offsetY: 2 })
    }
  }

  @Builder
  buildHealthRecordEntryCard() {
    Column() {
      Row() {
        Column() {
          Text('ðŸ“‹')
            .fontSize(32)
        }
        .width(56)
        .height(56)
        .borderRadius(28)
        .backgroundColor('#eff6ff')
        .justifyContent(FlexAlign.Center)

        Column() {
          Text('å¥åº·æ¡£æ¡ˆ')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1e293b')
          Text('æŸ¥çœ‹ç—…å²ã€æ£€æŸ¥æŠ¥å‘Šã€ç”¨è¯è®°å½•ç­‰')
            .fontSize(13)
            .fontColor('#64748b')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 16 })

        Text('â€º')
          .fontSize(28)
          .fontColor('#cbd5e1')
      }
      .width('100%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .shadow({ radius: 8, color: '#0f172a10', offsetY: 2 })
      .onClick(() => {
        this.openHealthRecordListPage();
      })
    }
    .width('100%')
  }

  build() {
    NavDestination() {
      Scroll() {
        Column() {
          // Elder info card
          this.buildElderInfoCard()

          Blank(20)

          // Health record entry card
          this.buildHealthRecordEntryCard()

          Column().height(20)
        }
        .padding({ left: 16, right: 16, top: 16, bottom: 16 })
        .constraintSize({
          minHeight:"100%"
        })
      }
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .backgroundColor('#f1f5f9')
    }
    .title('è€äººè¯¦æƒ…')
    .onReady((ctx: NavDestinationContext) => {
      this.navPathStack = ctx.pathStack;
      this.elder = ctx.pathInfo.param as ElderBasicInfo;
    })
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f1f5f9')
  }
}
