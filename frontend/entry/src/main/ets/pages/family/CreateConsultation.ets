import { promptAction } from '@kit.ArkUI';
import { httpRequest } from '../../common/api/HttpUtil';
import { RequestEnum } from '../../common/api/httpEnum';

interface ApiResponse<T = Object> {
  code: number;
  message: string;
  data?: T;
  timestamp: number;
}

interface MedicalStaffInfo {
  id: number;
  user_id: number;
  gender: number;
  role_type: string;
  job_title: string | null;
  good_at_tags: string | null;
  real_name: string | null;
  username: string;
  phone: string | null;
}

interface MedicalStaffListData {
  items: MedicalStaffInfo[];
  total: number;
}

interface SearchParams {
  page: number;
  pageSize: number;
  goodAtTags?: string;
  phone?: string;
}

interface CreateQuestionRequest {
  title: string;
  description: string;
  creator_type: string;
  creator_id: number;
  target_staff_id: number;
  priority: string;
}

interface ConsultationQuestion {
  id: number;
  title: string;
}

@Component
export struct CreateConsultation {
  @Consume('navPathStack') navPathStack: NavPathStack;
  @State staffList: MedicalStaffInfo[] = [];
  @State isLoading: boolean = true;
  @State selectedStaff: MedicalStaffInfo | null = null;
  @State searchKeyword: string = '';
  @State searchPhone: string = '';
  @State questionTitle: string = '';
  @State questionContent: string = '';
  @State isSubmitting: boolean = false;
  @State showForm: boolean = false;

  aboutToAppear(): void {
    this.loadMedicalStaff();
  }

  private async loadMedicalStaff(): Promise<void> {
    this.isLoading = true;
    try {
      const params: SearchParams = { page: 1, pageSize: 50 };
      if (this.searchKeyword.trim()) {
        params.goodAtTags = this.searchKeyword.trim();
      }
      if (this.searchPhone.trim()) {
        params.phone = this.searchPhone.trim();
      }

      const response = await httpRequest<ApiResponse<MedicalStaffListData>, SearchParams>({
        url: '/api/v1/users/online-medical-staff',
        method: RequestEnum.GET,
        params: params
      });

      console.info('åŒ»æŠ¤äººå‘˜APIå“åº”:', JSON.stringify(response));

      if (response.code === 200 && response.data) {
        // å…¼å®¹ä¸¤ç§å¯èƒ½çš„æ•°æ®ç»“æ„
        const data = response.data as Object;
        if (Array.isArray((data as MedicalStaffListData).items)) {
          this.staffList = (data as MedicalStaffListData).items;
        } else if (Array.isArray((data as Record<string, MedicalStaffInfo[]>)['records'])) {
          this.staffList = (data as Record<string, MedicalStaffInfo[]>)['records'];
        } else {
          this.staffList = [];
        }
      }
    } catch (error) {
      console.error('è·å–åŒ»æŠ¤äººå‘˜åˆ—è¡¨å¤±è´¥:', error);
      promptAction.showToast({ message: 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isLoading = false;
    }
  }

  private selectStaff(staff: MedicalStaffInfo): void {
    this.selectedStaff = staff;
    this.showForm = true;
  }

  private async submitQuestion(): Promise<void> {
    if (!this.selectedStaff) {
      promptAction.showToast({ message: 'è¯·é€‰æ‹©å’¨è¯¢å¯¹è±¡' });
      return;
    }
    if (this.questionTitle.trim() === '') {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å’¨è¯¢æ ‡é¢˜' });
      return;
    }
    if (this.questionContent.trim() === '') {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å’¨è¯¢å†…å®¹' });
      return;
    }

    this.isSubmitting = true;
    try {
      const data: CreateQuestionRequest = {
        title: this.questionTitle.trim(),
        description: this.questionContent.trim(),
        creator_type: 'FAMILY',
        creator_id: 0,
        target_staff_id: this.selectedStaff.user_id,
        priority: 'NORMAL'
      };

      const response = await httpRequest<ApiResponse<ConsultationQuestion>, CreateQuestionRequest>({
        url: '/api/v1/consultation/questions',
        method: RequestEnum.POST,
        params: data
      });

      if (response.code === 200 || response.code === 201) {
        promptAction.showToast({ message: 'å’¨è¯¢å·²æäº¤' });
        this.navPathStack.pop();
      } else {
        promptAction.showToast({ message: response.message || 'æäº¤å¤±è´¥' });
      }
    } catch (error) {
      console.error('åˆ›å»ºå’¨è¯¢å¤±è´¥:', error);
      promptAction.showToast({ message: 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isSubmitting = false;
    }
  }

  private getRoleTypeText(roleType: string): string {
    switch (roleType) {
      case 'doctor': return 'åŒ»ç”Ÿ';
      case 'nurse': return 'æŠ¤å£«';
      case 'therapist': return 'æ²»ç–—å¸ˆ';
      default: return 'åŒ»æŠ¤äººå‘˜';
    }
  }

  @Builder
  private SearchBar() {
    Column() {
      Row() {
        TextInput({ text: this.searchKeyword, placeholder: 'æœç´¢æ“…é•¿é¢†åŸŸ...' })
          .height(40)
          .fontSize(14)
          .backgroundColor('#f1f5f9')
          .borderRadius(10)
          .layoutWeight(1)
          .onChange((value: string) => {
            this.searchKeyword = value;
          })
          .onSubmit(() => {
            this.loadMedicalStaff();
          })
      }
      .width('100%')

      Row() {
        TextInput({ text: this.searchPhone, placeholder: 'æ‰‹æœºå·æœç´¢...' })
          .height(40)
          .fontSize(14)
          .backgroundColor('#f1f5f9')
          .borderRadius(10)
          .layoutWeight(1)
          .onChange((value: string) => {
            this.searchPhone = value;
          })
          .onSubmit(() => {
            this.loadMedicalStaff();
          })

        Button('æœç´¢')
          .type(ButtonType.Capsule)
          .backgroundColor('#2563eb')
          .height(40)
          .width(70)
          .margin({ left: 10 })
          .onClick(() => {
            this.loadMedicalStaff();
          })
      }
      .width('100%')
      .margin({ top: 10 })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor(Color.White)
  }

  @Builder
  private StaffCard(staff: MedicalStaffInfo) {
    Row() {
      // å¤´åƒ
      Column() {
        Text(staff.gender === 0 ? 'ğŸ‘¨â€âš•ï¸' : 'ğŸ‘©â€âš•ï¸')
          .fontSize(28)
      }
      .width(56)
      .height(56)
      .borderRadius(28)
      .backgroundColor('#f1f5f9')
      .justifyContent(FlexAlign.Center)

      // ä¿¡æ¯
      Column() {
        Row() {
          Text(staff.real_name || staff.username)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1e293b')
          Text(this.getRoleTypeText(staff.role_type))
            .fontSize(11)
            .fontColor('#2563eb')
            .backgroundColor('#eff6ff')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(8)
            .margin({ left: 8 })
        }

        if (staff.job_title) {
          Text(staff.job_title)
            .fontSize(13)
            .fontColor('#64748b')
            .margin({ top: 4 })
        }

        if (staff.good_at_tags) {
          Text('æ“…é•¿: ' + staff.good_at_tags)
            .fontSize(12)
            .fontColor('#94a3b8')
            .margin({ top: 4 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 14 })

      // é€‰æ‹©æŒ‰é’®
      Button('å’¨è¯¢')
        .type(ButtonType.Capsule)
        .backgroundColor('#2563eb')
        .fontSize(13)
        .height(34)
        .width(64)
        .onClick(() => {
          this.selectStaff(staff);
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(14)
    .shadow({ radius: 4, color: '#0f172a0a', offsetY: 1 })
    .margin({ bottom: 10 })
  }

  @Builder
  private FormSection() {
    Column() {
      // å·²é€‰åŒ»æŠ¤äººå‘˜ä¿¡æ¯
      Row() {
        Column() {
          Text(this.selectedStaff?.gender === 0 ? 'ğŸ‘¨â€âš•ï¸' : 'ğŸ‘©â€âš•ï¸')
            .fontSize(24)
        }
        .width(48)
        .height(48)
        .borderRadius(24)
        .backgroundColor('#eff6ff')
        .justifyContent(FlexAlign.Center)

        Column() {
          Text('å’¨è¯¢å¯¹è±¡')
            .fontSize(12)
            .fontColor('#64748b')
          Text(this.selectedStaff?.real_name || this.selectedStaff?.username || '')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1e293b')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 12 })
        .layoutWeight(1)

        Text('æ›´æ¢')
          .fontSize(13)
          .fontColor('#2563eb')
          .onClick(() => {
            this.showForm = false;
          })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#f8fafc')
      .borderRadius(12)
      .margin({ bottom: 20 })

      // æ ‡é¢˜è¾“å…¥
      Text('å’¨è¯¢æ ‡é¢˜')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#374151')
        .alignSelf(ItemAlign.Start)
      TextInput({ text: this.questionTitle, placeholder: 'è¯·ç®€è¦æè¿°æ‚¨çš„é—®é¢˜' })
        .height(48)
        .fontSize(15)
        .backgroundColor('#f8fafc')
        .borderRadius(12)
        .margin({ top: 8, bottom: 20 })
        .onChange((value: string) => {
          this.questionTitle = value;
        })

      // å†…å®¹è¾“å…¥
      Text('è¯¦ç»†æè¿°')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#374151')
        .alignSelf(ItemAlign.Start)
      TextArea({ text: this.questionContent, placeholder: 'è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜æˆ–ç–‘æƒ‘ï¼Œä»¥ä¾¿åŒ»æŠ¤äººå‘˜æ›´å¥½åœ°ä¸ºæ‚¨è§£ç­”...' })
        .height(160)
        .fontSize(15)
        .backgroundColor('#f8fafc')
        .borderRadius(12)
        .margin({ top: 8, bottom: 24 })
        .onChange((value: string) => {
          this.questionContent = value;
        })

      // æäº¤æŒ‰é’®
      Button(this.isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤å’¨è¯¢')
        .type(ButtonType.Capsule)
        .backgroundColor('#2563eb')
        .width('100%')
        .height(50)
        .fontSize(16)
        .enabled(!this.isSubmitting)
        .onClick(() => {
          this.submitQuestion();
        })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 20, bottom: 30 })
  }

  build() {
    NavDestination() {
      Column() {
        if (!this.showForm) {
          // åŒ»æŠ¤äººå‘˜åˆ—è¡¨é¡µé¢
          this.SearchBar()

          if (this.isLoading) {
            Column() {
              LoadingProgress().width(40).height(40)
              Text('æ­£åœ¨åŠ è½½...').fontSize(14).fontColor('#64748b').margin({ top: 12 })
            }
            .width('100%')
            .layoutWeight(1)
            .justifyContent(FlexAlign.Center)
          } else if (this.staffList.length === 0) {
            Column() {
              Text('ğŸ‘¨â€âš•ï¸')
                .fontSize(48)
              Text('æš‚æ— å¯ç”¨çš„åŒ»æŠ¤äººå‘˜')
                .fontSize(16)
                .fontColor('#64748b')
                .margin({ top: 16 })
              Text('è¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ åŒ»æŠ¤äººå‘˜')
                .fontSize(13)
                .fontColor('#9ca3af')
                .margin({ top: 8 })
            }
            .width('100%')
            .layoutWeight(1)
            .justifyContent(FlexAlign.Center)
          } else {
            Scroll() {
              Column() {
                ForEach(this.staffList, (staff: MedicalStaffInfo) => {
                  this.StaffCard(staff)
                }, (staff: MedicalStaffInfo) => staff.id.toString())
              }
              .padding({ left: 16, right: 16, top: 12, bottom: 20 })
            }
            .layoutWeight(1)
            .scrollBar(BarState.Off)
          }
        } else {
          // å¡«å†™å’¨è¯¢è¡¨å•é¡µé¢
          Scroll() {
            this.FormSection()
          }
          .layoutWeight(1)
          .scrollBar(BarState.Off)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f1f5f9')
    }
    .title(this.showForm ? 'å¡«å†™å’¨è¯¢' : 'é€‰æ‹©å’¨è¯¢å¯¹è±¡')
    .backgroundColor('#f1f5f9')
  }
}

@Builder
export function CreateConsultationBuilder() {
  CreateConsultation()
}
