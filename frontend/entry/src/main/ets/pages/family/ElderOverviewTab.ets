import { promptAction } from '@kit.ArkUI';
import { httpRequest } from '../../common/api/HttpUtil';
import { RequestEnum } from '../../common/api/httpEnum';
import { ElderCard } from '../../components/family/ElderCard';

interface ApiResponse<T = Object> {
  code: number;
  message: string;
  data?: T;
  timestamp: number;
}

interface ElderResponse {
  id: number;
  user_id: number;
  name: string;
  gender: number;
  birth_date: string;
  phone: string;
  address: string | null;
  emergency_contact: string;
  height: number | null;
  weight: number | null;
  blood_type: string | null;
  age: number;
  created_at: string;
  updated_at: string;
}

interface UserElderRelationItem {
  relation_id: number;
  elder_id: number;
  relation_name: string | null;
  remark: string | null;
  elder: ElderResponse;
}

interface MyEldersListData {
  items: UserElderRelationItem[];
  total: number;
}

interface HealthJudgment {
  bp_level: 'NORMAL' | 'MILD' | 'MODERATE' | 'SEVERE';
  fpg_level: 'NORMAL' | 'MILD' | 'MODERATE' | 'SEVERE';
  ppg_level: 'NORMAL' | 'MILD' | 'MODERATE' | 'SEVERE';
}

interface HealthMeasurement {
  id: number;
  elder_id: number;
  measured_at: string;
  sbp?: number;
  dbp?: number;
  fpg?: number;
  ppg_2h?: number;
  weight?: number;
  steps?: number;
  source: string;
  remark?: string;
  judgment?: HealthJudgment;
}

interface HealthMeasurementListData {
  records: HealthMeasurement[];
  total: number;
  current: number;
  size: number;
}

interface HealthSummary {
  latestSbp?: number;
  latestDbp?: number;
  latestFpg?: number;
  hasWarning: boolean;
  warningText?: string;
  bpLevel?: string;
  fpgLevel?: string;
}

interface ElderWithHealth {
  relation: UserElderRelationItem;
  healthSummary: HealthSummary;
}

interface PaginationParams {
  page: number;
  pageSize: number;
}

interface ElderIdParams extends PaginationParams {
  elder_id: number;
  include_judgment?: boolean;
}

interface SearchElderParams {
  page: number;
  pageSize: number;
  phone: string;
}

interface ElderListData {
  items: ElderResponse[];
  total: number;
}

interface AddElderRelationRequest {
  elder_id: number;
  relation_name?: string;
  remark?: string;
}

interface AddElderRelationResponse {
  relation_id: number;
  elder_id: number;
  relation_name: string | null;
  remark: string | null;
}

@Component
export struct ElderOverviewTab {
  @Consume('navPathStack') navPathStack: NavPathStack;
  @State elders: ElderWithHealth[] = [];
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  // æœç´¢ç›¸å…³
  @State showAddDialog: boolean = false;
  @State searchPhone: string = '';
  @State searchResults: ElderResponse[] = [];
  @State isSearching: boolean = false;
  @State selectedElder: ElderResponse | null = null;
  @State relationName: string = '';
  @State isAdding: boolean = false;

  aboutToAppear(): void {
    this.loadElders();
  }

  private async loadElders(): Promise<void> {
    if (this.isLoading) {
      return;
    }
    this.isLoading = true;
    this.errorMessage = '';

    try {
      // è·å–å…³è”è€äººåˆ—è¡¨
      const params: PaginationParams = { page: 1, pageSize: 20 };
      const response = await httpRequest<ApiResponse<MyEldersListData>, PaginationParams>({
        url: '/api/v1/users/me/elders',
        method: RequestEnum.GET,
        params: params
      });

      if (response.code !== 200 || !response.data) {
        this.errorMessage = response.message || 'è·å–å…³è”è€äººå¤±è´¥';
        promptAction.showToast({ message: this.errorMessage });
        return;
      }

      const items = response.data.items || [];

      // ä¸ºæ¯ä¸ªè€äººè·å–æœ€æ–°å¥åº·æ•°æ®
      const eldersWithHealth: ElderWithHealth[] = [];
      for (const item of items) {
        const healthSummary = await this.fetchLatestHealth(item.elder.user_id);
        eldersWithHealth.push({
          relation: item,
          healthSummary: healthSummary
        });
      }

      this.elders = eldersWithHealth;
    } catch (error) {
      console.error('åŠ è½½å…³è”è€äººå¤±è´¥:', error);
      this.errorMessage = 'ç½‘ç»œå¼‚å¸¸ï¼Œæ— æ³•è·å–è€äººåˆ—è¡¨';
      promptAction.showToast({ message: this.errorMessage });
    } finally {
      this.isLoading = false;
    }
  }

  private async fetchLatestHealth(elderId: number): Promise<HealthSummary> {
    try {
      const healthParams: ElderIdParams = { 
        elder_id: elderId, 
        page: 1, 
        pageSize: 1,
        include_judgment: true
      };
      const response = await httpRequest<ApiResponse<HealthMeasurementListData>, ElderIdParams>({
        url: '/api/v1/elder-health/daily-health/list',
        method: RequestEnum.GET,
        params: healthParams
      });

      if (response.code === 200 && response.data && response.data.records.length > 0) {
        const latest = response.data.records[0];
        
        let hasWarning = false;
        let warningText: string | undefined = undefined;

        if (latest.judgment) {
          const warnings: string[] = [];
          // æ£€æŸ¥è¡€å‹
          if (latest.judgment.bp_level && latest.judgment.bp_level !== 'NORMAL') {
             if (latest.judgment.bp_level === 'SEVERE') warnings.push('è¡€å‹ä¸¥é‡åé«˜');
             else if (latest.judgment.bp_level === 'MODERATE') warnings.push('è¡€å‹ä¸­åº¦åé«˜');
             else warnings.push('è¡€å‹åé«˜');
          }
          // æ£€æŸ¥è¡€ç³– (ç©ºè…¹æˆ–é¤å)
          if (latest.judgment.fpg_level && latest.judgment.fpg_level !== 'NORMAL') {
             if (latest.judgment.fpg_level === 'SEVERE') warnings.push('è¡€ç³–ä¸¥é‡åé«˜');
             else if (latest.judgment.fpg_level === 'MODERATE') warnings.push('è¡€ç³–ä¸­åº¦åé«˜');
             else warnings.push('è¡€ç³–åé«˜');
          } else if (latest.judgment.ppg_level && latest.judgment.ppg_level !== 'NORMAL') {
             if (latest.judgment.ppg_level === 'SEVERE') warnings.push('è¡€ç³–ä¸¥é‡åé«˜');
             else if (latest.judgment.ppg_level === 'MODERATE') warnings.push('è¡€ç³–ä¸­åº¦åé«˜');
             else warnings.push('è¡€ç³–åé«˜');
          }

          if (warnings.length > 0) {
            hasWarning = true;
            warningText = warnings.join('ã€') + 'ï¼Œå»ºè®®å…³æ³¨';
          }
        } else {
          // Fallback if no judgment (though backend should return it if requested)
           const isBpHigh = (latest.sbp !== undefined && latest.sbp >= 140) ||
            (latest.dbp !== undefined && latest.dbp >= 90);
           const isBsHigh = (latest.fpg !== undefined && latest.fpg >= 7.0);
           
           if (isBpHigh || isBsHigh) {
             hasWarning = true;
             const warnings: string[] = [];
             if (isBpHigh) warnings.push('è¡€å‹åé«˜');
             if (isBsHigh) warnings.push('è¡€ç³–åé«˜');
             warningText = warnings.join('ã€') + 'ï¼Œå»ºè®®å…³æ³¨';
           }
        }

        return {
          latestSbp: latest.sbp,
          latestDbp: latest.dbp,
          latestFpg: latest.fpg,
          hasWarning: hasWarning,
          warningText: warningText,
          bpLevel: latest.judgment?.bp_level,
          fpgLevel: latest.judgment?.fpg_level
        };
      }
    } catch (error) {
      console.warn('è·å–å¥åº·æ•°æ®å¤±è´¥:', error);
    }

    return { hasWarning: false };
  }

  private openElderArchive(elder: ElderResponse): void {
    this.navPathStack.pushPath({
      name: 'Family_ElderArchive',
      param: elder
    });
  }

  private async searchElderByPhone(): Promise<void> {
    if (this.searchPhone.trim() === '') {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æ‰‹æœºå·' });
      return;
    }
    this.isSearching = true;
    this.searchResults = [];
    this.selectedElder = null;

    try {
      const params: SearchElderParams = { phone: this.searchPhone.trim(), page: 1, pageSize: 10 };
      const response = await httpRequest<ApiResponse<ElderListData>, SearchElderParams>({
        url: '/api/v1/elder-health/elder/list',
        method: RequestEnum.GET,
        params: params
      });

      if (response.code === 200 && response.data) {
        this.searchResults = response.data.items || [];
        if (this.searchResults.length === 0) {
          promptAction.showToast({ message: 'æœªæ‰¾åˆ°åŒ¹é…çš„è€äºº' });
        }
      } else {
        promptAction.showToast({ message: response.message || 'æœç´¢å¤±è´¥' });
      }
    } catch (error) {
      console.error('æœç´¢è€äººå¤±è´¥:', error);
      promptAction.showToast({ message: 'æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isSearching = false;
    }
  }

  private async addElderRelation(): Promise<void> {
    if (!this.selectedElder) {
      promptAction.showToast({ message: 'è¯·å…ˆé€‰æ‹©è¦æ·»åŠ çš„è€äºº' });
      return;
    }

    this.isAdding = true;
    try {
      const data: AddElderRelationRequest = {
        elder_id: this.selectedElder.user_id,
        relation_name: this.relationName.trim() || undefined
      };

      const response = await httpRequest<ApiResponse<AddElderRelationResponse>, AddElderRelationRequest>({
        url: '/api/v1/users/me/elders',
        method: RequestEnum.POST,
        params: data
      });

      if (response.code === 200 || response.code === 201) {
        promptAction.showToast({ message: 'æ·»åŠ æˆåŠŸ' });
        this.showAddDialog = false;
        this.searchPhone = '';
        this.searchResults = [];
        this.selectedElder = null;
        this.relationName = '';
        this.loadElders(); // åˆ·æ–°åˆ—è¡¨
      } else {
        promptAction.showToast({ message: response.message || 'æ·»åŠ å¤±è´¥' });
      }
    } catch (error) {
      console.error('æ·»åŠ è€äººå…³è”å¤±è´¥:', error);
      promptAction.showToast({ message: 'æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isAdding = false;
    }
  }

  build() {
    Stack() {
    Column() {
      // é¡µé¢æ ‡é¢˜
      Row() {
        Column() {
          Text('å…³è”è€äºº')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1e293b')
          Text('å®æ—¶æŸ¥çœ‹è€äººå¥åº·çŠ¶æ€')
            .fontSize(13)
            .fontColor('#64748b')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        Button('+ æ·»åŠ è€äºº')
          .type(ButtonType.Capsule)
          .backgroundColor('#2563eb')
          .fontSize(13)
          .height(36)
          .onClick(() => {
            this.showAddDialog = true;
            this.searchPhone = '';
            this.searchResults = [];
            this.selectedElder = null;
            this.relationName = '';
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 12 })

      // åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('æ­£åœ¨åŠ è½½...')
            .fontSize(14)
            .fontColor('#64748b')
            .margin({ top: 12 })
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else if (this.errorMessage !== '') {
        // é”™è¯¯çŠ¶æ€
        Column() {
          Text('ğŸ˜”')
            .fontSize(40)
          Text(this.errorMessage)
            .fontSize(14)
            .fontColor('#ef4444')
            .margin({ top: 12 })
          Button('é‡æ–°åŠ è½½')
            .type(ButtonType.Capsule)
            .backgroundColor('#2563eb')
            .margin({ top: 16 })
            .onClick(() => {
              this.loadElders();
            })
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else if (this.elders.length === 0) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦')
            .fontSize(48)
          Text('æš‚æ— å…³è”è€äºº')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#374151')
            .margin({ top: 16 })
          Text('è¯·è”ç³»åŒ»æŠ¤äººå‘˜æ·»åŠ è€äººå…³è”å…³ç³»')
            .fontSize(13)
            .fontColor('#9ca3af')
            .margin({ top: 8 })
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      } else {
        // è€äººå¡ç‰‡åˆ—è¡¨
        Scroll() {
          Column() {
            ForEach(this.elders, (item: ElderWithHealth) => {
              ElderCard({
                elderName: item.relation.elder.name,
                elderAge: item.relation.elder.age,
                elderGender: item.relation.elder.gender,
                elderPhone: item.relation.elder.phone,
                relationName: item.relation.relation_name || '',
                healthSummary: item.healthSummary,
                onCardClick: () => {
                  this.openElderArchive(item.relation.elder);
                },
                onViewArchive: () => {
                  this.openElderArchive(item.relation.elder);
                }
              })
            }, (item: ElderWithHealth) => item.relation.relation_id.toString())
          }
          .padding({ left: 16, right: 16, bottom: 20 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')

    // æœç´¢æ·»åŠ è€äººå¼¹çª—
    if (this.showAddDialog) {
      Column() {
        Column() {
          Text('æ·»åŠ å…³è”è€äºº')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1e293b')
            .margin({ bottom: 16 })

          // æ‰‹æœºå·æœç´¢
          Text('è¾“å…¥è€äººæ‰‹æœºå·æœç´¢')
            .fontSize(13)
            .fontColor('#64748b')
            .alignSelf(ItemAlign.Start)
          Row() {
            TextInput({ text: this.searchPhone, placeholder: 'è¯·è¾“å…¥æ‰‹æœºå·' })
              .height(44)
              .fontSize(14)
              .backgroundColor('#f8fafc')
              .borderRadius(10)
              .layoutWeight(1)
              .onChange((value: string) => {
                this.searchPhone = value;
              })
            Button(this.isSearching ? '...' : 'æœç´¢')
              .type(ButtonType.Capsule)
              .backgroundColor('#2563eb')
              .height(44)
              .width(70)
              .margin({ left: 10 })
              .enabled(!this.isSearching)
              .onClick(() => {
                this.searchElderByPhone();
              })
          }
          .width('100%')
          .margin({ top: 6, bottom: 14 })

          // æœç´¢ç»“æœ
          if (this.searchResults.length > 0) {
            Text('æœç´¢ç»“æœ')
              .fontSize(13)
              .fontColor('#64748b')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })

            ForEach(this.searchResults, (elder: ElderResponse) => {
              Row() {
                Column() {
                  Text(elder.gender === 1 ? 'ğŸ‘´' : 'ğŸ‘µ').fontSize(24)
                }
                .width(40)
                .height(40)
                .borderRadius(20)
                .backgroundColor('#f1f5f9')
                .justifyContent(FlexAlign.Center)

                Column() {
                  Text(elder.name)
                    .fontSize(14)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#1e293b')
                  Text(elder.phone + ' Â· ' + elder.age + 'å²')
                    .fontSize(12)
                    .fontColor('#64748b')
                    .margin({ top: 2 })
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)
                .margin({ left: 10 })

                if (this.selectedElder && this.selectedElder.id === elder.id) {
                  Text('âœ“')
                    .fontSize(16)
                    .fontColor('#16a34a')
                } else {
                  Text('é€‰æ‹©')
                    .fontSize(13)
                    .fontColor('#2563eb')
                }
              }
              .width('100%')
              .padding(12)
              .backgroundColor(this.selectedElder && this.selectedElder.id === elder.id ? '#eff6ff' : '#f8fafc')
              .borderRadius(10)
              .margin({ bottom: 8 })
              .onClick(() => {
                this.selectedElder = elder;
              })
            }, (elder: ElderResponse) => elder.id.toString())
          }

          // å…³ç³»åç§°
          if (this.selectedElder) {
            Text('ä¸è€äººçš„å…³ç³»ï¼ˆå¯é€‰ï¼‰')
              .fontSize(13)
              .fontColor('#64748b')
              .alignSelf(ItemAlign.Start)
              .margin({ top: 8 })
            TextInput({ text: this.relationName, placeholder: 'å¦‚ï¼šçˆ¶äº²ã€æ¯äº²' })
              .height(44)
              .fontSize(14)
              .backgroundColor('#f8fafc')
              .borderRadius(10)
              .margin({ top: 6, bottom: 16 })
              .onChange((value: string) => {
                this.relationName = value;
              })
          }

          // æŒ‰é’®
          Row() {
            Button('å–æ¶ˆ')
              .type(ButtonType.Capsule)
              .backgroundColor('#f1f5f9')
              .fontColor('#64748b')
              .layoutWeight(1)
              .height(44)
              .margin({ right: 10 })
              .onClick(() => {
                this.showAddDialog = false;
              })

            Button(this.isAdding ? 'æ·»åŠ ä¸­...' : 'ç¡®è®¤æ·»åŠ ')
              .type(ButtonType.Capsule)
              .backgroundColor(this.selectedElder ? '#2563eb' : '#cbd5e1')
              .layoutWeight(1)
              .height(44)
              .enabled(!!this.selectedElder && !this.isAdding)
              .onClick(() => {
                this.addElderRelation();
              })
          }
          .width('100%')
          .margin({ top: 8 })
        }
        .width('90%')
        .padding(24)
        .backgroundColor(Color.White)
        .borderRadius(20)
        .shadow({ radius: 20, color: '#0002' })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#00000066')
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        this.showAddDialog = false;
      })
    }
    }
    .width('100%')
    .height('100%')
  }
}
