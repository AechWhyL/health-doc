import { TaskDetailNavParam, ElderTaskInstanceInfo, ElderPlanItemInfo, ElderPlanInfo } from './ElderHomeTab';
import { CheckInNavParam } from './ElderTaskCheckInPage';
import { httpRequest } from '../../common/api/HttpUtil';
import { RequestEnum } from '../../common/api/httpEnum';
import { promptAction } from '@kit.ArkUI';
import { data } from '@kit.TelephonyKit';
import dayjs from 'dayjs';

interface ApiResponse<T = Object> {
  code: number;
  message: string;
  data?: T;
  timestamp: number;
}

interface TaskInstanceResponse {
  id: number;
  item_id: number;
  schedule_id: number | null;
  task_date: string;
  task_time: string | null;
  status: string;
  complete_time: string | null;
  remark: string | null;
  proof_image_url: string | null;
  created_at: string;
  updated_at: string;
}

@Builder
export function ElderTaskDetailPageBuilder() {
  ElderTaskDetailPage()
}

@Component
export struct ElderTaskDetailPage {
  @Consume('navPathStack') navPathStack: NavPathStack;
  @State task: ElderTaskInstanceInfo | null = null;
  @State planItem: ElderPlanItemInfo | null = null;
  @State plan: ElderPlanInfo | null = null;
  @State isRefreshing: boolean = false;

  aboutToAppear(): void {
    const params = this.navPathStack.getParamByName('Elder_TaskDetail') as TaskDetailNavParam[];
    if (params && params.length > 0) {
      const param = params[params.length - 1];
      this.task = param.task;
      this.planItem = param.plan_item;
      this.plan = param.plan;
    }
    console.log("[check in page] about to appear");
  }

  private async refreshTaskStatus(): Promise<void> {
    if (!this.task || this.isRefreshing) {
      return;
    }
    console.log("[check in page] refreshing task status");

    this.isRefreshing = true;
    try {
      // è°ƒç”¨APIè·å–æœ€æ–°çš„ä»»åŠ¡å®ä¾‹çŠ¶æ€
      const params: Record<string, Object> = {};
      const response = await httpRequest<ApiResponse<TaskInstanceResponse>, Record<string, Object>>({
        url: `/api/v1/intervention/tasks/${this.task.id}`,
        method: RequestEnum.GET,
        params: params
      });

      if (response.code === 200 && response.data) {
        // ç›´æ¥æ›´æ–°task stateçš„å±æ€§ä»¥è§¦å‘UIå“åº”
        this.task = {
          id:response.data.id,
          item_id:response.data.item_id,
          schedule_id:response.data.item_id,
          task_time:response.data.task_time,
          task_date:response.data.task_date,
          status: response.data.status,
          complete_time: response.data.complete_time,
          remark: response.data.remark,
          proof_image_url: response.data.proof_image_url
        };
      }
    } catch (error) {
      console.error('åˆ·æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
    } finally {
      this.isRefreshing = false;
    }
  }

  private formatDate(dateStr: string | null): string {
    if (!dateStr) return 'æœªå®š';
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  private getStatusText(status: string): string {
    switch (status) {
      case 'ACTIVE': return 'è¿›è¡Œä¸­';
      case 'PAUSED': return 'å·²æš‚åœ';
      case 'STOPPED': return 'å·²åœæ­¢';
      case 'PENDING': return 'å¾…å®Œæˆ';
      case 'COMPLETED': return 'å·²å®Œæˆ';
      case 'SKIPPED': return 'å·²è·³è¿‡';
      case 'MISSED': return 'å·²é”™è¿‡';
      case 'DRAFT': return 'è‰ç¨¿';
      case 'FINISHED': return 'å·²å®Œæˆ';
      case 'CANCELLED': return 'å·²å–æ¶ˆ';
      default: return status;
    }
  }

  private getStatusColor(status: string): string {
    switch (status) {
      case 'ACTIVE': return '#16a34a';
      case 'PENDING': return '#f59e0b';
      case 'COMPLETED': return '#16a34a';
      case 'FINISHED': return '#16a34a';
      case 'PAUSED': return '#6b7280';
      case 'STOPPED': return '#dc2626';
      case 'SKIPPED': return '#9ca3af';
      case 'MISSED': return '#dc2626';
      case 'CANCELLED': return '#dc2626';
      default: return '#64748b';
    }
  }

  @Builder
  private PlanCard() {
    if (this.plan) {
      Column() {
        Row() {
          Text('ğŸ“‹')
            .fontSize(18)
          Text('æ‰€å±è®¡åˆ’')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#166534')
            .margin({ left: 8 })
        }
        .width('100%')
        .margin({ bottom: 16 })

        Column() {
          Row() {
            Text(this.plan.title)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              . fontColor('#1e293b')
              .layoutWeight(1)

            Text(this.getStatusText(this.plan.status))
              .fontSize(12)
              .fontColor(Color.White)
              .backgroundColor(this.getStatusColor(this.plan.status))
              .borderRadius(4)
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          }
          .width('100%')
 
          if (this.plan.description) {
            Text(this.plan.description)
              .fontSize(14)
              .fontColor('#64748b')
              .margin({ top: 8 })
              .width('100%')
          }

          Divider()
            .strokeWidth(1)
            .color('#e5e7eb')
            .margin({ top: 12, bottom: 12 })

          Row() {
            Column() {
              Text('å¼€å§‹æ—¥æœŸ')
                .fontSize(12)
                .fontColor('#9ca3af')
              Text(this.formatDate(this.plan.start_date))
                .fontSize(14)
                .fontColor('#374151')
                .margin({ top: 4 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)

            Column() {
              Text('ç»“æŸæ—¥æœŸ')
                .fontSize(12)
                .fontColor('#9ca3af')
              Text(this.formatDate(this.plan.end_date))
                .fontSize(14)
                .fontColor('#374151')
                .margin({ top: 4 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)
          }
          .width('100%')
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#f8fafc')
        .borderRadius(12)
      }
      .width('100%')
      .padding(18)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .shadow({ radius: 6, color: '#0f172a0a', offsetY: 2 })
      .margin({ bottom: 14 })
    }
  }

  @Builder
  private PlanItemCard() {
    if (this.planItem) {
      Column() {
        Row() {
          Text(this.planItem.item_type === 'MEDICATION' ? 'ğŸ’Š' : 'ğŸƒ')
            .fontSize(18)
          Text('è®¡åˆ’é¡¹è¯¦æƒ…')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#166534')
            .margin({ left: 8 })
        }
        .width('100%')
        .margin({ bottom: 16 })

        Column() {
          Row() {
            Text(this.planItem.name)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1e293b')
              .layoutWeight(1)

            Text(this.getStatusText(this.planItem.status))
              .fontSize(12)
              .fontColor(Color.White)
              .backgroundColor(this.getStatusColor(this.planItem.status))
              .borderRadius(4)
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          }
          .width('100%')

          Row() {
            Text(this.planItem.item_type === 'MEDICATION' ? 'ç”¨è¯æé†’' : 'åº·å¤è®­ç»ƒ')
              .fontSize(12)
              .fontColor('#3b82f6')
              .backgroundColor('#eff6ff')
              .borderRadius(4)
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .margin({ top: 8 })
          }
          .width('100%')

          if (this.planItem.description) {
            Text(this.planItem.description)
              .fontSize(14)
              .fontColor('#64748b')
              .margin({ top: 8 })
              .width('100%')
          }

          Divider()
            .strokeWidth(1)
            .color('#e5e7eb')
            .margin({ top: 12, bottom: 12 })

          // ç”¨è¯è¯¦æƒ…
          if (this.planItem.item_type === 'MEDICATION') {
            Column() {
              if (this.planItem.drug_name) {
                Row() {
                  Text('è¯å“åç§°ï¼š')
                    .fontSize(14)
                    .fontColor('#6b7280')
                  Text(this.planItem.drug_name)
                    .fontSize(14)
                    .fontColor('#1e293b')
                    .fontWeight(FontWeight.Medium)
                }
                .width('100%')
                .margin({ bottom: 8 })
              }

              if (this.planItem.dosage) {
                Row() {
                  Text('å‰‚é‡ï¼š')
                    .fontSize(14)
                    .fontColor('#6b7280')
                  Text(this.planItem.dosage)
                    .fontSize(14)
                    .fontColor('#1e293b')
                }
                .width('100%')
                .margin({ bottom: 8 })
              }

              if (this.planItem.frequency_type) {
                Row() {
                  Text('ç”¨è¯é¢‘æ¬¡ï¼š')
                    .fontSize(14)
                    .fontColor('#6b7280')
                  Text(this.planItem.frequency_type)
                    .fontSize(14)
                    .fontColor('#1e293b')
                }
                .width('100%')
                .margin({ bottom: 8 })
              }

              if (this.planItem.instructions) {
                Column() {
                  Text('ç”¨è¯æŒ‡ç¤ºï¼š')
                    .fontSize(14)
                    .fontColor('#6b7280')
                  Text(this.planItem.instructions)
                    .fontSize(14)
                    .fontColor('#1e293b')
                    .margin({ top: 4 })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
              }
            }
            .width('100%')
          }

          // åº·å¤è¯¦æƒ…
          if (this.planItem.item_type === 'REHAB') {
            Column() {
              if (this.planItem.exercise_name) {
                Row() {
                  Text('è®­ç»ƒåç§°ï¼š')
                    .fontSize(14)
                    .fontColor('#6b7280')
                  Text(this.planItem.exercise_name)
                    .fontSize(14)
                    .fontColor('#1e293b')
                    .fontWeight(FontWeight.Medium)
                }
                .width('100%')
                .margin({ bottom: 8 })
              }

              if (this.planItem.exercise_type) {
                Row() {
                  Text('è®­ç»ƒç±»å‹ï¼š')
                    .fontSize(14)
                    .fontColor('#6b7280')
                  Text(this.planItem.exercise_type)
                    .fontSize(14)
                    .fontColor('#1e293b')
                }
                .width('100%')
                .margin({ bottom: 8 })
              }

              if (this.planItem.guide_resource_url) {
                Row() {
                  Text('è®­ç»ƒæŒ‡å¯¼ï¼š')
                    .fontSize(14)
                    .fontColor('#6b7280')
                  Text('æŸ¥çœ‹èµ„æº')
                    .fontSize(14)
                    .fontColor('#3b82f6')
                    .decoration({ type: TextDecorationType.Underline })
                }
                .width('100%')
              }
            }
            .width('100%')
          }

          Divider()
            .strokeWidth(1)
            .color('#e5e7eb')
            .margin({ top: 12, bottom: 12 })

          Row() {
            Column() {
              Text('å¼€å§‹æ—¥æœŸ')
                .fontSize(12)
                .fontColor('#9ca3af')
              Text(this.formatDate(this.planItem.start_date))
                .fontSize(14)
                .fontColor('#374151')
                .margin({ top: 4 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)

            Column() {
              Text('ç»“æŸæ—¥æœŸ')
                .fontSize(12)
                .fontColor('#9ca3af')
              Text(this.formatDate(this.planItem.end_date))
                .fontSize(14)
                .fontColor('#374151')
                .margin({ top: 4 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)
          }
          .width('100%')
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#f8fafc')
        .borderRadius(12)
      }
      .width('100%')
      .padding(18)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .shadow({ radius: 6, color: '#0f172a0a', offsetY: 2 })
      .margin({ bottom: 14 })
    }
  }

  @Builder
  private TaskStatusCard() {
    if (this.task) {
      Column() {
        Row() {
          Row() {
            Text('ğŸ“')
              .fontSize(18)
            Text('ä»Šæ—¥ä»»åŠ¡')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#166534')
              .margin({ left: 8 })
          }
          .layoutWeight(1)

          // ç­¾åˆ°æŒ‰é’®æˆ–å·²å®Œæˆæ ‡è¯†
          if (this.task.status === 'COMPLETED') {
            Text('âœ“ å·²å®Œæˆ')
              .fontSize(13)
              .fontColor('#16a34a')
              .fontWeight(FontWeight.Medium)
          } else if (this.task.status === 'PENDING') {
            Button('ç­¾åˆ°')
              .fontSize(13)
              .fontColor(Color.White)
              .backgroundColor('#16a34a')
              .borderRadius(16)
              .padding({ left: 16, right: 16, top: 6, bottom: 6 })
              .onClick(() => {
                const navParam: CheckInNavParam = {
                  taskInstanceId: this.task!.id,
                  taskName: this.planItem!.name
                };
                this.navPathStack.pushPathByName('Elder_TaskCheckIn', navParam);
              })
          }
        }
        .width('100%')
        .margin({ bottom: 16 })

        Column() {
          Row() {
            Text('ä»»åŠ¡çŠ¶æ€')
              .fontSize(14)
              .fontColor('#6b7280')
            Blank()
            Text(this.getStatusText(this.task.status))
              .fontSize(14)
              .fontColor(this.getStatusColor(this.task.status))
              .fontWeight(FontWeight.Medium)
          }
          .width('100%')
          .margin({ bottom: 12 })

          Row() {
            Text('ä»»åŠ¡æ—¥æœŸ')
              .fontSize(14)
              .fontColor('#6b7280')
            Blank()
            Text(this.formatDate(this.task.task_date))
              .fontSize(14)
              .fontColor('#374151')
          }
          .width('100%')
          .margin({ bottom: 12 })

          if (this.task.task_time) {
            Row() {
              Text('ä»»åŠ¡æ—¶é—´')
                .fontSize(14)
                .fontColor('#6b7280')
              Blank()
              Text(this.task.task_time)
                .fontSize(14)
                .fontColor('#374151')
            }
            .width('100%')
            .margin({ bottom: 12 })
          }

          if (this.task.complete_time) {
            Row() {
              Text('å®Œæˆæ—¶é—´')
                .fontSize(14)
                .fontColor('#6b7280')
              Blank()
              Text(dayjs(this.task.complete_time).format('YYYY-MM-DD,HH:mm:ss'))
                .fontSize(14)
                .fontColor('#16a34a')
            }
            .width('100%')
            .margin({ bottom: 12 })
          }

          if (this.task.remark) {
            Column() {
              Text('å¤‡æ³¨')
                .fontSize(14)
                .fontColor('#6b7280')
              Text(this.task.remark)
                .fontSize(14)
                .fontColor('#374151')
                .margin({ top: 4 })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
          }
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#f8fafc')
        .borderRadius(12)
      }
      .width('100%')
      .padding(18)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .shadow({ radius: 6, color: '#0f172a0a', offsetY: 2 })
    }
  }

  build() {
    NavDestination() {
      Column() {
        if (!this.task || !this.planItem || !this.plan) {
          Column() {
            Text('åŠ è½½ä¸­...')
              .fontSize(16)
              .fontColor('#64748b')
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
        } else {
          Scroll() {
            Column() {
              this.TaskStatusCard()
              this.PlanItemCard()
              this.PlanCard()
            }
            .padding({ left: 16, right: 16, top: 16, bottom: 20 })
          }
          .layoutWeight(1)
          .scrollBar(BarState.Off)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f0fdf4')
    }
    .title('ä»»åŠ¡è¯¦æƒ…')
    .backgroundColor('#f0fdf4')
    .onResult(()=>{
      this.refreshTaskStatus()
    })
  }
}
