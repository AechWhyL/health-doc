import { ElderHomeTab } from './ElderHomeTab';
import { ElderHealthTab } from './ElderHealthTab';
import { ElderConsultationTab } from './ElderConsultationTab';
import { ElderProfileTab } from './ElderProfileTab';
import { InterventionIndex } from '../medical/intervention/InterventionIndex';
import { GlobalSocketManager } from '../../components/GlobalSocketManager';
import { SocketService } from '../../common/api/SocketService';
import { NotificationService, ConsultationReplyNotification, TaskReminderNotification } from '../../services/NotificationService';
import { UserWithRoleResponse } from '../Login';

type ElderTabKey = 'home' | 'health' | 'intervention' | 'consult' | 'profile';

@Entry
@Component
struct ElderIndex {
  @Provide('navPathStack') navPathStack: NavPathStack = new NavPathStack();
  @State currentTab: ElderTabKey = 'home';

  private switchTab(tab: ElderTabKey): void {
    this.currentTab = tab;
  }

  /**
   * WebSocket åˆå§‹åŒ–å®Œæˆåçš„å¤„ç†
   */
  private onSocketInitialized = (): void => {
    console.log('[ElderIndex] WebSocket initialized, registering listeners');
    const socketService = SocketService.getInstance();
    
    // 1. è¯·æ±‚é€šçŸ¥æƒé™
    NotificationService.requestPermission();

    // 2. æ³¨å†Œå’¨è¯¢å›å¤é€šçŸ¥ç›‘å¬
    socketService.on<ConsultationReplyNotification>('notification:consultation_reply', (data) => {
      console.log('[ElderIndex] Received consultation reply:', data);
      NotificationService.showConsultationReplyNotification(new ConsultationReplyNotification(data));
    });

    // 3. æ³¨å†Œä»»åŠ¡æé†’é€šçŸ¥ç›‘å¬ (è€äººç«¯å…³æ³¨è‡ªå·±çš„å¾…åŠ)
    socketService.on<TaskReminderNotification>('notification:task_reminder', (data) => {
      console.log('[ElderIndex] Received task reminder:', data);
      NotificationService.showTaskReminderNotification(new TaskReminderNotification(data));
    });

    // 4. ç»‘å®šç”¨æˆ·
    const user:UserWithRoleResponse|undefined = AppStorage.get<UserWithRoleResponse>('currentUser');
    if (user) {
      socketService.bindUser(user.id);
    }
  }

  @Builder
  private TabIcon(tab: ElderTabKey, icon: string, label: string) {
    Column() {
      Text(icon)
        .fontSize(22)
        .fontColor(this.currentTab === tab ? '#16a34a' : '#9ca3af')
      Text(label)
        .fontSize(10)
        .fontColor(this.currentTab === tab ? '#16a34a' : '#6b7280')
        .margin({ top: 2 })
    }
    .layoutWeight(1)
    .alignItems(HorizontalAlign.Center)
    .padding({ top: 8, bottom: 8 })
    .onClick(() => {
      this.switchTab(tab);
    })
  }

  build() {
    Stack() {
      // å…¨å±€ WebSocket ç®¡ç†å™¨ (éšè—è§†å›¾ï¼Œç”Ÿå‘½å‘¨æœŸéšæ­¤é¦–é¡µ)
      GlobalSocketManager({
        onInitialized: this.onSocketInitialized
      })

      Column() {
        Navigation(this.navPathStack) {
          Column() {
            // ä¸»å†…å®¹åŒºåŸŸ
            if (this.currentTab === 'home') {
              ElderHomeTab()
            } else if (this.currentTab === 'health') {
              ElderHealthTab()
            } else if (this.currentTab === 'consult') {
              ElderConsultationTab()
            } else if (this.currentTab === 'profile') {
              ElderProfileTab()
            }
          }
          .layoutWeight(1)
          .width('100%')
          .backgroundColor('#f0fdf4')

          // åº•éƒ¨å¯¼èˆªæ 
          Row() {
            this.TabIcon('home', 'ğŸ ', 'é¦–é¡µ')
            this.TabIcon('health', 'â¤ï¸', 'å¥åº·')
            this.TabIcon('consult', 'ğŸ’¬', 'å’¨è¯¢')
            this.TabIcon('profile', 'ğŸ‘¤', 'æˆ‘çš„')
          }
          .width('100%')
          .backgroundColor(Color.White)
          .border({
            width: { top: 1 },
            color: '#e5e7eb'
          })
          .padding({
            left: 8,
            right: 8,
            bottom: 16
          })
        }
        .width('100%')
        .title('å¥åº·å…³æŠ¤ Â· é•¿è¾ˆç‰ˆ')
        .titleMode(NavigationTitleMode.Mini)
        .hideBackButton(true)
        .mode(NavigationMode.Stack)
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f0fdf4')
  }
}
