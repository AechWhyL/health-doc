import { promptAction } from '@kit.ArkUI';
import { httpRequest } from '../../common/api/HttpUtil';
import { RequestEnum } from '../../common/api/httpEnum';

interface ApiResponse<T = Object> {
  code: number;
  message: string;
  data?: T;
  timestamp: number;
}

interface UserResponse {
  id: number;
  username: string;
  role: string;
  elder_info?: ElderResponse;
}

interface ElderResponse {
  id: number;
  name: string;
  gender: number;
  age: number;
  phone: string;
  address: string | null;
  emergency_contact: string | null;
  height: number | null;
  weight: number | null;
  blood_type: string | null;
  birth_date?: string;
}



// æ–°çš„ä»Šæ—¥ä»»åŠ¡APIå“åº”ç±»å‹
export interface ElderTaskInstanceInfo {
  id: number;
  item_id: number;
  schedule_id: number | null;
  task_date: string;
  task_time: string | null;
  status: string;
  complete_time: string | null;
  remark: string | null;
  proof_image_url: string | null;
}

export interface ElderPlanItemInfo {
  id: number;
  plan_id: number;
  item_type: string;
  name: string;
  description: string | null;
  status: string;
  start_date: string;
  end_date: string | null;
  drug_name?: string;
  dosage?: string;
  frequency_type?: string;
  instructions?: string | null;
  exercise_name?: string;
  exercise_type?: string | null;
  guide_resource_url?: string | null;
}

export interface ElderPlanInfo {
  id: number;
  elder_user_id: number;
  title: string;
  description: string | null;
  status: string;
  start_date: string;
  end_date: string | null;
}

interface ElderTasksByPlanItem {
  plan_item: ElderPlanItemInfo;
  tasks: ElderTaskInstanceInfo[];
}

interface ElderTasksByPlan {
  plan: ElderPlanInfo;
  items: ElderTasksByPlanItem[];
}

interface ElderTodayTasksResponse {
  date: string;
  total_tasks: number;
  completed_tasks: number;
  plans: ElderTasksByPlan[];
}

// ç”¨äºä¼ é€’ç»™è¯¦æƒ…é¡µçš„æ•°æ®
export interface TaskDetailNavParam {
  task: ElderTaskInstanceInfo;
  plan_item: ElderPlanItemInfo;
  plan: ElderPlanInfo;
}

@Component
export struct ElderHomeTab {
  @Consume('navPathStack') navPathStack: NavPathStack;
  @State elderId: number = -1;
  @State elderName: string = '';
  @State elderInfo: ElderResponse | null = null;

  @State todayTasksData: ElderTodayTasksResponse | null = null;
  @State isLoading: boolean = true;
  @State profileIncomplete: boolean = false;
  @State missingFields: string[] = [];

  aboutToAppear(): void {
    this.loadData();
    this.navPathStack.setInterception({
      willShow: (from: NavDestinationContext | 'navBar', to: NavDestinationContext | 'navBar') => {
        if (typeof from === 'string') {
          let target = to as NavDestinationContext;
          console.info(`from page is navigation home -> ${target.pathInfo.name}`);
        } else if (typeof to === 'string') {
          let target = from as NavDestinationContext;
          console.info(`${target.pathInfo.name} -> to page is navigation home`);
          this.loadData()
        }
      }
    });
  }

  private async loadData(): Promise<void> {
    this.isLoading = true;

    try {
      // åœ¨è€äººç«¯ï¼Œå½“å‰ç™»å½•ç”¨æˆ·å³ä¸ºè€äººæœ¬äºº
      // ç›´æ¥è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯åŠæ¡£æ¡ˆ
      const response = await httpRequest<ApiResponse<UserResponse>, void>({
        url: '/api/v1/users/current',
        method: RequestEnum.GET
      });

      if (response.code === 200 && response.data) {
        const user = response.data;
        this.elderId = user.id; // å½“å‰ç”¨æˆ·IDå³ä¸ºè€äººID
        
        if (user.elder_info) {
          const elder = user.elder_info;
          this.elderName = elder.name;
          this.elderInfo = elder;
          this.checkProfileCompleteness(elder);
        } else {
          // åªæœ‰åŸºæœ¬ç”¨æˆ·è´¦å·ï¼Œæœªå®Œå–„è€äººä¿¡æ¯
          this.elderName = user.username;
        }


        // è·å–ä»Šæ—¥ä»»åŠ¡
        await this.loadTodayTasks();
      }
    } catch (error) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  private checkProfileCompleteness(elder: ElderResponse): void {
    const missing: string[] = [];
    if (!elder.address) {
      missing.push('å®¶åº­ä½å€');
    }
    if (!elder.emergency_contact) {
      missing.push('ç´§æ€¥è”ç³»äºº');
    }
    if (!elder.height) {
      missing.push('èº«é«˜');
    }
    if (!elder.weight) {
      missing.push('ä½“é‡');
    }
    if (!elder.blood_type) {
      missing.push('è¡€å‹');
    }
    this.missingFields = missing;
    this.profileIncomplete = missing.length > 0;
  }



  private async loadTodayTasks(): Promise<void> {
    try {
      const params: Record<string, Object> = {};
      const response = await httpRequest<ApiResponse<ElderTodayTasksResponse>, Record<string, Object>>({
        url: '/api/v1/intervention/elder/today-tasks',
        method: RequestEnum.GET,
        params: params
      });

      if (response.code === 200 && response.data) {
        this.todayTasksData = response.data;
      }
    } catch (error) {
      console.warn('è·å–ä»Šæ—¥ä»»åŠ¡å¤±è´¥:', error);
    }
  }



  private navigateToTaskDetail(task: ElderTaskInstanceInfo, planItem: ElderPlanItemInfo, plan: ElderPlanInfo): void {
    const param: TaskDetailNavParam = {
      task: task,
      plan_item: planItem,
      plan: plan
    };
    this.navPathStack.pushPathByName('Elder_TaskDetail', param);
  }



  @Builder
  private TodayTasksCard() {
    Column() {
      Row() {
        Text('ğŸ“‹ ä»Šæ—¥ä»»åŠ¡')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#166534')
        Blank()
        if (this.todayTasksData) {
          Text(this.todayTasksData.completed_tasks + '/' + this.todayTasksData.total_tasks + ' å·²å®Œæˆ')
            .fontSize(12)
            .fontColor('#64748b')
        }
      }
      .width('100%')
      .margin({ bottom: 14 })

      if (!this.todayTasksData || this.todayTasksData.plans.length === 0) {
        Column() {
          Text('ğŸ‰')
            .fontSize(32)
          Text('ä»Šæ—¥æš‚æ— ä»»åŠ¡')
            .fontSize(14)
            .fontColor('#9ca3af')
            .margin({ top: 8 })
        }
        .width('100%')
        .padding(20)
        .justifyContent(FlexAlign.Center)
      } else {
        ForEach(this.todayTasksData.plans, (planGroup: ElderTasksByPlan, planIndex: number) => {
          // è®¡åˆ’åˆ†ç»„æ ‡é¢˜
          Column() {
            if (planIndex > 0) {
              Divider()
                .strokeWidth(1)
                .color('#e5e7eb')
                .margin({ top: 12, bottom: 12 })
            }

            Row() {
              Text('ğŸ“Œ')
                .fontSize(14)
              Text(planGroup.plan.title)
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#374151')
                .margin({ left: 6 })
            }
            .width('100%')
            .margin({ bottom: 10 })

            // è®¡åˆ’é¡¹å’Œä»»åŠ¡åˆ—è¡¨
            ForEach(planGroup.items, (itemGroup: ElderTasksByPlanItem) => {
              ForEach(itemGroup.tasks, (task: ElderTaskInstanceInfo) => {
                Row() {
                  Column() {
                    Row() {
                      Text(itemGroup.plan_item.item_type === 'MEDICATION' ? 'ğŸ’Š' : 'ğŸƒ')
                        .fontSize(12)
                      Text(itemGroup.plan_item.name)
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#1e293b')
                        .margin({ left: 4 })
                    }
                    if (task.task_time) {
                      Text(task.task_time)
                        .fontSize(12)
                        .fontColor('#64748b')
                        .margin({ top: 4 })
                    }
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)

                  Text(task.status === 'COMPLETED' ? 'âœ“ å·²å®Œæˆ' : task.status === 'SKIPPED' ? 'å·²è·³è¿‡' : 'å¾…å®Œæˆ')
                    .fontSize(11)
                    .fontColor(task.status === 'COMPLETED' ? '#16a34a' : task.status === 'SKIPPED' ? '#9ca3af' : '#f59e0b')

                  Text('>')
                    .fontSize(14)
                    .fontColor('#9ca3af')
                    .margin({ left: 8 })
                }
                .width('100%')
                .padding(12)
                .backgroundColor('#f8fafc')
                .borderRadius(10)
                .margin({ bottom: 8 })
                .onClick(() => {
                  this.navigateToTaskDetail(task, itemGroup.plan_item, planGroup.plan);
                })
              }, (task: ElderTaskInstanceInfo) => task.id.toString())
            }, (itemGroup: ElderTasksByPlanItem) => itemGroup.plan_item.id.toString())
          }
          .width('100%')
        }, (planGroup: ElderTasksByPlan) => planGroup.plan.id.toString())
      }
    }
    .width('100%')
    .padding(18)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({ radius: 6, color: '#0f172a0a', offsetY: 2 })
  }

  @Builder
  private ProfileCompletionBanner() {
    Row() {
      Column() {
        Row() {
          Text('âš ï¸')
            .fontSize(18)
          Text(' ä¸ªäººä¿¡æ¯å¾…å®Œå–„')
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor('#92400e')
        }
        Text('ç¼ºå°‘ï¼š' + this.missingFields.join('ã€'))
          .fontSize(12)
          .fontColor('#b45309')
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      Text('å»å®Œå–„ â†’')
        .fontSize(13)
        .fontColor('#d97706')
        .fontWeight(FontWeight.Medium)
    }
    .width('100%')
    .padding(14)
    .backgroundColor('#fef3c7')
    .borderRadius(12)
    .margin({ bottom: 14 })
    .onClick(() => {
      promptAction.showToast({ message: 'è¯·å‰å¾€"æˆ‘çš„"é¡µé¢å®Œå–„ä¸ªäººä¿¡æ¯' });
    })
  }

  build() {
    Column() {
      // é—®å€™è¯­
      Row() {
        Column() {
          Text('æ‚¨å¥½' + (this.elderName ? 'ï¼Œ' + this.elderName : '') + ' ğŸ‘‹')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#166534')
          Text('ç¥æ‚¨èº«ä½“å¥åº·ï¼Œç”Ÿæ´»æ„‰å¿«')
            .fontSize(13)
            .fontColor('#64748b')
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 16 })

      if (this.isLoading) {
        Column() {
          LoadingProgress().width(40).height(40)
          Text('åŠ è½½ä¸­...').fontSize(14).fontColor('#64748b').margin({ top: 12 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Column() {
            // ä¸ªäººä¿¡æ¯å®Œå–„æç¤º
            if (this.profileIncomplete) {
              this.ProfileCompletionBanner()
            }

            this.TodayTasksCard()
          }
          .constraintSize({
            minHeight:'100%'
          })
          .padding({ left: 16, right: 16, bottom: 20 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
  }
}
