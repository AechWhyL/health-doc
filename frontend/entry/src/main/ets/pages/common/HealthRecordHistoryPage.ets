import { HealthRecordHistory } from '../../models/HealthArchiveModels';
import { httpRequest } from '../../common/api/HttpUtil';
import { RequestEnum } from '../../common/api/httpEnum';
import dayjs from 'dayjs';
import { HealthRecordHistoryDetailPageParams } from './HealthRecordHistoryDetailPage';

interface ApiResponse<T = Object> {
  code: number;
  message: string;
  data?: T;
  timestamp: number;
}

@Builder
export function HealthRecordHistoryPageBuilder() {
  HealthRecordHistoryPage()
}

@ComponentV2
export struct HealthRecordHistoryPage {
  @Local private recordId: number = 0;
  @Local private historyList: HealthRecordHistory[] = [];
  @Local private isLoading: boolean = true;
  @Local private loadError: string = '';
  private navPathStack: NavPathStack = new NavPathStack();

  private async loadHistory(): Promise<void> {
    this.isLoading = true;
    this.loadError = '';

    try {
      const response = await httpRequest<ApiResponse<HealthRecordHistory[]>, null>({
        url: '/api/v1/elder-health/health-record/' + this.recordId.toString() + '/history',
        method: RequestEnum.GET,
        token: 'auth'
      });

      if (response.code !== 200) {
        this.loadError = response.message || 'åŠ è½½åŽ†å²è®°å½•å¤±è´¥';
        this.isLoading = false;
        return;
      }

      this.historyList = response.data || [];
      this.isLoading = false;
    } catch (_error) {
      this.loadError = 'ç½‘ç»œå¼‚å¸¸ï¼ŒåŠ è½½åŽ†å²è®°å½•å¤±è´¥';
      this.isLoading = false;
    }
  }

  private formatDate(dateStr: string): string {
    return dayjs(dateStr).format('YYYY-MM-DD HH:mm:ss');
  }

  private getOperationTypeLabel(type: string): string {
    return type === 'ADD' ? 'æ–°å¢žæ¡£æ¡ˆ' : 'ä¿®æ”¹æ¡£æ¡ˆ';
  }

  private getOperationTypeColor(type: string): string {
    return type === 'ADD' ? '#0ea5e9' : '#f59e0b'; // Sky blue for add, Amber for modify
  }

  build() {
    NavDestination() {
      Column() {
        if (this.isLoading) {
          Column() {
            LoadingProgress()
              .width(48)
              .height(48)
              .color('#2563eb')
            Text('åŠ è½½ä¸­...')
              .fontSize(14)
              .fontColor('#64748b')
              .margin({ top: 12 })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
        } else if (this.loadError) {
          Column() {
            Text('ðŸ˜•')
              .fontSize(48)
            Text(this.loadError)
              .fontSize(14)
              .fontColor('#64748b')
              .margin({ top: 12 })
            Button('é‡è¯•')
              .type(ButtonType.Capsule)
              .backgroundColor('#2563eb')
              .fontColor(Color.White)
              .fontSize(14)
              .height(40)
              .margin({ top: 20 })
              .onClick(() => {
                this.loadHistory();
              })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
        } else if (this.historyList.length === 0) {
          Column() {
            Text('ðŸ“­')
              .fontSize(48)
            Text('æš‚æ— æ“ä½œè®°å½•')
              .fontSize(14)
              .fontColor('#64748b')
              .margin({ top: 12 })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
        } else {
          List() {
            ForEach(this.historyList, (item: HealthRecordHistory) => {
              ListItem() {
                Row() {
                  // Icon
                  Column() {
                    Text(item.operation_type === 'ADD' ? 'âž•' : 'âœï¸')
                      .fontSize(20)
                  }
                  .width(40)
                  .height(40)
                  .borderRadius(20)
                  .backgroundColor(item.operation_type === 'ADD' ? '#e0f2fe' : '#fef3c7')
                  .justifyContent(FlexAlign.Center)
                  .margin({ right: 12 })

                  // Content
                  Column() {
                    Text(this.getOperationTypeLabel(item.operation_type))
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#1e293b')
                    
                    Text(this.formatDate(item.created_at))
                      .fontSize(12)
                      .fontColor('#94a3b8')
                      .margin({ top: 4 })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)

                  // Operator
                  Column() {
                    Text(item.operator_name || 'æœªçŸ¥ç”¨æˆ·')
                      .fontSize(14)
                      .fontColor('#64748b')
                  }
                  .margin({ right: 8 })

                  // Arrow
                  Text('â€º')
                    .fontSize(24)
                    .fontColor('#cbd5e1')
                    .fontWeight(FontWeight.Bold)
                    .margin({ bottom: 4 }) // Adjust visual center
                }
                .width('100%')
                .padding(16)
                .backgroundColor(Color.White)
                .borderRadius(12)
                .margin({ bottom: 12 })
                .shadow({
                    radius: 2,
                    color: '#0f172a08',
                    offsetY: 1
                })
                .onClick(() => {
                  const params:HealthRecordHistoryDetailPageParams = { history: item }
                  this.navPathStack.pushPath({
                    name: 'Common_HealthRecordHistoryDetail',
                    param: params
                  });
                })
              }
            })
          }
          .width('100%')
          .height('100%')
          .padding(16)
          .scrollBar(BarState.Off)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f8fafc')
    }
    .title('æ“ä½œåŽ†å²')
    .onReady((ctx: NavDestinationContext) => {
      this.navPathStack = ctx.pathStack;
      this.recordId = ctx.pathInfo.param as number;
      this.loadHistory();
    })
  }
}
