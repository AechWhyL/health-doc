import { HealthRecordForm } from '../../components/medical/HealthRecordForm';
import {
  HealthRecordType,
  HealthRecordFormSubmitPayload,
  AddHealthRecordParams,
  CreateHealthRecordPayload,
  UpdateHealthRecordPayload
} from '../../models/HealthArchiveModels';
import { httpRequest } from '../../common/api/HttpUtil';
import { RequestEnum } from '../../common/api/httpEnum';

interface ApiResponse<T = Object> {
  code: number;
  message: string;
  data?: T;
  timestamp: number;
}

/**
 * æ·»åŠ /ç¼–è¾‘å¥åº·æ¡£æ¡ˆé¡µé¢
 * ç‹¬ç«‹çš„ NavDestination é¡µé¢,æ›¿ä»£åŸæœ‰çš„ Dialog
 */
@Builder
export function AddHealthRecordPageBuilder() {
  AddHealthRecordPage()
}

@ComponentV2
export struct AddHealthRecordPage {
  // ==================== å¯¼èˆªå‚æ•° ====================
  @Local private params: AddHealthRecordParams = {
    elderId: 0,
    elderName: '',
    mode: 'create'
  };

  // ==================== çŠ¶æ€ ====================
  @Local private isSubmitting: boolean = false;
  @Local private selectedRecordType: HealthRecordType = 'MEDICAL_HISTORY';

  // ==================== å¯¼èˆªæ ˆ ====================
  private navPathStack: NavPathStack = new NavPathStack();

  // ==================== å·¥å…·æ–¹æ³• ====================
  private getRecordTypeLabel(type: HealthRecordType): string {
    switch (type) {
      case 'MEDICAL_HISTORY': return 'ç—…å²è®°å½•';
      case 'CHECK_REPORT': return 'æ£€æŸ¥æŠ¥å‘Š';
      case 'MEDICATION': return 'ç”¨è¯è®°å½•';
      case 'ALLERGY': return 'è¿‡æ•è®°å½•';
    }
  }

  private getRecordTypeIcon(type: HealthRecordType): string {
    switch (type) {
      case 'MEDICAL_HISTORY': return 'ğŸ¥';
      case 'CHECK_REPORT': return 'ğŸ”¬';
      case 'MEDICATION': return 'ğŸ’Š';
      case 'ALLERGY': return 'âš ï¸';
    }
  }

  private getRecordTypeColor(type: HealthRecordType): string {
    switch (type) {
      case 'MEDICAL_HISTORY': return '#1d4ed8';
      case 'CHECK_REPORT': return '#15803d';
      case 'MEDICATION': return '#b91c1c';
      case 'ALLERGY': return '#c2410c';
    }
  }

  private getRecordTypeBgColor(type: HealthRecordType): string {
    switch (type) {
      case 'MEDICAL_HISTORY': return '#eff6ff';
      case 'CHECK_REPORT': return '#f0fdf4';
      case 'MEDICATION': return '#fef2f2';
      case 'ALLERGY': return '#fff7ed';
    }
  }

  // ==================== ä¸šåŠ¡é€»è¾‘ ====================
  private async handleSubmit(payload: HealthRecordFormSubmitPayload): Promise<void> {
    if (this.isSubmitting) {
      return;
    }

    this.isSubmitting = true;

    try {
      if (this.params.mode === 'create') {
        await this.handleCreate(payload);
      } else {
        await this.handleEdit(payload);
      }
    } finally {
      this.isSubmitting = false;
    }
  }

  private async handleCreate(payload: HealthRecordFormSubmitPayload): Promise<void> {
    const createPayload: CreateHealthRecordPayload = {
      elder_id: this.params.elderId,
      record_type: payload.recordType,
      record_title: payload.recordTitle,
      record_date: payload.recordDate,
      content_structured: payload.contentStructured
    };

    try {
      const response = await httpRequest<ApiResponse<Object>, CreateHealthRecordPayload>({
        url: '/api/v1/elder-health/health-record',
        method: RequestEnum.POST,
        token: 'auth',
        params: createPayload
      });

      if (response.code !== 200) {
        const msg = response.message || 'åˆ›å»ºå¥åº·è®°å½•å¤±è´¥';
        this.getUIContext().getPromptAction().showToast({ message: msg });
        return;
      }

      this.getUIContext().getPromptAction().showToast({ message: 'åˆ›å»ºå¥åº·è®°å½•æˆåŠŸ' });
      this.navPathStack.pop(true); // è¿”å›å¹¶è§¦å‘åˆ·æ–°
    } catch (_error) {
      this.getUIContext().getPromptAction().showToast({ message: 'ç½‘ç»œå¼‚å¸¸,åˆ›å»ºå¥åº·è®°å½•å¤±è´¥' });
    }
  }

  private async handleEdit(payload: HealthRecordFormSubmitPayload): Promise<void> {
    if (!this.params.editRecord) {
      return;
    }

    const updatePayload: UpdateHealthRecordPayload = {
      record_type: payload.recordType,
      record_title: payload.recordTitle,
      record_date: payload.recordDate,
      content_structured: payload.contentStructured
    };

    try {
      const response = await httpRequest<ApiResponse<Object>, UpdateHealthRecordPayload>({
        url: '/api/v1/elder-health/health-record/' + this.params.editRecord.id.toString(),
        method: RequestEnum.PUT,
        token: 'auth',
        params: updatePayload
      });

      if (response.code !== 200) {
        const msg = response.message || 'æ›´æ–°å¥åº·è®°å½•å¤±è´¥';
        this.getUIContext().getPromptAction().showToast({ message: msg });
        return;
      }

      this.getUIContext().getPromptAction().showToast({ message: 'æ›´æ–°å¥åº·è®°å½•æˆåŠŸ' });
      this.navPathStack.pop(true); // è¿”å›å¹¶è§¦å‘åˆ·æ–°
    } catch (_error) {
      this.getUIContext().getPromptAction().showToast({ message: 'ç½‘ç»œå¼‚å¸¸,æ›´æ–°å¥åº·è®°å½•å¤±è´¥' });
    }
  }

  private handleCancel(): void {
    this.navPathStack.pop();
  }

  // ==================== UI æ„å»º ====================
  @Builder
  private buildHeader() {
    Row() {
      Column() {
        Text(this.getRecordTypeIcon(this.selectedRecordType))
          .fontSize(24)
      }
      .width(48)
      .height(48)
      .borderRadius(24)
      .backgroundColor(this.getRecordTypeBgColor(this.selectedRecordType))
      .justifyContent(FlexAlign.Center)

      Column() {
        Text(this.params.mode === 'create' ? 'æ–°å¢' + this.getRecordTypeLabel(this.selectedRecordType) : 'ç¼–è¾‘' + this.getRecordTypeLabel(this.selectedRecordType))
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1e293b')

        if (this.params.elderName) {
          Text('ä¸º ' + this.params.elderName + ' è®°å½•')
            .fontSize(13)
            .fontColor('#64748b')
            .margin({ top: 4 })
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 14 })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16, bottom: 16 })
    .backgroundColor(Color.White)
  }

  @Builder
  private buildTypeSelector() {
    if (this.params.mode === 'create') {
      Column() {
        Text('é€‰æ‹©æ¡£æ¡ˆç±»å‹')
          .fontSize(13)
          .fontColor('#64748b')
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 12 })
          .alignSelf(ItemAlign.Start)

        Row({ space: 8 }) {
          this.TypeButton('MEDICAL_HISTORY', 'ğŸ¥', 'ç—…å²')
          this.TypeButton('CHECK_REPORT', 'ğŸ”¬', 'æ£€æŸ¥')
          this.TypeButton('MEDICATION', 'ğŸ’Š', 'ç”¨è¯')
          this.TypeButton('ALLERGY', 'âš ï¸', 'è¿‡æ•')
        }
        .width('100%')
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 16 })
      .backgroundColor(Color.White)
    }
  }

  @Builder
  private TypeButton(type: HealthRecordType, icon: string, label: string) {
    Column() {
      Text(icon)
        .fontSize(24)
        .margin({ bottom: 6 })
      Text(label)
        .fontSize(12)
        .fontColor(this.selectedRecordType === type ? this.getRecordTypeColor(type) : '#64748b')
        .fontWeight(this.selectedRecordType === type ? FontWeight.Medium : FontWeight.Regular)
    }
    .layoutWeight(1)
    .padding({ top: 12, bottom: 12 })
    .backgroundColor(this.selectedRecordType === type ? this.getRecordTypeBgColor(type) : '#f8fafc')
    .borderRadius(12)
    .border({
      width: 2,
      color: this.selectedRecordType === type ? this.getRecordTypeColor(type) : '#e2e8f0'
    })
    .onClick(() => {
      this.selectedRecordType = type;
    })
  }

  build() {
    NavDestination() {
      Column() {
        // é¡µé¢å¤´éƒ¨
        this.buildHeader()

        // ç±»å‹é€‰æ‹©å™¨ (ä»…åˆ›å»ºæ¨¡å¼)
        this.buildTypeSelector()

        Divider()
          .strokeWidth(1)
          .color('#e2e8f0')

        // è¡¨å•å†…å®¹
        Scroll() {
          HealthRecordForm({
            elderName: this.params.elderName,
            recordType: this.selectedRecordType,
            mode: this.params.mode,
            initialTitle: this.params.editRecord?.record_title || '',
            initialDate: this.params.editRecord?.record_date || '',
            initialContent: this.params.editRecord?.content_structured || null,
            onSubmit: (payload) => {
              this.handleSubmit(payload);
            },
            onCancel: () => {
              this.handleCancel();
            },
          })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .padding({ left: 20, right: 20, top: 16, bottom: 16 })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f8fafc')
    }
    .title(this.params.mode === 'create' ? 'æ·»åŠ å¥åº·æ¡£æ¡ˆ' : 'ç¼–è¾‘å¥åº·æ¡£æ¡ˆ')
    .onReady((ctx: NavDestinationContext) => {
      this.navPathStack = ctx.pathStack;
      this.params = ctx.pathInfo.param as AddHealthRecordParams;
      // åˆå§‹åŒ–é€‰ä¸­çš„ç±»å‹
      this.selectedRecordType = this.params.recordType || 'MEDICAL_HISTORY';
    })
    .width('100%')
    .height('100%')
  }
}
