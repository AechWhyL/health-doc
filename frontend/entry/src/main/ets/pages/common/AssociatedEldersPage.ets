import { promptAction } from '@kit.ArkUI';
import { httpRequest } from '../../common/api/HttpUtil';
import { RequestEnum } from '../../common/api/httpEnum';

interface ApiResponse<T = Object> {
  code: number;
  message: string;
  data?: T;
}

interface ElderResponse {
  id: number;
  user_id: number;
  name: string;
  gender: number;
  birth_date: string;
  phone: string;
  age: number;
}

interface UserElderRelationItem {
  relation_id: number;
  elder_id: number;
  relation_name: string | null;
  elder: ElderResponse;
}

interface MyEldersListData {
  items: UserElderRelationItem[];
  total: number;
}

interface ElderListData {
  items: ElderResponse[];
  total: number;
}

interface SearchElderParams {
  page: number;
  pageSize: number;
  name?: string;
  phone?: string;
}

interface AddElderRelationRequest {
  elder_id: number;
  relation_name?: string;
}

interface QueryMyEldersParams {
  page: number;
  pageSize: number;
}

@Builder
export function AssociatedEldersPageBuilder() {
  AssociatedEldersPage()
}

@Component
export struct AssociatedEldersPage {
  @Consume('navPathStack') navPathStack: NavPathStack;
  @State searchKeyword: string = '';
  @State myElders: UserElderRelationItem[] = [];
  @State searchResults: ElderResponse[] = [];
  @State isLoading: boolean = false;
  @State isSearching: boolean = false;

  aboutToAppear() {
    this.loadMyElders();
  }

  async loadMyElders() {
    this.isLoading = true;
    try {
      const params: QueryMyEldersParams = { page: 1, pageSize: 100 };
      const response = await httpRequest<ApiResponse<MyEldersListData>, QueryMyEldersParams>({
        url: '/api/v1/users/me/elders',
        method: RequestEnum.GET,
        params: params
      });
      if (response.code === 200 && response.data) {
        this.myElders = response.data.items || [];
      }
    } catch (error) {
      promptAction.showToast({ message: 'åŠ è½½å…³è”è€äººå¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  async searchElders() {
    if (!this.searchKeyword.trim()) {
      this.searchResults = [];
      return;
    }
    this.isSearching = true;
    try {
      const params: SearchElderParams = { page: 1, pageSize: 20 };
      if (/^\d{11}$/.test(this.searchKeyword.trim())) {
        params.phone = this.searchKeyword.trim();
      } else {
        params.name = this.searchKeyword.trim();
      }

      const response = await httpRequest<ApiResponse<ElderListData>, SearchElderParams>({
        url: '/api/v1/elder-health/elder/list',
        method: RequestEnum.GET,
        params: params
      });

      if (response.code === 200 && response.data) {
        this.searchResults = response.data.items || [];
        if (this.searchResults.length === 0) {
          promptAction.showToast({ message: 'æœªæ‰¾åˆ°åŒ¹é…çš„è€äºº' });
        }
      }
    } catch (error) {
      promptAction.showToast({ message: 'æœç´¢å¤±è´¥' });
    } finally {
      this.isSearching = false;
    }
  }

  isAssociated(elderId: number): boolean {
    return this.myElders.some(item => item.elder.user_id === elderId);
  }

  getRelationId(elderId: number): number | null {
    const relation = this.myElders.find(item => item.elder.user_id === elderId);
    return relation ? relation.relation_id : null;
  }

  async addAssociation(elder: ElderResponse) {
    try {
      const response = await httpRequest<ApiResponse, AddElderRelationRequest>({
        url: '/api/v1/users/me/elders',
        method: RequestEnum.POST,
        params: { elder_id: elder.user_id }
      });
      if (response.code === 200 || response.code === 201) {
        promptAction.showToast({ message: 'å…³è”æˆåŠŸ' });
        await this.loadMyElders();
      } else {
        promptAction.showToast({ message: response.message || 'å…³è”å¤±è´¥' });
      }
    } catch (error) {
      promptAction.showToast({ message: 'ç½‘ç»œå¼‚å¸¸' });
    }
  }

  async removeAssociation(relationId: number) {
    try {
      const response = await httpRequest<ApiResponse, void>({
        url: `/api/v1/users/me/elders/${relationId}`,
        method: RequestEnum.DELETE
      });
      if (response.code === 200) {
        promptAction.showToast({ message: 'å·²å–æ¶ˆå…³è”' });
        await this.loadMyElders();
      } else {
        promptAction.showToast({ message: response.message || 'å–æ¶ˆå…³è”å¤±è´¥' });
      }
    } catch (error) {
      promptAction.showToast({ message: 'ç½‘ç»œå¼‚å¸¸' });
    }
  }

  confirmRemove(relationId: number, name: string) {
    AlertDialog.show({
      title: 'å–æ¶ˆå…³è”',
      message: `ç¡®å®šè¦å–æ¶ˆä¸ ${name} çš„å…³è”å—ï¼Ÿ`,
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      },
      secondaryButton: {
        value: 'ç¡®å®š',
        fontColor: '#ef4444',
        action: () => {
          this.removeAssociation(relationId);
        }
      }
    });
  }

  @Builder
  ElderItem(elder: ElderResponse, isSearchResult: boolean) {
    Row() {
      // Avatar / Icon
      Text(elder.gender === 1 ? 'ğŸ‘´' : 'ğŸ‘µ')
        .fontSize(40)
        .margin({ right: 12 })

      // Info
      Column() {
        Row() {
          Text(elder.name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1e293b')
          Text(`${elder.age}å²`)
            .fontSize(12)
            .fontColor('#64748b')
            .margin({ left: 8 })
            .backgroundColor('#f1f5f9')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(4)
        }
        
        Text(elder.phone)
          .fontSize(14)
          .fontColor('#64748b')
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // Action Button
      if (this.isAssociated(elder.user_id)) {
        Button('å·²å…³è”')
          .type(ButtonType.Capsule)
          .backgroundColor('#dcfce7')
          .fontColor('#16a34a')
          .fontSize(12)
          .height(28)
          .onClick(() => {
            const relationId = this.getRelationId(elder.user_id);
            if (relationId) {
              this.confirmRemove(relationId, elder.name);
            }
          })
      } else {
        Button('å…³è”')
          .type(ButtonType.Capsule)
          .backgroundColor('#2563eb')
          .fontSize(12)
          .height(28)
          .onClick(() => {
            this.addAssociation(elder);
          })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
  }

  build() {
    NavDestination() {
      Column() {

        // Search Bar
        Row() {
          TextInput({ text: this.searchKeyword, placeholder: 'æœç´¢å§“åæˆ–æ‰‹æœºå·' })
            .height(40)
            .fontSize(14)
            .backgroundColor('#f1f5f9')
            .borderRadius(20)
            .layoutWeight(1)
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.searchKeyword = value;
              if (value.trim() === '') {
                this.searchResults = [];
              }
            })
            .onSubmit(() => {
              this.searchElders();
            })

          Button('æœç´¢')
            .type(ButtonType.Capsule)
            .backgroundColor('#2563eb')
            .height(36)
            .fontSize(13)
            .margin({ left: 12 })
            .onClick(() => {
              this.searchElders();
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 16 })
        .backgroundColor(Color.White)

        // Content
        Scroll() {
          Column() {
            if (this.searchKeyword.trim()) {
              // Search Results Mode
              Text('æœç´¢ç»“æœ')
                .fontSize(14)
                .fontColor('#64748b')
                .width('100%')
                .margin({ bottom: 12, top: 18 })
              
              if (this.isSearching) {
                LoadingProgress().width(32).height(32).margin({ top: 20 })
              } else if (this.searchResults.length === 0) {
                Column() {
                  Text('ğŸ”').fontSize(40)
                  Text('æœªæ‰¾åˆ°åŒ¹é…çš„è€äºº').fontSize(14).fontColor('#9ca3af').margin({ top: 8 })
                }.margin({ top: 40 })
              } else {
                ForEach(this.searchResults, (elder: ElderResponse) => {
                  this.ElderItem(elder, true)
                }, (elder: ElderResponse) => elder.id.toString())
              }
            } else {
              // My Elders List Mode
              if (this.myElders.length > 0) {
                Text('å·²å…³è”çš„è€äºº')
                .fontSize(14)
                .fontColor('#64748b')
                .width('100%')
                .margin({ bottom: 12, top: 12 })

                ForEach(this.myElders, (item: UserElderRelationItem) => {
                  this.ElderItem(item.elder, false)
                }, (item: UserElderRelationItem) => item.relation_id.toString())
              } else if (!this.isLoading) {
                Column() {
                  Text('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦').fontSize(48)
                  Text('æš‚æ— å…³è”è€äºº').fontSize(16).fontWeight(FontWeight.Medium).fontColor('#374151').margin({ top: 16 })
                  Text('è¯·åœ¨ä¸Šæœç´¢æ è¾“å…¥å§“åæˆ–æ‰‹æœºå·æ·»åŠ ').fontSize(13).fontColor('#9ca3af').margin({ top: 8 })
                }.width('100%').height(300).justifyContent(FlexAlign.Center)
              }
            }
          }
          .padding({ left: 16, right: 16, bottom: 20 })
          .constraintSize({
            minHeight:"100%"
          })
        }
        .layoutWeight(1)
        .width('100%')
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f8fafc')
    }
    .title('å…³è”è€äºº')

  }
}
