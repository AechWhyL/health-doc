import { promptAction } from '@kit.ArkUI';
import dayjs from 'dayjs';
import { httpRequest } from '../../common/api/HttpUtil';
import { RequestEnum } from '../../common/api/httpEnum';
import { CardContainer } from '../../components/common/CardContainer';

interface ApiResponse<T = Object> {
  code: number;
  message: string;
  data?: T;
  timestamp: number;
}

interface ElderResponse {
  id: number;
  name: string;
  gender: number;
  birth_date: string;
  phone: string;
  address: string | null;
  emergency_contact: string;
  height: number | null;
  weight: number | null;
  blood_type: string | null;
  age: number;
}

interface UpdateElderPayload {
  name?: string;
  gender?: number;
  birth_date?: string;
  address?: string;
  height?: number | null;
  weight?: number | null;
  blood_type?: string;
  emergency_contact?: string;
}

export interface ElderInfoEditRouteParams {
  elderId: number;
}

// Editable field types
type EditableField = 'name' | 'address' | 'height' | 'weight' | 'emergencyContact' | null;

@Builder
export function ElderInfoEditPageBuilder() {
  ElderInfoEditPage()
}

@Component
export struct ElderInfoEditPage {
  @State elder: ElderResponse | null = null;
  @State isLoading: boolean = true;
  @State isSaving: boolean = false;

  // Route params
  private elderId: number = 0;

  // Editable fields - stored values
  @State elderName: string = '';
  @State elderGender: number = 1;
  @State elderBirthDate: string = '';
  @State elderAddress: string = '';
  @State elderHeight: string = '';
  @State elderWeight: string = '';
  @State elderBloodType: string = '';
  @State elderEmergencyContact: string = '';

  // Editing state
  @State editingField: EditableField = null;
  @State editingValue: string = '';

  @Consume('navPathStack') navPathStack: NavPathStack;

  private async loadElderInfo(): Promise<void> {
    if (!this.elderId) {
      promptAction.showToast({ message: 'Áº∫Â∞ëËÄÅ‰∫∫IDÂèÇÊï∞' });
      return;
    }

    this.isLoading = true;

    try {
      const response = await httpRequest<ApiResponse<ElderResponse>, void>({
        url: `/api/v1/elder-health/elder/${this.elderId}`,
        method: RequestEnum.GET
      });

      if (response.code === 200 && response.data) {
        this.elder = response.data;
        this.initForm(this.elder);
      } else {
        promptAction.showToast({ message: response.message || 'Âä†ËΩΩÂ§±Ë¥•' });
      }
    } catch (error) {
      console.error('Âä†ËΩΩËÄÅ‰∫∫‰ø°ÊÅØÂ§±Ë¥•:', error);
      promptAction.showToast({ message: 'ÁΩëÁªúÂºÇÂ∏∏' });
    } finally {
      this.isLoading = false;
    }
  }

  initForm(elder: ElderResponse): void {
    this.elderName = elder.name || '';
    this.elderGender = elder.gender;
    this.elderBirthDate = elder.birth_date || '';
    this.elderAddress = elder.address || '';
    this.elderHeight = elder.height ? String(elder.height) : '';
    this.elderWeight = elder.weight ? String(elder.weight) : '';
    this.elderBloodType = elder.blood_type || '';
    this.elderEmergencyContact = elder.emergency_contact || '';
  }

  getFieldValue(field: EditableField): string {
    if (field === 'name') return this.elderName;
    if (field === 'address') return this.elderAddress;
    if (field === 'height') return this.elderHeight;
    if (field === 'weight') return this.elderWeight;
    if (field === 'emergencyContact') return this.elderEmergencyContact;
    return '';
  }

  startEditing(field: EditableField): void {
    if (field === null) return;
    this.editingField = field;
    this.editingValue = this.getFieldValue(field);
  }

  cancelEditing(): void {
    this.editingField = null;
    this.editingValue = '';
  }

  async saveField(field: EditableField): Promise<void> {
    if (field === null || !this.elder) return;
    const payload: UpdateElderPayload = {};

    if (field === 'name') payload.name = this.editingValue;
    else if (field === 'address') payload.address = this.editingValue;
    else if (field === 'height') payload.height = this.editingValue ? parseFloat(this.editingValue) : null;
    else if (field === 'weight') payload.weight = this.editingValue ? parseFloat(this.editingValue) : null;
    else if (field === 'emergencyContact') payload.emergency_contact = this.editingValue;

    await this.submitUpdate(payload, () => {
      if (field === 'name') this.elderName = this.editingValue;
      else if (field === 'address') this.elderAddress = this.editingValue;
      else if (field === 'height') this.elderHeight = this.editingValue;
      else if (field === 'weight') this.elderWeight = this.editingValue;
      else if (field === 'emergencyContact') this.elderEmergencyContact = this.editingValue;
      this.cancelEditing();
    });
  }

  async saveGender(newGender: number): Promise<void> {
    if (!this.elder) return;
    const payload: UpdateElderPayload = { gender: newGender };
    await this.submitUpdate(payload, () => {
      this.elderGender = newGender;
    });
  }

  async saveBirthDate(dateStr: string): Promise<void> {
    if (!this.elder) return;
    const payload: UpdateElderPayload = { birth_date: dateStr };
    await this.submitUpdate(payload, () => {
      this.elderBirthDate = dateStr;
    });
  }

  async saveBloodType(bloodType: string): Promise<void> {
    if (!this.elder) return;
    const payload: UpdateElderPayload = { blood_type: bloodType };
    await this.submitUpdate(payload, () => {
      this.elderBloodType = bloodType;
    });
  }

  async submitUpdate(payload: UpdateElderPayload, onSuccess: () => void): Promise<void> {
    if (this.isSaving || !this.elder) return;
    this.isSaving = true;
    try {
      const response = await httpRequest<ApiResponse, UpdateElderPayload>({
        url: `/api/v1/elder-health/elder/${this.elder.id}`,
        method: RequestEnum.PUT,
        params: payload
      });

      if (response.code === 200) {
        promptAction.showToast({ message: '‰øùÂ≠òÊàêÂäü' });
        onSuccess();
        await this.loadElderInfo();
      } else {
        promptAction.showToast({ message: response.message || '‰øùÂ≠òÂ§±Ë¥•' });
      }
    } catch (error) {
      promptAction.showToast({ message: 'ÁΩëÁªúÂºÇÂ∏∏' });
    } finally {
      this.isSaving = false;
    }
  }

  getGenderLabel(): string {
    return this.elderGender === 1 ? 'Áî∑' : 'Â•≥';
  }

  formatBirthDateForDisplay(): string {
    if (!this.elderBirthDate) return 'ËØ∑ÈÄâÊã©';
    return dayjs(this.elderBirthDate).format('YYYYÂπ¥MÊúàDÊó•');
  }

  formatDateToYYYYMMDD(date: Date): string {
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  @Builder
  ProfileCard() {
    Column() {
      // Â§¥ÂÉèÂíåÂü∫Êú¨‰ø°ÊÅØ
      Row() {
        Column() {
          Text(this.elderGender === 1 ? 'üë¥' : 'üëµ')
            .fontSize(48)
        }
        .width(80)
        .height(80)
        .borderRadius(40)
        .backgroundColor('#dcfce7')
        .justifyContent(FlexAlign.Center)

        Column() {
          Text(this.elderName || 'ËÄÅ‰∫∫')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#166534')

          if (this.elder) {
            Text(this.getGenderLabel() + ' ¬∑ ' + this.elder.age + 'Â≤Å')
              .fontSize(14)
              .fontColor('#64748b')
              .margin({ top: 4 })
          }

          if (this.elder?.phone) {
            Text('üì± ' + this.elder.phone)
              .fontSize(13)
              .fontColor('#94a3b8')
              .margin({ top: 6 })
          }
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 16 })
      }
      .width('100%')
    }
    .width('100%')
    .padding(24)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({ radius: 6, color: '#0f172a0a', offsetY: 2 })
    .margin({ bottom: 16 })
  }

  @Builder
  EditableTextRow(label: string, field: EditableField, placeholder: string = '', keyboardType?: InputType) {
    Column() {
      Text(label)
        .fontSize(13)
        .fontColor('#64748b')
        .width('100%')
        .margin({ bottom: 6 })

      if (this.editingField === field) {
        Row() {
          TextInput({ text: this.editingValue, placeholder: placeholder })
            .fontSize(15)
            .fontColor('#1e293b')
            .backgroundColor('#f1f5f9')
            .borderRadius(8)
            .padding({ left: 12, right: 12, top: 10, bottom: 10 })
            .layoutWeight(1)
            .border({ width: 2, color: '#16a34a', radius: 8 })
            .type(keyboardType || InputType.Normal)
            .onChange((val: string) => {
              this.editingValue = val;
            })

          Text('ÂèñÊ∂à')
            .fontSize(13)
            .fontColor('#64748b')
            .padding({ left: 12, right: 8 })
            .onClick(() => {
              this.cancelEditing();
            })

          Text('‰øùÂ≠ò')
            .fontSize(13)
            .fontColor('#16a34a')
            .fontWeight(FontWeight.Medium)
            .padding({ left: 8, right: 4 })
            .onClick(() => {
              this.saveField(field);
            })
        }
        .width('100%')
      } else {
        Row() {
          Text(this.getFieldValue(field) || placeholder)
            .fontSize(15)
            .fontColor(this.getFieldValue(field) ? '#1e293b' : '#9ca3af')
            .layoutWeight(1)

          Text('‰øÆÊîπ')
            .fontSize(13)
            .fontColor('#16a34a')
            .onClick(() => {
              this.startEditing(field);
            })
        }
        .width('100%')
        .padding({ left: 12, right: 12, top: 10, bottom: 10 })
        .backgroundColor('#f0fdf4')
        .borderRadius(8)
      }
    }
    .width('100%')
    .margin({ bottom: 16 })
  }

  @Builder
  GenderPickerRow() {
    Column() {
      Text('ÊÄßÂà´')
        .fontSize(13)
        .fontColor('#64748b')
        .width('100%')
        .margin({ bottom: 6 })

      Select([
        { value: 'Â•≥' } as SelectOption,
        { value: 'Áî∑' } as SelectOption
      ])
        .selected(this.elderGender)
        .value(this.getGenderLabel())
        .font({ size: 15, weight: 400 })
        .fontColor('#1e293b')
        .selectedOptionFont({ size: 15, weight: 500 })
        .optionFont({ size: 15, weight: 400 })
        .onSelect((index: number) => {
          if (index !== this.elderGender) {
            this.saveGender(index);
          }
        })
        .width('100%')
        .height(48)
        .backgroundColor('#f0fdf4')
        .borderRadius(8)
    }
    .width('100%')
    .margin({ bottom: 16 })
  }

  @Builder
  BirthDatePickerRow() {
    Column() {
      Text('Âá∫ÁîüÊó•Êúü')
        .fontSize(13)
        .fontColor('#64748b')
        .width('100%')
        .margin({ bottom: 6 })

      Row() {
        Text(this.formatBirthDateForDisplay())
          .fontSize(15)
          .fontColor(this.elderBirthDate ? '#1e293b' : '#9ca3af')
          .layoutWeight(1)

        Text('ÈÄâÊã©')
          .fontSize(13)
          .fontColor('#16a34a')
          .onClick(() => {
            DatePickerDialog.show({
              start: new Date('1920-1-1'),
              end: new Date(),
              selected: this.elderBirthDate ? new Date(this.elderBirthDate) : new Date('1950-1-1'),
              onDateAccept: (value: Date) => {
                const dateStr = this.formatDateToYYYYMMDD(value);
                this.saveBirthDate(dateStr);
              }
            });
          })
      }
      .width('100%')
      .padding({ left: 12, right: 12, top: 10, bottom: 10 })
      .backgroundColor('#f0fdf4')
      .borderRadius(8)
    }
    .width('100%')
    .margin({ bottom: 16 })
  }

  @Builder
  BloodTypePickerRow() {
    Column() {
      Text('Ë°ÄÂûã')
        .fontSize(13)
        .fontColor('#64748b')
        .width('100%')
        .margin({ bottom: 6 })

      Select([
        { value: 'Êú™ÈÄâÊã©' } as SelectOption,
        { value: 'A' } as SelectOption,
        { value: 'B' } as SelectOption,
        { value: 'AB' } as SelectOption,
        { value: 'O' } as SelectOption
      ])
        .selected(this.elderBloodType ? ['', 'A', 'B', 'AB', 'O'].indexOf(this.elderBloodType) : 0)
        .value(this.elderBloodType || 'Êú™ÈÄâÊã©')
        .font({ size: 15, weight: 400 })
        .fontColor('#1e293b')
        .selectedOptionFont({ size: 15, weight: 500 })
        .optionFont({ size: 15, weight: 400 })
        .onSelect((index: number) => {
          const bloodTypes = ['', 'A', 'B', 'AB', 'O'];
          const newBloodType = bloodTypes[index];
          if (newBloodType !== this.elderBloodType) {
            this.saveBloodType(newBloodType);
          }
        })
        .width('100%')
        .height(48)
        .backgroundColor('#f0fdf4')
        .borderRadius(8)
    }
    .width('100%')
    .margin({ bottom: 16 })
  }

  build() {
    NavDestination() {
      Column() {
        if (this.isLoading) {
          Column() {
            LoadingProgress().width(40).height(40).color('#16a34a')
            Text('Âä†ËΩΩ‰∏≠...').fontSize(14).fontColor('#64748b').margin({ top: 12 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        } else {
          Scroll() {
            Column() {
              this.ProfileCard()

              CardContainer({ title: 'Âü∫Êú¨‰ø°ÊÅØ' }) {
                Column() {
                  this.EditableTextRow('ÂßìÂêç', 'name', 'ËØ∑ËæìÂÖ•ÂßìÂêç')
                  this.GenderPickerRow()
                  this.BirthDatePickerRow()
                }
              }

              CardContainer({ title: 'ËÅîÁ≥ª‰ø°ÊÅØ' }) {
                Column() {
                  this.EditableTextRow('ÂÆ∂Â∫≠‰ΩèÂùÄ', 'address', 'ËØ∑ËæìÂÖ•ÂÆ∂Â∫≠‰ΩèÂùÄ')
                  this.EditableTextRow('Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫', 'emergencyContact', 'ËØ∑ËæìÂÖ•Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫')
                }
              }

              CardContainer({ title: 'ÂÅ•Â∫∑Ê°£Ê°à' }) {
                Column() {
                  this.EditableTextRow('Ë∫´È´ò(cm)', 'height', 'ËØ∑ËæìÂÖ•Ë∫´È´ò', InputType.NUMBER_DECIMAL)
                  this.EditableTextRow('‰ΩìÈáç(kg)', 'weight', 'ËØ∑ËæìÂÖ•‰ΩìÈáç', InputType.NUMBER_DECIMAL)
                  this.BloodTypePickerRow()
                }
              }
            }
            .padding({ left: 16, right: 16, bottom: 30 })
          }
          .layoutWeight(1)
          .scrollBar(BarState.Off)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f8fafc')
    }
    .title('ËÄÅ‰∫∫‰ø°ÊÅØ')
    .onReady((ctx: NavDestinationContext) => {
      const params = ctx.pathInfo.param as ElderInfoEditRouteParams
      if (params && params.elderId) {
        this.elderId = params.elderId
        this.loadElderInfo()
      } else {
        promptAction.showToast({ message: 'Áº∫Â∞ëËÄÅ‰∫∫IDÂèÇÊï∞' })
      }
    })
  }
}
