---
alwaysApply: false
---

# 档案版本追踪与审计模块需求文档

## 功能概述

### 功能描述
档案版本追踪与审计模块负责记录老人档案（基础信息与健康档案）的关键修改历史，包括修改时间、修改内容、操作人等信息，实现档案历史版本的回溯、差异对比和审计能力，满足可追溯性和合规性要求。

### 功能范围
- 关键字段变更记录（如联系方式、诊断结论、用药方案等）
- 档案版本生成与历史版本列表展示
- 版本差异比对（前后版本字段差异）
- 操作审计日志记录（操作人、操作来源、操作时间）

### 依赖关系
- 前置模块:
  - 老人基本信息管理模块
  - 健康档案管理模块
- 外部服务:
  - 暂无强制外部依赖
- 数据依赖:
  - 老人基础信息及健康档案相关数据表
  - 用户信息（用于标记操作人）

## 功能需求

### 核心功能列表

| 功能编号 | 功能名称                 |
|---------|--------------------------|
| F201    | 关键字段变更追踪         |
| F202    | 档案历史版本管理         |
| F203    | 版本差异比对             |
| F204    | 操作审计日志记录与查询   |

### 功能详细规格

#### F201: 关键字段变更追踪
**功能描述**:  
当老人基础档案或健康档案中的关键字段被修改时，系统需要记录修改前后的值、修改时间和修改人。

**关键逻辑思路**:
- 在服务层统一封装修改入口，所有对老人档案的更新操作均通过服务层完成。
- 在更新操作前读取旧值，更新后记录新值，将差异写入变更记录表。
- 支持针对重要字段进行精细追踪，如联系方式、病史、诊断结论、用药方案等。

**涉及的业务规则**:
- 对于批量更新操作，应拆分记录到多条明细中，以便精确追踪。
- 对于自动流程/系统任务产生的变更（如定时任务修正数据），操作人字段可标记为系统账号。

#### F202: 档案历史版本管理
**功能描述**:  
为老人档案生成逻辑版本号，方便按版本查看历史快照。

**关键逻辑思路**:
- 可采用“快照+增量变更”的方式实现版本管理：
  - 对于关键节点（如创建时、重要修改后）生成整份档案快照。
  - 平时的小变更通过变更明细表记录。
- 给每个版本分配递增版本号或使用时间戳作为版本标识。
- 在前端可按版本查看当时的档案完整内容。

**涉及的业务规则**:
- 为避免存储膨胀，可设置快照保留策略，例如仅对重要节点生成完整快照，日常变更以增量记录为主。
- 历史版本只读，不允许直接修改，可通过“回滚”操作生成新的当前版本。

#### F203: 版本差异比对
**功能描述**:  
支持对任意两版档案进行字段级差异比对，以便医护和管理员快速了解变更内容。

**关键逻辑思路**:
- 在后端对指定两个版本进行结构化比对，生成变更列表（字段名、旧值、新值）。
- 前端以高亮方式展示差异，例如新增字段、修改字段、删除字段。

**涉及的业务规则**:
- 差异比对仅在有权限查看两个版本完整内容的前提下进行。
- 对于涉及隐私的字段，可在差异结果中脱敏显示。

#### F204: 操作审计日志记录与查询
**功能描述**:  
记录对老人档案进行新增、修改、删除等操作的审计日志，便于后续责任追溯与安全审计。

**关键逻辑思路**:
- 审计日志记录：操作人ID、操作角色、操作时间、操作类型、目标对象（老人ID、档案类型）、操作概要等。
- 支持按时间区间、操作人、操作类型等条件查询日志。

**涉及的业务规则**:
- 日志记录应尽量不可篡改（可以考虑只追加不更新设计）。
- 普通业务用户不开放审计日志查询入口，仅管理员和安全管理员可查询。

## 前端交互设计

### 交互流程（概要）
- 医护/管理员：
  - 打开老人档案详情 → 切换到“历史版本”页签 → 查看版本列表 → 点击某一版本查看详情或进行版本差异比对。
- 管理员：
  - 进入“审计日志”页 → 条件搜索（时间、操作人、老人ID等）→ 查看操作详情。

## 数据模型

### 数据库设计
为实现版本追踪与审计功能，建议设计独立的版本表和审计日志表，可以与业务表解耦，减少对业务读写性能的影响。

#### 表结构设计（示例）

##### elder_record_versions
| 字段名       | 数据类型 | 说明                                   |
|--------------|----------|----------------------------------------|
| id           | BIGINT   | 主键                                   |
| elder_id     | BIGINT   | 老人ID                                 |
| version_no   | INT      | 版本号                                 |
| snapshot     | JSON     | 当时档案快照（或关键字段快照）         |
| created_at   | DATETIME | 版本生成时间                           |
| created_by   | BIGINT   | 触发版本生成的操作人（或系统）         |

##### elder_record_change_logs
| 字段名       | 数据类型 | 说明                                   |
|--------------|----------|----------------------------------------|
| id           | BIGINT   | 主键                                   |
| elder_id     | BIGINT   | 老人ID                                 |
| field_name   | VARCHAR  | 变更字段名称                           |
| old_value    | TEXT     | 旧值（适当长度限制）                   |
| new_value    | TEXT     | 新值                                   |
| changed_at   | DATETIME | 变更时间                               |
| changed_by   | BIGINT   | 操作人ID                               |

##### audit_logs
| 字段名       | 数据类型 | 说明                                   |
|--------------|----------|----------------------------------------|
| id           | BIGINT   | 主键                                   |
| user_id      | BIGINT   | 操作人用户ID                           |
| role_code    | VARCHAR  | 操作人角色                             |
| action       | VARCHAR  | 操作类型（CREATE/UPDATE/DELETE等）     |
| target_type  | VARCHAR  | 目标对象类型（ELDER_PROFILE/HEALTH_RECORD等） |
| target_id    | BIGINT   | 目标对象ID                             |
| description  | TEXT     | 操作概要描述                           |
| created_at   | DATETIME | 操作时间                               |

## 接口设计

### API 概览

| 接口路径                                          | 方法 | 处理问题                                       | 权限要求  |
|---------------------------------------------------|------|------------------------------------------------|-----------|
| GET /api/v1/elder-history/versions/{elderId}      | GET  | 查询老人档案历史版本列表（规划中）             | 管理/医护 |
| GET /api/v1/elder-history/version/{versionId}     | GET  | 查看指定版本快照（规划中）                     | 管理/医护 |
| GET /api/v1/elder-history/diff/{v1}/{v2}          | GET  | 对比两个版本差异（规划中）                     | 管理/医护 |
| GET /api/v1/audit-logs                            | GET  | 查询操作审计日志（规划中）                     | 管理      |
| GET /api/v1/health-data/records/{id}/history      | GET  | 查询单条健康数据记录的变更历史（当前已实现）   | 管理/医护/本人/家属 |

## 架构设计
版本追踪与审计模块应以横切关注点的方式集成到现有业务模块中：  
通过服务层或中间件方式对关键更新操作进行统一拦截和记录，避免在每个业务点重复实现记录逻辑。

## 关键技术点
1. 版本快照存储方案（JSON 存储 vs 结构化多表存储）。
2. 高效的差异比对算法（尤其在字段较多时的性能优化）。
3. 审计日志安全性（防篡改、访问控制）。

## 性能优化策略
- 控制版本和日志的保留期限，可定期归档历史数据。
- 对常用查询条件（elder_id、created_at 等）建立索引。

---
