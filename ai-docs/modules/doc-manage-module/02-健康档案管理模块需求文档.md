---
alwaysApply: false
---

# 健康档案管理模块需求文档

## 功能概述

### 功能描述
健康档案管理模块用于以「时间轴 + 分类」的方式，统一管理老人的病史、检查报告、用药记录以及过敏史等长期健康信息。  
后端通过统一的 `health_record` 表和 `record_type + content_structured` 结构化 JSON 字段，实现多种健康记录类型的扩展；  
前端通过「老人详情页中的健康档案区」和「医护端健康记录管理页」，支持按类型筛选、按日期浏览、查看详情、创建和编辑记录。

### 功能范围
- 统一健康档案模型设计（支持病史、检查报告、用药记录、过敏史等类型）
- 健康档案的创建、查看、更新、删除
- 按老人维度查看全部健康档案时间轴
- 按条件（老人、类型、时间范围）分页查询健康档案
- 为每条健康档案附加备注与附件（图片/文件）

### 依赖关系
- **前置模块**:
  - 老人基本信息管理模块：提供老人 `elder_id` 及基础信息
  - 系统与安全管理模块：提供登录与角色鉴权能力
- **外部服务**:
  - 暂无强制外部依赖，附件存储后续可对接对象存储服务
- **数据依赖**:
  - 数据表 `health_record`：统一存储各类健康档案记录
  - 老人基础信息表 `elder_basic_info`：用于关联老人

## 功能需求

### 核心功能列表

| 功能编号 | 功能名称                         |
|---------|----------------------------------|
| F101    | 健康档案记录创建                 |
| F102    | 健康档案分页查询与条件筛选       |
| F103    | 按老人维度查询全部健康档案时间轴 |
| F104    | 健康档案详情查看                 |
| F105    | 健康档案编辑与状态更新           |
| F106    | 健康档案删除                     |

### 功能详细规格

#### F101: 健康档案记录创建
**功能描述**:  
支持为指定老人创建一条健康档案记录。记录类型包括：病史（MEDICAL_HISTORY）、检查报告（CHECK_REPORT）、用药记录（MEDICATION）以及过敏史（ALLERGY）。  
不同类型通过 `record_type` 区分，并在 `content_structured` 字段中存储各自结构化内容。

**关键逻辑思路**:
- 前端在创建时选择记录类型（病史、检查报告、用药记录、过敏史）。
- 前端根据类型展示对应的表单结构，并在本地组装 `content_structured` JSON。
- 后端对基础字段（`elder_id`、`record_type`、`record_title`、`record_date`）做统一校验。
- 后端基于 `record_type`，对 `content_structured` 使用对应的 Joi schema 校验字段完整性与格式。
- 校验通过后，将 `content_structured` 序列化为 JSON 字符串写入 `health_record` 表。

**涉及的业务规则**:
- 同一老人可存在多条相同类型的记录（例如多次体检报告、多次用药记录、多条过敏史记录）。
- 记录日期 `record_date` 一般取事件发生或记录时间，用于时间轴排序。
- 过敏史类型（ALLERGY）必须包含过敏源、反应症状及首次发生日期。

#### F102: 健康档案分页查询与条件筛选
**功能描述**:  
支持按分页方式查询健康档案列表，并可按老人ID、记录类型、时间范围进行组合筛选，方便医护和管理端进行档案检索。

**关键逻辑思路**:
- 接收 `page`、`pageSize`、`elder_id`、`record_type`、`start_date`、`end_date` 等查询参数。
- 动态构造 SQL where 条件：
  - `elder_id`：按老人过滤
  - `record_type`：按记录类型过滤（如只看过敏史 ALLERGY）
  - `record_date`：按日期范围过滤
- 查询结果按 `created_at DESC` 或 `record_date DESC` 排序。
- 将 `content_structured` 从 JSON 字符串反序列化为对象并返回给前端。

**涉及的业务规则**:
- 默认按创建时间倒序，以便快速查看最新记录。
- 若未指定过滤条件，只要分页参数有效即可返回全量记录分页结果。

#### F103: 按老人维度查询全部健康档案时间轴
**功能描述**:  
支持根据老人ID一次性拉取该老人所有健康档案记录，用于在前端构建「时间轴视图」。可用于老人详情页或家属端查看老人长期健康档案。

**关键逻辑思路**:
- 根据 `elder_id` 直接查询 `health_record` 表所有记录。
- 按 `record_date DESC, created_at DESC` 排序，形成时间轴。
- 将所有记录的 `content_structured` 反序列化后返回。

**涉及的业务规则**:
- 当前接口不做分页，适合在单个老人的详情页中使用。
- 可在前端按 `record_type` 分类展示不同卡片样式。

#### F104: 健康档案详情查看
**功能描述**:  
根据记录ID返回单条健康档案的详细内容，包括基础元数据和结构化内容。

**关键逻辑思路**:
- 使用主键ID查询 `health_record` 表。
- 若不存在则返回 404 业务错误。
- 将 `content_structured` 反序列化后返回。

**涉及的业务规则**:
- 仅有权限的用户可查看对应老人的档案（权限控制由通用鉴权模块负责）。

#### F105: 健康档案编辑与状态更新
**功能描述**:  
支持对既有健康档案进行更新，如修改病史状态（如从 ONGOING 改为 CURED）、更新用药方案、补充过敏史说明等。

**关键逻辑思路**:
- 前端在编辑时，先通过详情接口加载当前记录内容。
- 用户在前端修改 `record_title`、`record_date` 或 `content_structured` 中的具体字段后提交。
- 后端对提交的数据执行与创建时一致的 Joi 校验（根据 record_type 使用对应 schema）。
- 仅更新请求体中提供的字段；未提供的字段保持不变。

**涉及的业务规则**:
- 部分类型字段有状态机约束，例如：
  - 病史（MEDICAL_HISTORY）的 `status` 仅支持 `ONGOING`、`REMISSION`、`CURED`。
- 更新操作应配合版本追踪模块记录变更历史（由 03 文档描述）。

#### F106: 健康档案删除
**功能描述**:  
支持在必要时删除指定的健康档案记录。

**关键逻辑思路**:
- 根据ID先查询记录是否存在。
- 若不存在返回 404 业务错误。
- 执行物理删除或后续可扩展为逻辑删除。

**涉及的业务规则**:
- 删除操作建议仅向管理员或医护角色开放。
- 若已启用版本追踪，应记录删除操作的审计信息。

## 前端交互设计（规划中）

> 当前前端（鸿蒙 ArkTS）尚未实现健康档案管理模块，本节先给出设计规划，用于指导后续开发。

### 交互流程（老人 / 家属端）

1. **查看老人健康档案时间轴**
   - 入口：`pages/family/ElderDetail` 页面下的「健康档案」标签页。
   - 页面加载时调用：`GET /api/v1/elder-health/health-record/elder/{elder_id}`。
   - 前端按 `record_date` 分组展示时间轴，将不同 `record_type` 渲染为不同样式卡片：
     - 病史：显示疾病名称、确诊日期、当前状态（进行中/缓解/痊愈）。
     - 检查报告：显示检查项目、医院、结论概述（正常/轻度异常/明显异常）。
     - 用药记录：显示药品列表、剂量、频次、用药区间。
     - 过敏史：显示过敏源、主要反应症状、首次发生时间、最近发生时间。

2. **查看单条健康档案详情**
   - 在时间轴中点击某条记录，跳转到详情页面 `pages/family/HealthRecordDetail`（规划中）。
   - 页面加载时调用：`GET /api/v1/elder-health/health-record/{id}`。
   - 根据 `record_type` 渲染对应详情布局，并展示 `content_structured` 中所有关键字段，同时展示 `notes` 与附件列表。

3. **前端数据模型建议（简化版）**

```ts
// ArkTS / TypeScript 前端侧建议模型
type HealthRecordType = 'MEDICAL_HISTORY' | 'CHECK_REPORT' | 'MEDICATION' | 'ALLERGY';

interface HealthRecordItem {
  id: number;
  elder_id: number;
  record_type: HealthRecordType;
  record_title: string;
  record_date: string; // YYYY-MM-DD
  content_structured: any; // 实际使用时按类型做类型守卫
  created_at: string;
  updated_at: string;
}
```

前端在收到 `content_structured` 时，可通过 `record_type` 做类型守卫，将 `any` 映射到具体类型（病史 / 检查报告 / 用药 / 过敏史）。

### 交互流程（医护端）

1. **健康记录管理页**
   - 页面标识：`pages/medical/HealthRecordManage`（参考现有 role-page-api-matrix）。
   - 主要能力：
     - 通过搜索框选择老人（`elder_id`）。
     - 条件筛选：记录类型（含 ALLERGY）、日期范围。
     - 列表展示：表格 + 简要信息列（类型、标题、日期、关键字段概览）。
   - 调用接口：
     - `GET /api/v1/elder-health/health-record/list?elder_id=&record_type=&page=&pageSize=&start_date=&end_date=`

2. **创建/编辑健康档案**
   - 在 `HealthRecordManage` 页中提供「新增记录」按钮。
   - 弹出或跳转到统一编辑页面 `pages/medical/HealthRecordEdit`：
     - 步骤1：选择记录类型（病史/检查/用药/过敏）。
     - 步骤2：根据类型展示对应表单：
       - 病史：疾病名称、确诊日期、状态、备注、附件。
       - 检查报告：检查日期、医院、检查项目、结论、备注、附件。
       - 用药记录：药品名称数组、剂量、频次、给药途径、用药日期区间、开药医生、医院、备注、附件。
       - 过敏史（ALLERGY）：见下节。
     - 步骤3：调用接口：
       - 新建：`POST /api/v1/elder-health/health-record`
       - 编辑：`PUT /api/v1/elder-health/health-record/{id}`

### 过敏史类型前端表单设计（ALLERGY）

> 该部分对应本次后端新增的 ALLERGY 类型字段设计。

**字段列表**（与后端结构严格对齐）：
- `allergy_item`：字符串，必填。示例：「青霉素」。
- `reaction_symptoms`：字符串数组，必填，至少一项。示例：`["全身皮疹", "呼吸困难"]`。
- `first_occurrence_date`：日期字符串，必填，格式 `YYYY-MM-DD`。
- `last_occurrence_date`：日期字符串，可选，格式 `YYYY-MM-DD`。
- `notes`：字符串，可选，用于补充描述。
- `attachments`：附件数组，可选，每项包含：
  - `type`: `"IMAGE"` 或 `"FILE"`
  - `url`: 文件访问地址
  - `name`: 可选显示名称

**表单交互建议**：
- 使用标签或多选组件录入 `reaction_symptoms`，支持自由输入常见症状（如皮疹、瘙痒、呼吸困难等）。
- 对 `first_occurrence_date`、`last_occurrence_date` 使用日期选择器组件。
- 在保存前做基础前端校验（必填项、日期格式）。
- 提交时将上述字段组装到 `content_structured` 中，示例：

```json
{
  "allergy_item": "青霉素",
  "reaction_symptoms": ["全身皮疹", "呼吸困难"],
  "first_occurrence_date": "2018-06-01",
  "last_occurrence_date": "2023-09-10",
  "notes": "需避免使用含青霉素药物",
  "attachments": [
    {
      "type": "IMAGE",
      "url": "https://example.com/allergy-test-report.png",
      "name": "过敏测试报告"
    }
  ]
}
```

## 数据模型

### 数据库设计（与当前实现对齐）

当前数据库已存在 `health_record` 表，统一存储所有健康档案记录。  
本模块在后端实现时已复用该表结构，通过扩展 `record_type` 与 `content_structured` 支持 ALLERGY 类型。

> 具体字段以实际数据库为准，以下为简化示例：

##### health_record
| 字段名            | 数据类型  | 约束                    | 说明                         |
|-------------------|-----------|-------------------------|------------------------------|
| id                | BIGINT    | PK, AUTO_INCREMENT      | 主键ID                       |
| elder_id          | BIGINT    | NOT NULL                | 老人ID                       |
| record_type       | VARCHAR   | NOT NULL                | 记录类型（MEDICAL_HISTORY / CHECK_REPORT / MEDICATION / ALLERGY） |
| record_title      | VARCHAR   | NOT NULL                | 记录标题                     |
| record_date       | DATE      | NOT NULL                | 记录日期                     |
| content_structured| JSON      | NOT NULL                | 结构化记录内容               |
| created_at        | DATETIME  | NOT NULL                | 创建时间                     |
| updated_at        | DATETIME  | NOT NULL                | 更新时间                     |

## 接口设计

### API 概览

#### 主要API列表

| 接口路径                                           | 方法  | 处理问题                                     | 权限要求            |
|----------------------------------------------------|-------|----------------------------------------------|---------------------|
| POST /api/v1/elder-health/health-record           | POST  | 为指定老人创建一条健康档案记录               | 医护/管理员         |
| GET /api/v1/elder-health/health-record/list       | GET   | 按条件分页查询健康档案列表                   | 医护/管理员         |
| GET /api/v1/elder-health/health-record/elder/{id} | GET   | 查询指定老人的全部健康档案时间轴             | 医护/家属（按权限） |
| GET /api/v1/elder-health/health-record/{id}       | GET   | 获取单条健康档案详情                         | 医护/家属/本人      |
| PUT /api/v1/elder-health/health-record/{id}       | PUT   | 更新单条健康档案（含 ALLERGY）              | 医护/管理员         |
| DELETE /api/v1/elder-health/health-record/{id}    | DELETE| 删除单条健康档案                             | 管理员/高级医护     |

### API 关键逻辑（与本次后端实现对齐）

> 所有接口均使用统一响应格式：`{ code, message, data }`，具体字段详见项目通用规范与 Swagger 文档。

##### POST /api/v1/elder-health/health-record
**接口功能简述**:  
为指定老人创建健康档案记录，支持四种类型：病史、检查报告、用药记录、过敏史。

**关键处理逻辑**:
1. 校验请求体基础字段：`elder_id`、`record_type`、`record_title`、`record_date`。
2. 根据 `record_type` 选择对应的 Joi schema，对 `content_structured` 执行严格校验：
   - MEDICAL_HISTORY：疾病名称、确诊日期、状态等。
   - CHECK_REPORT：检查日期、医院、项目、结论等。
   - MEDICATION：药品名称数组、剂量、频次、给药途径、用药日期区间等。
   - ALLERGY：过敏源、反应症状数组、首次发生日期、最近发生日期（可选）、备注、附件。
3. 将 `content_structured` 序列化为 JSON 字符串写入数据库。
4. 返回创建成功的完整记录（包含反序列化后的 `content_structured`）。

**注意事项**:
- 若 `record_type` 为 `ALLERGY` 且缺少必填字段，则直接返回校验错误。
- `record_date` 可与 `first_occurrence_date` 相同或不同，由业务自行约定。

**权限控制（若需要）**:  
默认只允许医护人员或管理员角色创建健康档案记录。

##### GET /api/v1/elder-health/health-record/list
**接口功能简述**:  
按条件分页查询健康档案列表，可按老人、类型、时间范围筛选。

**关键处理逻辑**:
1. 解析分页参数 `page`、`pageSize`。
2. 解析筛选参数：`elder_id`、`record_type`（含 ALLERGY）、`start_date`、`end_date`。
3. 构建 where 条件并调用仓储层分页查询。
4. 对每条记录的 `content_structured` 做 JSON 反序列化。
5. 返回分页结构：`{ total, pages, current, size, records }`。

**注意事项**:
- 默认按 `created_at` 倒序。
- 当前实现未做复杂排序规则，后续可按类型/日期组合排序。

**权限控制（若需要）**:  
医护和管理员可访问更多老人数据；老人/家属端应限制为仅能访问与自身相关的记录。

##### GET /api/v1/elder-health/health-record/elder/{elder_id}
**接口功能简述**:  
获取指定老人所有健康档案记录，用于构建时间轴视图。

**关键处理逻辑**:
1. 解析并校验路径参数 `elder_id`。
2. 按老人ID查询 `health_record` 表所有记录，按 `record_date DESC, created_at DESC` 排序。
3. 反序列化每条记录的 `content_structured` 字段。
4. 返回记录数组。

**注意事项**:
- 当前接口不分页，如后续数据量过大，可引入分页或按时间区间拉取。

**权限控制（若需要）**:  
老人/家属端仅能访问与自身绑定的老人ID；医护端可访问服务范围内的老人。

##### GET /api/v1/elder-health/health-record/{id}
**接口功能简述**:  
根据ID获取单条健康档案详情。

**关键处理逻辑**:
1. 校验ID有效性。
2. 查询记录，若不存在返回 404。
3. 反序列化 `content_structured` 并返回。

**注意事项**:
- 若记录被删除或不在权限范围内，应返回相应业务错误。

**权限控制（若需要）**:  
同上，由通用权限模块控制。

##### PUT /api/v1/elder-health/health-record/{id}
**接口功能简述**:  
更新单条健康档案记录，包括过敏史类型 ALLERGY。

**关键处理逻辑**:
1. 根据ID查询原始记录，若不存在返回 404。
2. 接收可选字段：`record_type`、`record_title`、`record_date`、`content_structured`。
3. 若 `record_type` 或 `content_structured` 有更新，则按最新 `record_type` 对 `content_structured` 重新做 Joi 校验。
4. 执行更新操作，仅更新提供的字段。
5. 查询更新后的记录并返回。

**注意事项**:
- 病史类型可通过此接口将 `status` 改为 `CURED` 等。
- 过敏史类型可更新 `last_occurrence_date` 或补充 `notes`。

**权限控制（若需要）**:  
仅医护/管理员可执行更新操作。

##### DELETE /api/v1/elder-health/health-record/{id}
**接口功能简述**:  
删除指定健康档案记录。

**关键处理逻辑**:
1. 查询记录是否存在。
2. 若存在则执行删除操作。
3. 返回删除结果标志。

**注意事项**:
- 建议在版本追踪模块中记录删除行为。

**权限控制（若需要）**:  
仅管理员或具备相应权限的医护人员可删除记录。

---

以上内容已经将本次对健康档案（特别是新增过敏史 ALLERGY 类型）的后端 API 实现情况，以及尚未开发但已规划的前端交互与数据模型设计，统一归档到本需求文档中，可作为后续前后端联调与迭代的依据。

