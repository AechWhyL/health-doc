# 个性化健康规则对接指引（json-logic-js）

## 一、功能概览

- 通过后端接口，医护人员可以为“单个老人”或“所有老人”配置可持久化的个性化健康规则。
- 规则使用 `json-logic-js` 表达业务条件，如“最近7天平均收缩压 > 140”。
- 评估时，个性化规则会与系统内置规则一起执行并返回。

## 二、相关接口列表

后端路由前缀：`/api/v1/elder-health/personal-rules`

1. 查询规则列表
   - 方法：`GET`
   - 路径：`/api/v1/elder-health/personal-rules`
   - 查询参数：
     - `page`：页码（默认 1）
     - `pageSize`：每页数量（默认 10）
     - `elder_id`：可选，按老人 ID 过滤规则

2. 创建规则
   - 方法：`POST`
   - 路径：`/api/v1/elder-health/personal-rules`
   - 请求体示例：
     ```json
     {
       "elder_id": 1,
       "name": "个性化-严格血压控制",
       "level": "SEVERE",
       "logic": {
         ">": [
           { "var": "indicators.avgSbp" },
           140
         ]
       },
       "message_template": "最近{{windowDays}}天收缩压平均值约为{{avgSbp}} mmHg，已超过140",
       "is_active": true
     }
     ```

3. 更新规则
   - 方法：`PUT`
   - 路径：`/api/v1/elder-health/personal-rules/{id}`
   - 请求体：与创建类似，字段全部可选，用于局部更新。

4. 删除规则
   - 方法：`DELETE`
   - 路径：`/api/v1/elder-health/personal-rules/{id}`

## 三、规则执行时可用的变量

在 json-logic 规则中，可以通过 `var` 访问以下字段：

- `elder`：老人基本信息对象（来自 `elder_basic_info`）
  - 示例：`{ "var": "elder.name" }`
- `windowDays`：评估时间窗口天数（接口参数，默认 30）
- `measurementsCount`：窗口内健康数据记录条数
- `indicators`：预聚合健康指标（最近一段时间）
  - `indicators.avgSbp`：平均收缩压
  - `indicators.avgDbp`：平均舒张压
  - `indicators.avgFpg`：平均空腹血糖
  - `indicators.avgPpg2h`：平均餐后2小时血糖
  - `indicators.avgSteps`：平均步数
  - `indicators.latestWeight`：最近一次体重
  - `indicators.earliestWeight`：窗口内最早一条体重
  - `indicators.weightDiff`：体重变化（最近一次减去最早一次）

## 四、典型规则示例

1. 最近7天平均收缩压偏高

```json
{
  ">": [
    { "var": "indicators.avgSbp" },
    140
  ]
}
```

2. 血压偏高且活动不足

```json
{
  "and": [
    {
      ">": [
        { "var": "indicators.avgSbp" },
        140
      ]
    },
    {
      "<": [
        { "var": "indicators.avgSteps" },
        4000
      ]
    }
  ]
}
```

## 五、提示模板占位符

`message_template` 支持简单的占位符替换，格式为 `{{变量名}}`：

- 可用占位符示例：
  - `{{elderName}}`
  - `{{windowDays}}`
  - `{{avgSbp}}`
  - `{{avgDbp}}`
  - `{{avgFpg}}`
  - `{{avgPpg2h}}`
  - `{{avgSteps}}`
  - `{{latestWeight}}`
  - `{{earliestWeight}}`
  - `{{weightDiff}}`

示例：

```text
最近{{windowDays}}天收缩压平均值约为{{avgSbp}} mmHg，已超过140
```

## 六、评估接口与返回结果

- 评估入口：`GET /api/v1/elder-health/rules/evaluate?elder_id={id}&windowDays={n}`
- 返回的 `data` 数组中，系统规则与个性化规则统一为 `HealthRuleResult`：
  - 系统规则：`id` 为类似 `BP_AVG_7_DAYS` 等固定值
  - 个性化规则：`id` 形如 `P_{数据库ID}`，例如 `P_1`

前端可根据 `id` 前缀或名称判断是否为个性化规则，并在界面上做区分展示或标记来源。

